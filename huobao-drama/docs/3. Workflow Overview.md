# 3. Workflow Overview

## Huobao Drama - User Workflows and Processes

This document describes the complete user workflows for creating AI-generated short dramas.

---

## Core Workflow: Drama Creation Pipeline

```mermaid
flowchart TB
    Start(["User Starts"]) --> Create["1. Create Drama Project"]
    Create --> Outline["2. Define Outline"]
    Outline --> AI_Script["3. AI Script Generation"]
    AI_Script --> Characters["4. Character Design"]
    Characters --> Storyboard["5. Storyboard Creation"]
    Storyboard --> Scenes["6. Scene/Background Design"]
    Scenes --> Images["7. Image Generation"]
    Images --> Videos["8. Video Generation"]
    Videos --> Merge["9. Video Merging"]
    Merge --> Publish["10. Export/Publish"]
    Publish --> End(["Complete"])
    
    style Start fill:#e1f5fe
    style End fill:#e8f5e9
    style AI_Script fill:#fff3e0
    style Images fill:#fff3e0
    style Videos fill:#fff3e0
```

---

## Workflow 1: Drama Project Creation

### Overview
The entry point for creating a new drama project with basic metadata.

```mermaid
sequenceDiagram
    actor U as User
    participant UI as Web UI (Vue)
    participant API as API Server (Go)
    participant DB as SQLite Database
    
    U->>UI: Click "Create Drama"
    U->>UI: Enter title, description, genre
    UI->>API: POST /api/v1/dramas
    API->>API: Validate request
    API->>DB: INSERT INTO dramas
    DB-->>API: Return drama ID
    API-->>UI: 201 Created {drama}
    UI-->>U: Redirect to drama workspace
```

### API Endpoints
| Method | Endpoint | Description |
|--------|----------|-------------|
| POST | `/api/v1/dramas` | Create new drama project |
| GET | `/api/v1/dramas` | List all dramas |
| GET | `/api/v1/dramas/:id` | Get drama details |
| PUT | `/api/v1/dramas/:id` | Update drama |
| DELETE | `/api/v1/dramas/:id` | Delete drama |

---

## Workflow 2: AI Script Generation

### Overview
Generate screenplay content from outline using AI (OpenAI GPT).

```mermaid
sequenceDiagram
    actor U as User
    participant UI as Web UI
    participant API as API Server
    participant SS as Script Service
    participant AI as OpenAI API
    participant DB as Database
    
    U->>UI: Enter story outline
    U->>UI: Select genre, style
    UI->>API: POST /api/v1/generation/script
    API->>SS: GenerateScript(req)
    SS->>SS: Build prompt template
    SS->>AI: POST /v1/chat/completions
    AI-->>SS: Generated screenplay
    SS->>SS: Parse JSON response
    SS->>DB: Save episodes & storyboards
    SS-->>API: Script data
    API-->>UI: 200 OK {script}
    UI-->>U: Display generated script
```

### Process Details
1. **Input**: Story outline, genre, target duration
2. **AI Prompt**: Structured prompt with style guidelines
3. **Output**: Structured screenplay with:
   - Episode breakdown
   - Scene descriptions
   - Character dialogues
   - Location/time information
4. **Storage**: Episodes and storyboards saved to database

---

## Workflow 3: Character Design & Management

### Overview
Create and manage characters with AI-generated reference images.

```mermaid
sequenceDiagram
    actor U as User
    participant UI as Web UI
    participant API as API Server
    participant CS as Character Service
    participant IS as Image Service
    participant AI as OpenAI/DALL-E
    participant DB as Database
    participant S as Storage
    
    alt AI Generate Character
        U->>UI: Input character description
        UI->>API: POST /api/v1/characters/:id/generate-image
        API->>CS: GenerateCharacterImage()
        CS->>CS: Build character prompt
        CS->>IS: GenerateImage(prompt)
        IS->>AI: POST /v1/images/generations
        AI-->>IS: Image URL
        IS->>S: Download & store image
        IS->>DB: Save ImageGeneration record
        IS-->>CS: Image path
        CS->>DB: Update character.image_url
        CS-->>API: Character updated
        API-->>UI: 200 OK {character}
        UI-->>U: Display character image
    end
    
    alt Upload Character Image
        U->>UI: Upload reference image
        UI->>API: POST /api/v1/characters/:id/upload-image
        API->>S: Store uploaded file
        API->>DB: Update character image
        API-->>UI: 200 OK
    end
    
    alt Add to Library
        U->>UI: Click "Add to Library"
        UI->>API: POST /api/v1/characters/:id/add-to-library
        API->>DB: INSERT INTO character_library
        API-->>UI: 201 Created
    end
```

### Character Library Features
- **AI Generation**: Generate character images from descriptions
- **Upload**: Import custom reference images
- **Library**: Reuse characters across dramas
- **Batch Generation**: Generate images for multiple characters

---

## Workflow 4: Storyboard Creation

### Overview
Convert screenplay into visual storyboard with shot breakdown.

```mermaid
sequenceDiagram
    actor U as User
    participant UI as Web UI
    participant API as API Server
    participant SB as Storyboard Service
    participant AI as OpenAI API
    participant DB as Database
    
    U->>UI: Select episode
    U->>UI: Click "Generate Storyboard"
    UI->>API: POST /api/v1/episodes/:id/storyboards
    API->>SB: GenerateStoryboard(episodeID)
    SB->>DB: Fetch episode & script
    SB->>SB: Parse script content
    loop Each scene in script
        SB->>SB: Extract shot details
        SB->>AI: Generate shot description (optional)
        SB->>DB: INSERT storyboard
    end
    SB-->>API: Storyboards created
    API-->>UI: 201 Created {storyboards}
    UI-->>U: Display storyboard grid
```

### Storyboard Structure
- **Shot Number**: Sequential identifier
- **Location**: Scene setting
- **Time**: Day/night/season
- **Shot Type**: Wide, medium, close-up, etc.
- **Action**: Character movements
- **Dialogue**: Character speech
- **Atmosphere**: Mood and tone
- **Image Prompt**: AI generation prompt

---

## Workflow 5: Scene/Background Design

### Overview
Design background scenes for storyboard shots.

```mermaid
sequenceDiagram
    actor U as User
    participant UI as Web UI
    participant API as API Server
    participant SS as Scene Service
    participant IS as Image Service
    participant AI as OpenAI/DALL-E
    participant DB as Database
    participant S as Storage
    
    U->>UI: Enter scene location & time
    U->>UI: Click "Generate Scene"
    UI->>API: POST /api/v1/scenes/:id/generate-image
    API->>SS: GenerateSceneImage()
    SS->>SS: Build scene prompt
    SS->>IS: GenerateImage(scenePrompt)
    IS->>AI: POST /v1/images/generations
    AI-->>IS: Generated image URL
    IS->>S: Download & store image
    IS->>DB: Create ImageGeneration record
    IS-->>SS: Image path
    SS->>DB: Update scene.image_url
    SS-->>API: Scene updated
    API-->>UI: 200 OK {scene}
    UI-->>U: Display scene image
```

### Scene Management
- **Location-based**: Organize by story locations
- **Time-based**: Day/night variations
- **Episode association**: Link to specific episodes
- **Reusability**: Use across multiple shots

---

## Workflow 6: Image Generation Pipeline

### Overview
Generate anime-style images for characters and scenes.

```mermaid
flowchart TB
    Start(["Generation Request"]) --> Queue["Add to Task Queue"]
    Queue --> Process["Background Processing"]
    Process --> Build["Build Prompt"]
    Build --> AI["Call AI API"]
    AI --> Download["Download Image"]
    Download --> Store["Store Locally"]
    Store --> Update["Update Status"]
    Update --> Complete(["Complete"])
    
    AI -->|Error| Retry["Retry Logic"]
    Retry -->|Max Retries| Fail(["Failed"])
    Retry -->|Retry| AI
```

### Async Task Processing
```mermaid
sequenceDiagram
    participant Client as Client
    participant API as API Server
    participant TS as Task Service
    participant Queue as Task Queue
    participant Worker as Background Worker
    participant AI as AI Service
    participant DB as Database
    
    Client->>API: POST /api/v1/images (async)
    API->>TS: CreateAsyncTask()
    TS->>DB: INSERT async_tasks (pending)
    TS-->>API: Task ID
    API-->>Client: 202 Accepted {task_id}
    
    par Background Processing
        Worker->>Queue: Poll tasks
        Queue->>Worker: Get pending task
        Worker->>DB: UPDATE status=processing
        Worker->>AI: Generate image
        AI-->>Worker: Image data
        Worker->>DB: UPDATE status=completed + result
    end
    
    Client->>API: GET /api/v1/tasks/:id
    API->>DB: Fetch task status
    DB-->>API: Task status
    API-->>Client: 200 OK {task}
```

---

## Workflow 7: Video Generation

### Overview
Generate videos from images using AI video generation services.

```mermaid
sequenceDiagram
    actor U as User
    participant UI as Web UI
    participant API as API Server
    participant VS as Video Service
    participant AI as Doubao API
    participant DB as Database
    participant S as Storage
    
    U->>UI: Select generated image
    U->>UI: Configure video params
    UI->>API: POST /api/v1/videos
    API->>VS: GenerateVideo(req)
    VS->>DB: Create VideoGeneration record
    VS->>AI: POST /video/generation
    AI-->>VS: Video generation started
    VS->>DB: UPDATE status=processing
    
    Note over AI: Async processing
    
    AI->>VS: Webhook: Video ready
    VS->>S: Download video file
    VS->>DB: UPDATE status=completed + video_url
    
    U->>UI: Poll task status
    UI->>API: GET /api/v1/videos/:id
    API->>DB: Fetch video status
    DB-->>API: Video ready
    API-->>UI: 200 OK {video}
    UI-->>U: Play video
```

### Video Generation Features
- **Image-to-Video**: Convert static images to animated video
- **Motion Control**: Define movement types
- **Duration Control**: Set video length
- **Batch Processing**: Generate multiple videos

---

## Workflow 8: Video Merging & Post-Processing

### Overview
Combine individual video clips into final episode using FFmpeg.

```mermaid
sequenceDiagram
    actor U as User
    participant UI as Web UI
    participant API as API Server
    participant MS as Merge Service
    participant FF as FFmpeg
    participant DB as Database
    participant S as Storage
    
    U->>UI: Select videos for episode
    U->>UI: Configure transitions
    UI->>API: POST /api/v1/video-merges
    API->>MS: MergeVideos(req)
    MS->>DB: Create VideoMerge record
    MS->>MS: Prepare file list
    MS->>FF: Execute concat command
    FF->>S: Write merged video
    FF-->>MS: Processing complete
    MS->>DB: UPDATE status=completed
    MS-->>API: Merge complete
    API-->>UI: 200 OK {merged_video}
    UI-->>U: Download/Preview final video
```

### FFmpeg Integration
```mermaid
flowchart LR
    Input1["Video 1"] --> Concat["FFmpeg Concat"]
    Input2["Video 2"] --> Concat
    Input3["Video 3"] --> Concat
    Concat --> Process["Post-Processing"]
    Process --> Output["Final Episode"]
    
    Process --> Audio["Audio Mixing"]
    Process --> Filter["Video Filters"]
    Process --> Format["Format Conversion"]
```

---

## Workflow 9: Asset Management

### Overview
Centralized resource library for managing generated content.

```mermaid
flowchart TB
    subgraph Assets["Asset Library"]
        Characters["Characters"]
        Scenes["Scenes"]
        Props["Props"]
        Images["Images"]
        Videos["Videos"]
        Audio["Audio"]
    end
    
    subgraph Operations["Operations"]
        Create["Create"]
        Import["Import"]
        Export["Export"]
        Organize["Organize"]
        Tag["Tag"]
    end
    
    Operations --> Assets
```

### Asset Types
- **Characters**: Character designs with reference images
- **Scenes**: Background images and locations
- **Props**: Object designs for storyboards
- **Images**: Generated character/scene images
- **Videos**: Generated video clips
- **Audio**: Extracted audio, sound effects, BGM

---

## Workflow 10: System Administration

### Overview
Manage AI service configurations and system settings.

```mermaid
sequenceDiagram
    actor A as Admin
    participant UI as Admin UI
    participant API as API Server
    participant DB as Database
    
    A->>UI: Navigate to Settings
    
    alt AI Configuration
        A->>UI: Add AI Provider
        UI->>API: POST /api/v1/ai-configs
        API->>DB: INSERT ai_service_configs
        API-->>UI: 201 Created
    end
    
    alt Test Connection
        A->>UI: Click "Test"
        UI->>API: POST /api/v1/ai-configs/test
        API->>API: Verify API key
        API-->>UI: 200 OK {status: ok}
    end
    
    alt System Settings
        A->>UI: Update style defaults
        UI->>API: PUT /api/v1/settings
        API->>DB: Update configuration
        API-->>UI: 200 OK
    end
```

### Configuration Management
- **AI Providers**: OpenAI, Doubao, custom providers
- **Style Templates**: Default visual style settings
- **System Language**: i18n support (Chinese/English)
- **Storage Settings**: Local path configuration

---

## Data Flow Diagram

```mermaid
flowchart TB
    subgraph Input["User Input"]
        Outline["Story Outline"]
        Style["Style Preferences"]
        Config["AI Configuration"]
    end
    
    subgraph Processing["AI Processing"]
        Script["Script Generation"]
        Characters["Character Generation"]
        Scenes["Scene Generation"]
        Storyboards["Storyboard Creation"]
        Images["Image Generation"]
        Videos["Video Generation"]
    end
    
    subgraph Output["Output Assets"]
        Scripts["Screenplays"]
        CharacterImages["Character Images"]
        SceneImages["Scene Images"]
        VideoClips["Video Clips"]
        FinalVideo["Final Episode"]
    end
    
    Outline --> Script
    Script --> Characters
    Script --> Storyboards
    Script --> Scenes
    Characters --> Images
    Scenes --> Images
    Storyboards --> Images
    Images --> Videos
    Videos --> FinalVideo
    Style --> Processing
    Config --> Processing
```

---

## Error Handling Workflows

### Async Task Failure Recovery
```mermaid
sequenceDiagram
    participant Worker as Background Worker
    participant Task as Task Service
    participant DB as Database
    
    Worker->>Task: Execute task
    Task->>Task: Operation fails
    Task->>DB: UPDATE status=failed + error_msg
    Task->>Task: Check retry count
    alt Can Retry
        Task->>Task: Increment retry
        Task->>DB: UPDATE retry_count
        Task->>Worker: Retry task
    else Max Retries
        Task->>DB: UPDATE status=failed_permanently
        Task->>Task: Notify user (future)
    end
```

---

## Workflow Metrics

| Workflow | Average Duration | Async | AI Dependent |
|----------|------------------|-------|--------------|
| Drama Creation | < 1s | No | No |
| Script Generation | 10-30s | Yes | Yes |
| Character Generation | 15-45s | Yes | Yes |
| Storyboard Creation | 5-15s | No | Optional |
| Image Generation | 20-60s | Yes | Yes |
| Video Generation | 60-180s | Yes | Yes |
| Video Merging | 30-120s | Yes | No |

---

*For detailed API documentation, see [4. Deep Dive/api-layer.md](./4.Deep-Dive/api-layer.md)*

*For service implementation details, see [4. Deep Dive/application-layer.md](./4.Deep-Dive/application-layer.md)*
