# 11-部署指南

## 1. Docker部署（推荐）

### 1.1 Dockerfile详解

火宝短剧项目使用多阶段构建优化镜像大小：

```dockerfile
# ==================== 阶段1: 构建前端 ====================
ARG DOCKER_REGISTRY=
ARG NPM_REGISTRY=

FROM ${DOCKER_REGISTRY:-}node:20-alpine AS frontend-builder

ARG NPM_REGISTRY=
ENV NPM_REGISTRY=${NPM_REGISTRY:-}
RUN if [ -n "$NPM_REGISTRY" ]; then \
    npm config set registry "$NPM_REGISTRY" || true; \
    fi

WORKDIR /app/web
COPY web/package*.json ./
RUN npm install
COPY web/ ./
RUN npm run build

# ==================== 阶段2: 构建后端 ====================
ARG DOCKER_REGISTRY=
ARG GO_PROXY=
ARG ALPINE_MIRROR=

FROM ${DOCKER_REGISTRY:-}golang:1.23-alpine AS backend-builder

ARG GO_PROXY=
ARG ALPINE_MIRROR=
ENV ALPINE_MIRROR=${ALPINE_MIRROR:-}
RUN if [ -n "$ALPINE_MIRROR" ]; then \
    sed -i "s@dl-cdn.alpinelinux.org@$ALPINE_MIRROR@g" /etc/apk/repositories 2>/dev/null || true; \
    fi

ENV GOPROXY=${GO_PROXY:-https://goproxy.cn,direct}
ENV GO111MODULE=on

RUN apk add --no-cache git ca-certificates tzdata
WORKDIR /app
COPY go.mod go.sum ./
RUN go mod download
COPY . .
COPY --from=frontend-builder /app/web/dist ./web/dist
RUN CGO_ENABLED=0 go build -ldflags="-w -s" -o huobao-drama .
RUN CGO_ENABLED=0 go build -ldflags="-w -s" -o migrate cmd/migrate/main.go

# ==================== 阶段3: 运行时镜像 ====================
ARG DOCKER_REGISTRY=
ARG ALPINE_MIRROR=

FROM ${DOCKER_REGISTRY:-}alpine:latest

ARG ALPINE_MIRROR=
ENV ALPINE_MIRROR=${ALPINE_MIRROR:-}
RUN if [ -n "$ALPINE_MIRROR" ]; then \
    sed -i "s@dl-cdn.alpinelinux.org@$ALPINE_MIRROR@g" /etc/apk/repositories 2>/dev/null || true; \
    fi

RUN apk add --no-cache ca-certificates tzdata ffmpeg wget \
    && rm -rf /var/cache/apk/*

ENV TZ=Asia/Shanghai
WORKDIR /app

COPY --from=backend-builder /app/huobao-drama .
COPY --from=backend-builder /app/migrate .
COPY --from=frontend-builder /app/web/dist ./web/dist
COPY configs/config.example.yaml ./configs/
RUN cp ./configs/config.example.yaml ./configs/config.yaml
COPY migrations ./migrations/
RUN mkdir -p /app/data/storage

EXPOSE 5678

HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \
    CMD wget --no-verbose --tries=1 --spider http://localhost:5678/health || exit 1

CMD ["./huobao-drama"]
```

**多阶段构建优势**：
- 最终镜像仅包含运行时必需的文件
- 不包含构建工具和源代码
- 镜像大小从 ~1GB 减少到 ~150MB

### 1.2 镜像优化技巧

```dockerfile
# 1. 使用alpine基础镜像
FROM node:20-alpine  # 而不是 node:20（节省~800MB）
FROM golang:1.23-alpine

# 2. 清理缓存
RUN npm install && npm cache clean --force
RUN apk add --no-cache xxx && rm -rf /var/cache/apk/*

# 3. 使用.dockerignore
node_modules/
.git/
.gitignore
*.md
dist/
.env

# 4. 最小化层数：合并RUN命令
RUN apk add --no-cache ca-certificates tzdata ffmpeg \
    && rm -rf /var/cache/apk/*
```

### 1.3 docker-compose.yml配置

```yaml
version: '3.8'

services:
  huobao-drama:
    container_name: huobao-drama
    build:
      context: .
      dockerfile: Dockerfile
      args:
        DOCKER_REGISTRY: ${DOCKER_REGISTRY:-}
        NPM_REGISTRY: ${NPM_REGISTRY:-}
        GO_PROXY: ${GO_PROXY:-}
        ALPINE_MIRROR: ${ALPINE_MIRROR:-}
    image: huobao-drama:latest
    ports:
      - "5678:5678"
    volumes:
      - huobao-data:/app/data
      - huobao-logs:/app/logs
    environment:
      - TZ=Asia/Shanghai
      - DEBUG=false
      - LOG_LEVEL=info
    extra_hosts:
      - "host.docker.internal:host-gateway"
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:5678/health"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 10s
    networks:
      - huobao-network
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M

  ollama:
    image: ollama/ollama:latest
    container_name: huobao-ollama
    volumes:
      - ollama-models:/root/.ollama
    ports:
      - "11434:11434"
    networks:
      - huobao-network
    profiles:
      - local-ai

volumes:
  huobao-data:
  huobao-logs:
  ollama-models:

networks:
  huobao-network:
```

### 1.4 环境变量注入

```bash
# .env 文件
DOCKER_REGISTRY=registry.cn-hangzhou.aliyuncs.com/
NPM_REGISTRY=https://registry.npmmirror.com
GO_PROXY=https://goproxy.cn,direct
ALPINE_MIRROR=mirrors.aliyun.com

DEBUG=false
LOG_LEVEL=info
PORT=5678

STORAGE_TYPE=local
STORAGE_PATH=/app/data/storage
STORAGE_BASE_URL=http://localhost:5678/storage

OPENAI_API_KEY=
GEMINI_API_KEY=

DATABASE_PATH=/app/data/drama.db
```

### 1.5 健康检查配置

```go
// api/handlers/health.go
package handlers

import (
    "net/http"
    "time"
    "github.com/gin-gonic/gin"
    "gorm.io/gorm"
)

type HealthHandler struct {
    db *gorm.DB
}

func NewHealthHandler(db *gorm.DB) *HealthHandler {
    return &HealthHandler{db: db}
}

func (h *HealthHandler) Health(c *gin.Context) {
    c.JSON(http.StatusOK, gin.H{
        "status": "healthy",
        "time": time.Now().Unix(),
    })
}

func (h *HealthHandler) Ready(c *gin.Context) {
    sqlDB, err := h.db.DB()
    if err != nil {
        c.JSON(http.StatusServiceUnavailable, gin.H{
            "status": "not_ready",
            "error": "database connection failed",
        })
        return
    }
    
    if err := sqlDB.Ping(); err != nil {
        c.JSON(http.StatusServiceUnavailable, gin.H{
            "status": "not_ready",
            "error": "database ping failed",
        })
        return
    }
    
    c.JSON(http.StatusOK, gin.H{
        "status": "ready",
        "time": time.Now().Unix(),
    })
}
```

### 1.6 数据持久化

```yaml
services:
  huobao-drama:
    volumes:
      - huobao-data:/app/data
    labels:
      - "backup.stop-during-backup=true"
```

```bash
#!/bin/bash
# backup.sh
BACKUP_DIR="/backup/huobao/$(date +%Y%m%d)"
mkdir -p $BACKUP_DIR

docker-compose stop huobao-drama

docker run --rm \
  -v huobao-data:/data:ro \
  -v $BACKUP_DIR:/backup \
  alpine tar czf /backup/data.tar.gz -C /data .

docker-compose start huobao-drama

find /backup/huobao -type d -mtime +30 -exec rm -rf {} +
```

## 2. 生产环境配置

### 2.1 Nginx反向代理配置

```nginx
server {
    listen 80;
    server_name drama.example.com;
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name drama.example.com;
    
    ssl_certificate /etc/letsencrypt/live/drama.example.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/drama.example.com/privkey.pem;
    ssl_trusted_certificate /etc/letsencrypt/live/drama.example.com/chain.pem;
    
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers 'ECDHE-ECDSA-AES128-GCM-SHA256';
    ssl_prefer_server_ciphers off;
    ssl_session_cache shared:SSL:10m;
    
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    
    gzip on;
    gzip_types text/plain text/css application/json application/javascript;
    
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
        access_log off;
    }
    
    location /api/ {
        proxy_pass http://localhost:5678;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 300s;
    }
    
    location /storage/ {
        alias /app/data/storage/;
        expires 7d;
    }
    
    location / {
        proxy_pass http://localhost:5678;
    }
    
    access_log /var/log/nginx/huobao-access.log;
    error_log /var/log/nginx/huobao-error.log;
}
```

### 2.2 HTTPS/TLS配置

```bash
# 安装Certbot
sudo apt-get install certbot python3-certbot-nginx

# 获取证书
sudo certbot --nginx -d drama.example.com

# 测试自动续期
sudo certbot renew --dry-run
```

### 2.3 完整Nginx配置示例

```nginx
user nginx;
worker_processes auto;
error_log /var/log/nginx/error.log warn;

events {
    worker_connections 4096;
    use epoll;
    multi_accept on;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;
    
    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent';
    
    access_log /var/log/nginx/access.log main;
    
    sendfile on;
    tcp_nopush on;
    keepalive_timeout 65;
    
    limit_conn_zone $binary_remote_addr zone=conn_limit:10m;
    limit_conn conn_limit 50;
    
    include /etc/nginx/conf.d/*.conf;
}
```

## 3. 数据库生产配置

### 3.1 SQLite生产优化

```yaml
services:
  huobao-drama:
    environment:
      - SQLITE_BUSY_TIMEOUT=5000
      - SQLITE_JOURNAL_MODE=WAL
      - SQLITE_SYNCHRONOUS=NORMAL
      - SQLITE_CACHE_SIZE=-64000
```

```go
func initDB(cfg *config.DatabaseConfig) (*gorm.DB, error) {
    dsn := fmt.Sprintf("%s?_busy_timeout=5000&_journal_mode=WAL", cfg.Path)
    
    db, err := gorm.Open(sqlite.Open(dsn), &gorm.Config{})
    if err != nil {
        return nil, err
    }
    
    sqlDB, _ := db.DB()
    sqlDB.Exec("PRAGMA cache_size = -64000;")
    sqlDB.Exec("PRAGMA temp_store = memory;")
    
    return db, nil
}
```

### 3.2 SQLite→PostgreSQL迁移

```yaml
version: '3.8'

services:
  huobao-drama:
    environment:
      - DATABASE_TYPE=postgres
      - DATABASE_HOST=postgres
      - DATABASE_PORT=5432
      - DATABASE_USER=huobao
      - DATABASE_PASSWORD=secret
      - DATABASE_NAME=huobao_drama
      - DATABASE_SSL_MODE=disable
    depends_on:
      postgres:
        condition: service_healthy

  postgres:
    image: postgres:16-alpine
    container_name: huobao-postgres
    environment:
      POSTGRES_USER: huobao
      POSTGRES_PASSWORD: secret
      POSTGRES_DB: huobao_drama
    volumes:
      - postgres-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U huobao -d huobao_drama"]
      interval: 5s
      timeout: 5s
      retries: 5

volumes:
  postgres-data:
```

```go
type DatabaseConfig struct {
    Type     string
    Path     string
    Host     string
    Port     int
    User     string
    Password string
    DBName   string
    SSLMode  string
}

func NewDB(cfg *DatabaseConfig) (*gorm.DB, error) {
    var dialector gorm.Dialector
    
    switch cfg.Type {
    case "postgres":
        dsn := fmt.Sprintf("host=%s port=%d user=%s password=%s dbname=%s sslmode=%s",
            cfg.Host, cfg.Port, cfg.User, cfg.Password, cfg.DBName, cfg.SSLMode)
        dialector = postgres.Open(dsn)
    default:
        dialector = sqlite.Open(cfg.Path)
    }
    
    return gorm.Open(dialector, &gorm.Config{})
}
```

### 3.3 PostgreSQL连接池配置

```go
sqlDB, err := db.DB()
if err != nil {
    return err
}

sqlDB.SetMaxOpenConns(25)
sqlDB.SetMaxIdleConns(10)
sqlDB.SetConnMaxLifetime(1 * time.Hour)
sqlDB.SetConnMaxIdleTime(30 * time.Minute)
```

### 3.4 备份策略

```bash
#!/bin/bash
set -e

BACKUP_DIR="/backup/huobao"
DATE=$(date +%Y%m%d_%H%M%S)
RETENTION_DAYS=30

mkdir -p $BACKUP_DIR

cp /app/data/drama.db $BACKUP_DIR/drama_$DATE.db
gzip $BACKUP_DIR/drama_$DATE.db

find $BACKUP_DIR -name "*.gz" -mtime +$RETENTION_DAYS -delete

echo "Backup completed: drama_$DATE.db.gz"
```

```yaml
services:
  backup:
    image: offen/docker-volume-backup:latest
    volumes:
      - huobao-data:/backup/data:ro
      - /backup/huobao:/archive
    environment:
      BACKUP_CRON_EXPRESSION: "0 2 * * *"
      BACKUP_RETENTION_DAYS: "30"
```

## 4. CI/CD流程

### 4.1 GitHub Actions工作流

```yaml
name: Build and Deploy

on:
  push:
    branches: [main]
    tags: ['v*']

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: '1.23'
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      - run: go test -v ./...
      - run: |
          cd web
          npm install
          npm test

  build:
    needs: test
    runs-on: ubuntu-latest
    permissions:
      packages: write
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-buildx-action@v3
      - uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - uses: docker/metadata-action@v5
        id: meta
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
      - uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  deploy:
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
      - uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_KEY }}
          script: |
            cd /opt/huobao-drama
            docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:main
            docker-compose up -d
            sleep 10
            curl -f http://localhost:5678/health || exit 1
```

### 4.2 自动化测试集成

```yaml
name: Tests

on:
  push:
    branches: [develop, main]
  pull_request:
    branches: [develop, main]

jobs:
  backend-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: '1.23'
      - run: go test -v -race ./...

  frontend-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      - run: |
          cd web
          npm install
          npm run lint
          npm test
```

### 4.3 镜像仓库配置

```bash
# Docker Hub
docker login -u username
docker tag huobao-drama:latest username/huobao-drama:v1.0.0
docker push username/huobao-drama:v1.0.0

# GitHub Container Registry
echo $GITHUB_TOKEN | docker login ghcr.io -u USERNAME --password-stdin
docker tag huobao-drama:latest ghcr.io/username/huobao-drama:v1.0.0
docker push ghcr.io/username/huobao-drama:v1.0.0

# 阿里云
docker login --username=阿里云账号 registry.cn-hangzhou.aliyuncs.com
docker tag huobao-drama:latest registry.cn-hangzhou.aliyuncs.com/namespace/huobao-drama:v1.0.0
docker push registry.cn-hangzhou.aliyuncs.com/namespace/huobao-drama:v1.0.0
```

### 4.4 自动部署

```bash
#!/bin/bash
set -e

IMAGE_TAG=${1:-latest}
echo "Deploying Huobao Drama ${IMAGE_TAG}..."

docker pull ghcr.io/username/huobao-drama:${IMAGE_TAG}

# 备份
docker run --rm -v huobao-data:/data -v /backup:/backup alpine \
  tar czf /backup/huobao_$(date +%Y%m%d_%H%M%S).tar.gz -C /data .

docker-compose up -d

# 健康检查
sleep 10
attempts=0
until curl -sf http://localhost:5678/health || [ $attempts -eq 30 ]; do
  echo "Waiting... ($((++attempts))/30)"
  sleep 5
done

if [ $attempts -eq 30 ]; then
  echo "Health check failed"
  exit 1
fi

echo "Deployment successful!"
docker system prune -f
```

## 5. 监控与运维

### 5.1 应用监控配置

```go
// 添加Prometheus指标端点
package main

import (
    "github.com/gin-gonic/gin"
    "github.com/prometheus/client_golang/prometheus"
    "github.com/prometheus/client_golang/prometheus/promhttp"
)

var (
    httpRequestsTotal = prometheus.NewCounterVec(
        prometheus.CounterOpts{
            Name: "http_requests_total",
            Help: "Total number of HTTP requests",
        },
        []string{"method", "path", "status"},
    )
    
    httpRequestDuration = prometheus.NewHistogramVec(
        prometheus.HistogramOpts{
            Name: "http_request_duration_seconds",
            Help: "HTTP request duration",
        },
        []string{"method", "path"},
    )
)

func init() {
    prometheus.MustRegister(httpRequestsTotal, httpRequestDuration)
}

func PrometheusMiddleware() gin.HandlerFunc {
    return func(c *gin.Context) {
        start := time.Now()
        c.Next()
        
        duration := time.Since(start).Seconds()
        httpRequestsTotal.WithLabelValues(c.Request.Method, c.FullPath(), strconv.Itoa(c.Writer.Status())).Inc()
        httpRequestDuration.WithLabelValues(c.Request.Method, c.FullPath()).Observe(duration)
    }
}

// 路由中添加
router.GET("/metrics", gin.WrapH(promhttp.Handler()))
```

### 5.2 关键指标监控

```yaml
# docker-compose-monitoring.yml
version: '3.8'

services:
  prometheus:
    image: prom/prometheus:latest
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml
      - prometheus-data:/prometheus
    ports:
      - "9090:9090"
    
  grafana:
    image: grafana/grafana:latest
    volumes:
      - grafana-data:/var/lib/grafana
      - ./grafana/dashboards:/etc/grafana/provisioning/dashboards
    ports:
      - "3000:3000"
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=admin

volumes:
  prometheus-data:
  grafana-data:
```

```yaml
# prometheus.yml
global:
  scrape_interval: 15s

scrape_configs:
  - job_name: 'huobao-drama'
    static_configs:
      - targets: ['huobao-drama:5678']
    metrics_path: /metrics
```

### 5.3 日志聚合

```yaml
services:
  loki:
    image: grafana/loki:latest
    ports:
      - "3100:3100"
    volumes:
      - ./loki-config.yml:/etc/loki/local-config.yaml

  promtail:
    image: grafana/promtail:latest
    volumes:
      - /var/log/huobao:/var/log/huobao:ro
      - ./promtail-config.yml:/etc/promtail/config.yml
```

### 5.4 告警配置

```yaml
# alertmanager.yml
global:
  smtp_smarthost: 'smtp.gmail.com:587'
  smtp_from: 'alerts@example.com'

route:
  receiver: 'default'
  routes:
    - match:
        severity: critical
      receiver: 'critical'

receivers:
  - name: 'default'
    email_configs:
      - to: 'admin@example.com'
  
  - name: 'critical'
    email_configs:
      - to: 'oncall@example.com'
    slack_configs:
      - api_url: 'https://hooks.slack.com/services/xxx'
```

### 5.5 健康检查端点

```go
// 主要端点
GET /health     // 基础健康检查
GET /ready      // 就绪检查（含依赖）
GET /metrics    // Prometheus指标
```

### 5.6 故障恢复策略

```yaml
services:
  huobao-drama:
    restart: unless-stopped
    deploy:
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
        window: 120s
```

### 5.7 容量规划

```yaml
# 生产环境资源配置
services:
  huobao-drama:
    deploy:
      resources:
        limits:
          cpus: '4'
          memory: 4G
        reservations:
          cpus: '1'
          memory: 1G
    # 扩展配置
    # docker-compose up --scale huobao-drama=3
```

## 6. 安全检查清单

### 6.1 生产环境检查项

```markdown
## 部署前检查清单

### 安全配置
- [ ] HTTPS已启用
- [ ] SSL证书有效
- [ ] 安全头已配置
- [ ] 敏感信息使用环境变量
- [ ] 默认密码已修改
- [ ] 不必要的端口已关闭

### 数据安全
- [ ] 数据库已备份
- [ ] 自动备份策略已配置
- [ ] 敏感数据加密存储
- [ ] 访问日志已启用

### 性能配置
- [ ] 资源限制已设置
- [ ] 连接池已配置
- [ ] 缓存策略已启用
- [ ] CDN已配置（可选）

### 监控告警
- [ ] 健康检查端点可用
- [ ] 监控工具已部署
- [ ] 告警规则已配置
- [ ] 日志收集已启用

### 高可用
- [ ] 自动重启策略已配置
- [ ] 故障转移方案已测试
- [ ] 回滚方案已准备
```

### 6.2 安全配置审查

```bash
# 1. 检查容器安全
docker run --rm -v /var/run/docker.sock:/var/run/docker.sock \
  aquasec/trivy image huobao-drama:latest

# 2. 检查密钥泄露
git-secrets --scan

# 3. 依赖漏洞检查
# Go
nancy sleuth go.sum

# Node
npm audit
cd web && npm audit
```

### 6.3 备份验证

```bash
#!/bin/bash
# verify-backup.sh

set -e

BACKUP_FILE=$1
TEMP_DIR=$(mktemp -d)

# 解压备份
tar -xzf $BACKUP_FILE -C $TEMP_DIR

# 验证SQLite数据库完整性
sqlite3 $TEMP_DIR/drama.db "PRAGMA integrity_check;"

# 清理
rm -rf $TEMP_DIR

echo "Backup verification passed!"
```
