# 数据需求说明书

## 火宝短剧 (Huobao Drama) AI短剧生成平台

**版本**: v1.0  
**日期**: 2025-02-03  
**状态**: 草案  

---

## 1. 数据实体定义

### 1.1 核心实体

#### 1.1.1 Drama (短剧项目)

**实体描述**: 短剧项目的基本信息，是系统的核心管理单元

**属性定义**:

| 属性名 | 数据类型 | 约束 | 描述 |
|-------|---------|------|------|
| ID | uint | PK, Auto Increment | 唯一标识符 |
| Title | varchar(200) | Not Null | 项目标题 |
| Description | text | Nullable | 项目描述/简介 |
| Genre | varchar(50) | Nullable | 类型/风格分类 |
| Style | varchar(50) | Default: 'realistic' | 视觉风格 |
| TotalEpisodes | int | Default: 1 | 总集数 |
| TotalDuration | int | Default: 0 | 总时长(秒) |
| Status | varchar(20) | Default: 'draft', Not Null | 项目状态 |
| Thumbnail | varchar(500) | Nullable | 项目缩略图URL |
| Tags | json | Nullable | 标签数组 |
| Metadata | json | Nullable | 扩展元数据 |
| CreatedAt | datetime | Not Null, AutoCreate | 创建时间 |
| UpdatedAt | datetime | Not Null, AutoUpdate | 更新时间 |
| DeletedAt | datetime | Index, Nullable | 软删除时间 |

**状态枚举**:
- `draft`: 草稿
- `planning`: 策划中
- `production`: 制作中
- `completed`: 已完成
- `archived`: 已归档

**业务规则**:
- 标题不能为空且不超过200字符
- 创建时自动设置状态为"draft"
- 软删除保留数据，不物理删除

#### 1.1.2 Character (角色)

**实体描述**: 短剧中的角色信息，定义人物形象

**属性定义**:

| 属性名 | 数据类型 | 约束 | 描述 |
|-------|---------|------|------|
| ID | uint | PK, Auto Increment | 唯一标识符 |
| DramaID | uint | FK, Not Null, Index | 所属项目ID |
| Name | varchar(100) | Not Null | 角色名称 |
| Role | varchar(50) | Nullable | 角色定位(主角/配角等) |
| Description | text | Nullable | 角色描述 |
| Appearance | text | Nullable | 外貌特征描述 |
| Personality | text | Nullable | 性格特征描述 |
| VoiceStyle | varchar(200) | Nullable | 声音风格 |
| ImageURL | varchar(500) | Nullable | 角色图像URL |
| LocalPath | text | Nullable | 本地文件路径 |
| ReferenceImages | json | Nullable | 参考图像URL数组 |
| SeedValue | varchar(100) | Nullable | AI生成种子值 |
| SortOrder | int | Default: 0 | 排序序号 |
| CreatedAt | datetime | Not Null, AutoCreate | 创建时间 |
| UpdatedAt | datetime | Not Null, AutoUpdate | 更新时间 |
| DeletedAt | datetime | Index, Nullable | 软删除时间 |

**业务规则**:
- 角色名称在同一项目内应唯一
- 图像生成状态通过关联的ImageGeneration记录查询
- 支持多对多关联到Episode

#### 1.1.3 Episode (剧集)

**实体描述**: 短剧的分集，包含独立的剧本内容

**属性定义**:

| 属性名 | 数据类型 | 约束 | 描述 |
|-------|---------|------|------|
| ID | uint | PK, Auto Increment | 唯一标识符 |
| DramaID | uint | FK, Not Null, Index | 所属项目ID |
| EpisodeNum | int | Not Null | 剧集编号 |
| Title | varchar(200) | Not Null | 剧集标题 |
| ScriptContent | longtext | Nullable | 剧本内容(长文本) |
| Description | text | Nullable | 剧集描述 |
| Duration | int | Default: 0 | 总时长(秒) |
| Status | varchar(20) | Default: 'draft' | 剧集状态 |
| VideoURL | varchar(500) | Nullable | 合成视频URL |
| Thumbnail | varchar(500) | Nullable | 剧集缩略图 |
| CreatedAt | datetime | Not Null, AutoCreate | 创建时间 |
| UpdatedAt | datetime | Not Null, AutoUpdate | 更新时间 |
| DeletedAt | datetime | Index, Nullable | 软删除时间 |

**状态枚举**:
- `draft`: 草稿
- `script_ready`: 剧本就绪
- `storyboard_ready`: 分镜就绪
- `images_ready`: 图像就绪
- `videos_ready`: 视频就绪
- `completed`: 已完成

**业务规则**:
- 剧集编号在项目中唯一
- 时长根据关联的Storyboard.Duration计算
- 支持多对多关联到Character

#### 1.1.4 Scene (场景)

**实体描述**: 拍摄场景，定义拍摄的时间地点环境

**属性定义**:

| 属性名 | 数据类型 | 约束 | 描述 |
|-------|---------|------|------|
| ID | uint | PK, Auto Increment | 唯一标识符 |
| DramaID | uint | FK, Not Null, Index | 所属项目ID |
| EpisodeID | uint | FK, Nullable, Index | 所属剧集ID |
| Location | varchar(200) | Not Null | 拍摄地点 |
| Time | varchar(100) | Not Null | 拍摄时间 |
| Prompt | text | Not Null | AI生成提示词 |
| StoryboardCount | int | Default: 1 | 关联分镜数量 |
| ImageURL | varchar(500) | Nullable | 场景图像URL |
| LocalPath | text | Nullable | 本地文件路径 |
| Status | varchar(20) | Default: 'pending' | 生成状态 |
| CreatedAt | datetime | Not Null, AutoCreate | 创建时间 |
| UpdatedAt | datetime | Not Null, AutoUpdate | 更新时间 |
| DeletedAt | datetime | Index, Nullable | 软删除时间 |

**状态枚举**:
- `pending`: 待生成
- `generated`: 已生成
- `failed`: 生成失败

**业务规则**:
- 场景可属于项目级别或剧集级别
- 提示词用于AI图像生成
- 关联分镜数量用于统计

#### 1.1.5 Storyboard (分镜)

**实体描述**: 剧本分解的单个镜头，包含详细的拍摄信息

**属性定义**:

| 属性名 | 数据类型 | 约束 | 描述 |
|-------|---------|------|------|
| ID | uint | PK, Auto Increment | 唯一标识符 |
| EpisodeID | uint | FK, Not Null, Index | 所属剧集ID |
| SceneID | uint | FK, Nullable, Index | 关联场景ID |
| StoryboardNumber | int | Not Null | 分镜编号 |
| Title | varchar(255) | Nullable | 分镜标题 |
| Location | varchar(255) | Nullable | 拍摄地点 |
| Time | varchar(255) | Nullable | 拍摄时间 |
| ShotType | varchar(100) | Nullable | 镜头类型 |
| Angle | varchar(100) | Nullable | 拍摄角度 |
| Movement | varchar(100) | Nullable | 镜头运动 |
| Action | text | Nullable | 动作描述 |
| Result | text | Nullable | 动作结果 |
| Atmosphere | text | Nullable | 氛围描述 |
| ImagePrompt | text | Nullable | 图像生成提示词 |
| VideoPrompt | text | Nullable | 视频生成提示词 |
| BgmPrompt | text | Nullable | 背景音乐提示词 |
| SoundEffect | varchar(255) | Nullable | 音效 |
| Dialogue | text | Nullable | 对话内容 |
| Description | text | Nullable | 详细描述 |
| Duration | int | Default: 5 | 镜头时长(秒) |
| ComposedImage | text | Nullable | 合成图像URL |
| VideoURL | text | Nullable | 生成视频URL |
| Status | varchar(20) | Default: 'pending' | 处理状态 |
| CreatedAt | datetime | AutoCreate | 创建时间 |
| UpdatedAt | datetime | AutoUpdate | 更新时间 |
| DeletedAt | datetime | Index, Nullable | 软删除时间 |

**状态枚举**:
- `pending`: 待处理
- `script_parsed`: 剧本已解析
- `images_generating`: 图像生成中
- `images_ready`: 图像就绪
- `videos_generating`: 视频生成中
- `videos_ready`: 视频就绪
- `completed`: 已完成
- `failed`: 处理失败

**业务规则**:
- 分镜编号在剧集中唯一且连续
- 支持多对多关联到Character和Prop
- 场景和道具可以跨分镜复用

#### 1.1.6 Prop (道具)

**实体描述**: 短剧中使用的道具物品

**属性定义**:

| 属性名 | 数据类型 | 约束 | 描述 |
|-------|---------|------|------|
| ID | uint | PK, Auto Increment | 唯一标识符 |
| DramaID | uint | FK, Not Null, Index | 所属项目ID |
| Name | varchar(100) | Not Null | 道具名称 |
| Type | varchar(50) | Nullable | 道具类型 |
| Description | text | Nullable | 道具描述 |
| Prompt | text | Nullable | AI生成提示词 |
| ImageURL | varchar(500) | Nullable | 道具图像URL |
| LocalPath | text | Nullable | 本地文件路径 |
| ReferenceImages | json | Nullable | 参考图像数组 |
| CreatedAt | datetime | Not Null, AutoCreate | 创建时间 |
| UpdatedAt | datetime | Not Null, AutoUpdate | 更新时间 |
| DeletedAt | datetime | Index, Nullable | 软删除时间 |

**业务规则**:
- 道具名称在同一项目内建议唯一
- 支持多对多关联到Storyboard
- 可自动从剧本中提取

### 1.2 生成记录实体

#### 1.2.1 ImageGeneration (图像生成记录)

**实体描述**: 记录AI图像生成任务的执行过程和结果

**属性定义**:

| 属性名 | 数据类型 | 约束 | 描述 |
|-------|---------|------|------|
| ID | uint | PK, Auto Increment | 唯一标识符 |
| StoryboardID | uint | FK, Nullable, Index | 关联分镜ID |
| DramaID | uint | FK, Not Null, Index | 所属项目ID |
| SceneID | uint | FK, Nullable, Index | 关联场景ID |
| CharacterID | uint | FK, Nullable, Index | 关联角色ID |
| PropID | uint | FK, Nullable, Index | 关联道具ID |
| ImageType | varchar(20) | Not Null, Default: 'storyboard', Index | 图像类型 |
| FrameType | varchar(20) | Nullable | 帧类型 |
| Provider | varchar(50) | Not Null | AI提供商 |
| Prompt | text | Not Null | 生成提示词 |
| NegPrompt | text | Nullable | 负面提示词 |
| Model | varchar(100) | Nullable | AI模型 |
| Size | varchar(20) | Nullable | 图像尺寸 |
| Quality | varchar(20) | Nullable | 图像质量 |
| Style | varchar(50) | Nullable | 图像风格 |
| Steps | int | Nullable | 生成步数 |
| CfgScale | float | Nullable | CFG比例 |
| Seed | bigint | Nullable | 随机种子 |
| ImageURL | text | Nullable | 图像URL |
| MinioURL | text | Nullable | MinIO存储URL |
| LocalPath | text | Nullable | 本地路径 |
| Status | varchar(20) | Not Null, Default: 'pending' | 生成状态 |
| TaskID | varchar(200) | Nullable | 外部任务ID |
| ErrorMsg | text | Nullable | 错误信息 |
| Width | int | Nullable | 图像宽度 |
| Height | int | Nullable | 图像高度 |
| ReferenceImages | json | Nullable | 参考图像数组 |
| CreatedAt | datetime | AutoCreate | 创建时间 |
| UpdatedAt | datetime | AutoUpdate | 更新时间 |
| CompletedAt | datetime | Nullable | 完成时间 |

**图像类型枚举**:
- `character`: 角色图像
- `scene`: 场景图像
- `prop`: 道具图像
- `storyboard`: 分镜图像

**帧类型枚举**:
- `first`: 首帧
- `key`: 关键帧
- `last`: 尾帧
- `panel`: 面板帧
- `action`: 动作帧

**状态枚举**:
- `pending`: 待处理
- `processing`: 处理中
- `completed`: 已完成
- `failed`: 失败

**业务规则**:
- StoryboardID、SceneID、CharacterID、PropID至少有一个不为空
- 生成参数完整记录用于复现和调试
- 完成后自动创建Asset记录

#### 1.2.2 VideoGeneration (视频生成记录)

**实体描述**: 记录AI视频生成任务的执行过程和结果

**属性定义**:

| 属性名 | 数据类型 | 约束 | 描述 |
|-------|---------|------|------|
| ID | uint | PK, Auto Increment | 唯一标识符 |
| StoryboardID | uint | FK, Nullable, Index | 关联分镜ID |
| DramaID | uint | FK, Not Null, Index | 所属项目ID |
| Provider | varchar(50) | Not Null, Index | AI提供商 |
| Prompt | text | Not Null | 生成提示词 |
| Model | varchar(100) | Nullable | AI模型 |
| ImageGenID | uint | FK, Nullable, Index | 关联图像生成ID |
| ReferenceMode | varchar(20) | Nullable | 参考模式 |
| ImageURL | varchar(1000) | Nullable | 参考图像URL |
| FirstFrameURL | varchar(1000) | Nullable | 首帧URL |
| LastFrameURL | varchar(1000) | Nullable | 尾帧URL |
| ReferenceImageURLs | text | Nullable | 参考图URL数组(JSON) |
| Duration | int | Nullable | 视频时长(秒) |
| FPS | int | Nullable | 帧率 |
| Resolution | varchar(50) | Nullable | 分辨率 |
| AspectRatio | varchar(20) | Nullable | 宽高比 |
| Style | varchar(100) | Nullable | 视频风格 |
| MotionLevel | int | Nullable | 运动强度 |
| CameraMotion | varchar(100) | Nullable | 相机运动 |
| Seed | bigint | Nullable | 随机种子 |
| VideoURL | varchar(1000) | Nullable | 视频URL |
| MinioURL | varchar(1000) | Nullable | MinIO URL |
| LocalPath | varchar(500) | Nullable | 本地路径 |
| Status | varchar(20) | Not Null, Default: 'pending', Index | 生成状态 |
| TaskID | varchar(200) | Nullable, Index | 外部任务ID |
| ErrorMsg | text | Nullable | 错误信息 |
| Width | int | Nullable | 视频宽度 |
| Height | int | Nullable | 视频高度 |
| CompletedAt | datetime | Nullable | 完成时间 |
| CreatedAt | datetime | AutoCreate | 创建时间 |
| UpdatedAt | datetime | AutoUpdate | 更新时间 |
| DeletedAt | datetime | Index, Nullable | 软删除时间 |

**参考模式枚举**:
- `single`: 单图模式
- `first_last`: 首尾帧模式
- `multiple`: 多图模式
- `none`: 无参考图

**状态枚举**:
- `pending`: 待处理
- `processing`: 处理中
- `completed`: 已完成
- `failed`: 失败

**业务规则**:
- 通常关联到Storyboard或ImageGeneration
- 视频参数完整记录
- 完成后自动创建Asset记录

### 1.3 配置和任务实体

#### 1.3.1 AIServiceConfig (AI服务配置)

**实体描述**: AI服务提供商的配置信息

**属性定义**:

| 属性名 | 数据类型 | 约束 | 描述 |
|-------|---------|------|------|
| ID | uint | PK, Auto Increment | 唯一标识符 |
| ServiceType | varchar(50) | Not Null | 服务类型(text/image/video) |
| Provider | varchar(50) | Nullable | 提供商名称 |
| Name | varchar(100) | Not Null | 配置名称 |
| BaseURL | varchar(255) | Not Null | 基础URL |
| APIKey | varchar(255) | Not Null | API密钥(加密存储) |
| Model | text | Nullable | 模型名称(支持字符串或数组) |
| Endpoint | varchar(255) | Nullable | API端点 |
| QueryEndpoint | varchar(255) | Nullable | 查询端点 |
| Priority | int | Default: 0 | 优先级 |
| IsDefault | bool | Default: false | 是否默认配置 |
| IsActive | bool | Default: true | 是否激活 |
| Settings | text | Nullable | 额外设置(JSON) |
| CreatedAt | datetime | Not Null, AutoCreate | 创建时间 |
| UpdatedAt | datetime | Not Null, AutoUpdate | 更新时间 |

**服务类型枚举**:
- `text`: 文本生成
- `image`: 图像生成
- `video`: 视频生成

**业务规则**:
- 同一服务类型只能有一个默认配置
- API密钥加密存储，返回时脱敏
- 优先级数值越大优先级越高

#### 1.3.2 AsyncTask (异步任务)

**实体描述**: 异步执行的任务记录

**属性定义**:

| 属性名 | 数据类型 | 约束 | 描述 |
|-------|---------|------|------|
| ID | varchar(36) | PK | UUID唯一标识符 |
| Type | varchar(50) | Not Null, Index | 任务类型 |
| Status | varchar(20) | Not Null, Index | 任务状态 |
| Progress | int | Default: 0 | 进度百分比(0-100) |
| Message | varchar(500) | Nullable | 状态消息 |
| Error | text | Nullable | 错误详情 |
| Result | text | Nullable | 结果数据(JSON) |
| ResourceID | varchar(36) | Nullable, Index | 关联资源ID |
| CreatedAt | datetime | AutoCreate | 创建时间 |
| UpdatedAt | datetime | AutoUpdate | 更新时间 |
| CompletedAt | datetime | Nullable | 完成时间 |
| DeletedAt | datetime | Index, Nullable | 软删除时间 |

**任务类型枚举**:
- `storyboard_generation`: 分镜生成
- `batch_image_generation`: 批量图像生成
- `batch_video_generation`: 批量视频生成
- `video_merge`: 视频合成

**状态枚举**:
- `pending`: 待处理
- `processing`: 处理中
- `completed`: 已完成
- `failed`: 失败
- `cancelled`: 已取消

**业务规则**:
- ResourceID关联到具体的业务资源（如EpisodeID）
- Result字段存储JSON格式的结果数据
- 支持任务取消操作

#### 1.3.3 Asset (资产)

**实体描述**: 生成的媒体资产，可用于复用

**属性定义**:

| 属性名 | 数据类型 | 约束 | 描述 |
|-------|---------|------|------|
| ID | uint | PK, Auto Increment | 唯一标识符 |
| DramaID | uint | FK, Nullable, Index | 所属项目ID |
| EpisodeID | uint | FK, Nullable, Index | 所属剧集ID |
| StoryboardID | uint | FK, Nullable, Index | 关联分镜ID |
| StoryboardNum | int | Nullable | 分镜编号 |
| Name | varchar(200) | Not Null | 资产名称 |
| Description | text | Nullable | 资产描述 |
| Type | varchar(20) | Not Null, Index | 资产类型 |
| Category | varchar(50) | Nullable, Index | 资产分类 |
| URL | varchar(1000) | Not Null | 资产URL |
| ThumbnailURL | varchar(1000) | Nullable | 缩略图URL |
| LocalPath | varchar(500) | Nullable | 本地路径 |
| FileSize | bigint | Nullable | 文件大小(字节) |
| MimeType | varchar(100) | Nullable | MIME类型 |
| Width | int | Nullable | 宽度(图像/视频) |
| Height | int | Nullable | 高度(图像/视频) |
| Duration | int | Nullable | 时长(视频/音频) |
| Format | varchar(50) | Nullable | 文件格式 |
| ImageGenID | uint | FK, Nullable, Index | 关联图像生成ID |
| VideoGenID | uint | FK, Nullable, Index | 关联视频生成ID |
| IsFavorite | bool | Default: false | 是否收藏 |
| ViewCount | int | Default: 0 | 浏览次数 |
| CreatedAt | datetime | AutoCreate | 创建时间 |
| UpdatedAt | datetime | AutoUpdate | 更新时间 |
| DeletedAt | datetime | Index, Nullable | 软删除时间 |

**资产类型枚举**:
- `image`: 图像
- `video`: 视频
- `audio`: 音频

**业务规则**:
- 资产可以从ImageGeneration或VideoGeneration导入
- 支持按类型、项目、分类过滤
- 收藏的资产在列表中优先显示

#### 1.3.4 CharacterLibrary (角色库)

**实体描述**: 全局可复用的角色资源

**属性定义**:

| 属性名 | 数据类型 | 约束 | 描述 |
|-------|---------|------|------|
| ID | uint | PK, Auto Increment | 唯一标识符 |
| Name | varchar(100) | Not Null | 角色名称 |
| Category | varchar(50) | Nullable | 角色分类 |
| ImageURL | varchar(500) | Not Null | 角色图像URL |
| LocalPath | varchar(500) | Nullable | 本地路径 |
| Description | text | Nullable | 角色描述 |
| Tags | varchar(500) | Nullable | 标签 |
| SourceType | varchar(20) | Default: 'generated' | 来源类型 |
| CreatedAt | datetime | Not Null, AutoCreate | 创建时间 |
| UpdatedAt | datetime | Not Null, AutoUpdate | 更新时间 |
| DeletedAt | datetime | Index, Nullable | 软删除时间 |

**来源类型枚举**:
- `generated`: AI生成
- `uploaded`: 用户上传

**业务规则**:
- 角色库项可以应用到任意项目的角色
- 支持按分类和标签搜索

#### 1.3.5 FramePrompt (帧提示词)

**实体描述**: 分镜特定帧的AI生成提示词

**属性定义**:

| 属性名 | 数据类型 | 约束 | 描述 |
|-------|---------|------|------|
| ID | uint | PK, Auto Increment | 唯一标识符 |
| StoryboardID | uint | FK, Not Null, Index | 关联分镜ID |
| FrameType | varchar(20) | Not Null, Index | 帧类型 |
| Prompt | text | Not Null | 生成提示词 |
| Description | text | Nullable | 描述 |
| Layout | varchar(50) | Nullable | 布局(仅panel/action) |
| CreatedAt | datetime | AutoCreate | 创建时间 |
| UpdatedAt | datetime | AutoUpdate | 更新时间 |

**帧类型枚举**:
- `first`: 首帧
- `key`: 关键帧
- `last`: 尾帧
- `panel`: 面板帧
- `action`: 动作帧

**业务规则**:
- 每个分镜可以有多个不同类型的帧提示词
- Layout字段仅用于panel和action类型

---

## 2. 实体关系图 (ER Diagram)

### 2.1 实体关系概述

```
[1] Drama --<N> [Episode]
    |
    |--<N> [Character]
    |
    |--<N> [Scene]
    |
    |--<N> [Prop]

[N] Episode --<N> [Character] (多对多: episode_characters)
    |
    |--<N> [Scene]
    |
    |--<N> [Storyboard]

[N] Scene --<N> [Storyboard]

[N] Storyboard --<N> [Character] (多对多: storyboard_characters)
    |
    |--<N> [Prop] (多对多: storyboard_props)
    |
    |--<N> [FramePrompt]
    |
    |--<N> [ImageGeneration]
    |
    |--<N> [VideoGeneration]

[N] Character --<N> [ImageGeneration]

[N] Prop --<N> [ImageGeneration]

[N] ImageGeneration --<1> [Asset]

[N] VideoGeneration --<1> [Asset]

[1] AIServiceConfig (独立配置表)

[1] CharacterLibrary (独立资源表)

[1] AsyncTask (任务记录表)
```

### 2.2 关系详细说明

#### 2.2.1 Drama - Episode (1:N)
- **关系类型**: 一对多
- **外键**: Episode.DramaID
- **级联操作**: 删除Drama时级联删除关联的Episode
- **业务含义**: 一个短剧项目包含多个剧集

#### 2.2.2 Drama - Character (1:N)
- **关系类型**: 一对多
- **外键**: Character.DramaID
- **级联操作**: 删除Drama时级联删除关联的Character
- **业务含义**: 一个短剧项目定义多个角色

#### 2.2.3 Drama - Scene (1:N)
- **关系类型**: 一对多
- **外键**: Scene.DramaID
- **级联操作**: 删除Drama时级联删除关联的Scene
- **业务含义**: 一个短剧项目包含多个场景

#### 2.2.4 Drama - Prop (1:N)
- **关系类型**: 一对多
- **外键**: Prop.DramaID
- **级联操作**: 删除Drama时级联删除关联的Prop
- **业务含义**: 一个短剧项目包含多个道具

#### 2.2.5 Episode - Character (N:M)
- **关系类型**: 多对多
- **关联表**: episode_characters
- **外键**: EpisodeID, CharacterID
- **业务含义**: 一个剧集可以有多个角色，一个角色可以出现在多个剧集

#### 2.2.6 Episode - Scene (1:N)
- **关系类型**: 一对多
- **外键**: Scene.EpisodeID (Nullable)
- **级联操作**: 删除Episode时清理关联的Scene.EpisodeID
- **业务含义**: 一个剧集包含多个场景，场景也可属于项目级别

#### 2.2.7 Episode - Storyboard (1:N)
- **关系类型**: 一对多
- **外键**: Storyboard.EpisodeID
- **级联操作**: 删除Episode时级联删除关联的Storyboard (CASCADE)
- **业务含义**: 一个剧集包含多个分镜

#### 2.2.8 Scene - Storyboard (1:N)
- **关系类型**: 一对多
- **外键**: Storyboard.SceneID (Nullable)
- **级联操作**: 删除Scene时清理关联的Storyboard.SceneID
- **业务含义**: 一个场景可以在多个分镜中使用

#### 2.2.9 Storyboard - Character (N:M)
- **关系类型**: 多对多
- **关联表**: storyboard_characters
- **外键**: StoryboardID, CharacterID
- **业务含义**: 一个分镜可以有多个角色，一个角色可以出现在多个分镜

#### 2.2.10 Storyboard - Prop (N:M)
- **关系类型**: 多对多
- **关联表**: storyboard_props
- **外键**: StoryboardID, PropID
- **业务含义**: 一个分镜可以有多个道具，一个道具可以在多个分镜中使用

#### 2.2.11 Storyboard - FramePrompt (1:N)
- **关系类型**: 一对多
- **外键**: FramePrompt.StoryboardID
- **级联操作**: 删除Storyboard时级联删除关联的FramePrompt
- **业务含义**: 一个分镜可以有多个帧提示词

#### 2.2.12 Character - ImageGeneration (1:N)
- **关系类型**: 一对多
- **外键**: ImageGeneration.CharacterID (Nullable)
- **业务含义**: 一个角色可以有多个图像生成记录（历史记录）

#### 2.2.13 Scene - ImageGeneration (1:N)
- **关系类型**: 一对多
- **外键**: ImageGeneration.SceneID (Nullable)
- **业务含义**: 一个场景可以有多个图像生成记录

#### 2.2.14 Prop - ImageGeneration (1:N)
- **关系类型**: 一对多
- **外键**: ImageGeneration.PropID (Nullable)
- **业务含义**: 一个道具可以有多个图像生成记录

#### 2.2.15 Storyboard - ImageGeneration (1:N)
- **关系类型**: 一对多
- **外键**: ImageGeneration.StoryboardID (Nullable)
- **业务含义**: 一个分镜可以有多个图像生成记录

#### 2.2.16 Storyboard - VideoGeneration (1:N)
- **关系类型**: 一对多
- **外键**: VideoGeneration.StoryboardID (Nullable)
- **业务含义**: 一个分镜可以有多个视频生成记录

#### 2.2.17 ImageGeneration - VideoGeneration (1:N)
- **关系类型**: 一对多
- **外键**: VideoGeneration.ImageGenID (Nullable)
- **业务含义**: 一个图像可以生成多个视频（不同参数）

#### 2.2.18 ImageGeneration - Asset (N:1)
- **关系类型**: 多对一
- **外键**: Asset.ImageGenID (Nullable)
- **业务含义**: 多个资产可以来自同一个图像生成记录

#### 2.2.19 VideoGeneration - Asset (N:1)
- **关系类型**: 多对一
- **外键**: Asset.VideoGenID (Nullable)
- **业务含义**: 多个资产可以来自同一个视频生成记录

---

## 3. 数据存储需求

### 3.1 数据库存储

#### 3.1.1 SQLite配置

**适用场景**: 开发环境、小规模部署、个人使用

**配置参数**:
```yaml
database:
  type: sqlite
  path: ./data/huobao.db
  max_idle: 5
  max_open: 20
```

**存储需求**:
- 数据库文件: 约500MB（10,000个项目）
- 索引: 自动创建
- WAL模式: 启用（提高并发性能）

#### 3.1.2 MySQL配置

**适用场景**: 生产环境、大规模部署、多用户并发

**配置参数**:
```yaml
database:
  type: mysql
  host: localhost
  port: 3306
  user: huobao
  password: <encrypted>
  database: huobao_drama
  charset: utf8mb4
  max_idle: 10
  max_open: 100
```

**存储需求**:
- 初始空间: 100MB
- 增长估算: 每1000个项目约50MB
- 索引空间: 额外20%
- 备份空间: 每日全量备份

### 3.2 文件存储

#### 3.2.1 本地文件系统

**目录结构**:
```
./storage/
├── dramas/
│   ├── {drama_id}/
│   │   ├── characters/
│   │   ├── scenes/
│   │   ├── episodes/
│   │   │   └── {episode_id}/
│   │   │       ├── storyboards/
│   │   │       └── videos/
│   │   └── assets/
├── uploads/
│   ├── images/
│   └── videos/
├── temp/
│   └── processing/
└── exports/
```

**存储配额**:

| 数据类型 | 单文件上限 | 存储路径 |
|---------|----------|---------|
| 角色图像 | 10MB | dramas/{id}/characters/ |
| 场景图像 | 10MB | dramas/{id}/scenes/ |
| 分镜图像 | 10MB | dramas/{id}/episodes/{eid}/storyboards/ |
| 生成视频 | 100MB | dramas/{id}/episodes/{eid}/videos/ |
| 上传文件 | 50MB | uploads/ |
| 临时文件 | 500MB | temp/ |

#### 3.2.2 MinIO对象存储

**适用场景**: 分布式部署、云环境、大规模存储

**配置参数**:
```yaml
storage:
  type: minio
  endpoint: localhost:9000
  access_key: <encrypted>
  secret_key: <encrypted>
  bucket: huobao-drama
  use_ssl: true
  region: us-east-1
```

**存储策略**:
- 桶结构: 与本地目录结构一致
- 访问控制: 私有桶，通过预签名URL访问
- 生命周期: 自动归档30天前的临时文件
- 版本控制: 启用（保留历史版本）

### 3.3 数据存储容量估算

#### 3.3.1 结构化数据

| 数据表 | 单记录大小 | 预估记录数 | 总空间 |
|-------|----------|----------|-------|
| Drama | 2KB | 1,000 | 2MB |
| Character | 1KB | 5,000 | 5MB |
| Episode | 5KB | 5,000 | 25MB |
| Scene | 1KB | 10,000 | 10MB |
| Storyboard | 3KB | 50,000 | 150MB |
| Prop | 1KB | 2,000 | 2MB |
| ImageGeneration | 2KB | 100,000 | 200MB |
| VideoGeneration | 2KB | 50,000 | 100MB |
| Asset | 1KB | 200,000 | 200MB |
| AsyncTask | 1KB | 500,000 | 500MB |
| **合计** | - | - | **~1.2GB** |

#### 3.3.2 非结构化数据

| 数据类型 | 单文件平均大小 | 预估文件数 | 总空间 |
|---------|--------------|----------|-------|
| 角色图像 | 2MB | 5,000 | 10GB |
| 场景图像 | 2MB | 10,000 | 20GB |
| 分镜图像 | 2MB | 100,000 | 200GB |
| 生成视频 | 20MB | 50,000 | 1TB |
| 合成视频 | 50MB | 5,000 | 250GB |
| 上传文件 | 5MB | 10,000 | 50GB |
| 音频文件 | 5MB | 5,000 | 25GB |
| **合计** | - | - | **~1.5TB** |

---

## 4. 数据流需求

### 4.1 剧本到分镜数据流

**流程名称**: Script to Storyboard Data Flow
**触发条件**: 用户提交剧本解析请求
**数据流向**: Episode → AI Service → Storyboard/Scene/Character

**详细步骤**:

1. **输入阶段**
   - 源: Episode.ScriptContent
   - 数据: 剧本文本（长文本）
   - 验证: 内容不为空，长度不超过10MB

2. **处理阶段**
   - 处理者: ScriptGenerationService
   - AI调用: AIService.GenerateStoryboard()
   - 输入: 剧本文本 + AI提示词模板
   - 输出: JSON格式的分镜数据

3. **解析阶段**
   - 处理者: JSON解析器
   - 解析: AI返回的JSON数据
   - 提取: 场景列表、角色列表、分镜列表

4. **存储阶段**
   - Scene处理:
     - 检查现有场景（按Location + Time）
     - 不存在则创建新Scene记录
     - 存在则复用现有Scene
   
   - Character处理:
     - 检查项目现有角色（按Name）
     - 不存在则创建新Character
     - 建立Episode_Character关联
   
   - Storyboard处理:
     - 按顺序创建Storyboard记录
     - 关联Episode、Scene、Characters
     - 设置StoryboardNumber递增

5. **状态更新**
   - 更新Episode.Status = "script_parsed"
   - 更新Drama.UpdatedAt

**数据转换映射**:
```
剧本文本
  ↓ AI解析
分镜JSON {
  scenes: [{location, time, description}],
  characters: [{name, role, description}],
  storyboards: [{
    scene_index,
    character_names,
    shot_type,
    angle,
    action,
    dialogue
  }]
}
  ↓ 转换
数据库记录 (Storyboard, Scene, Character)
```

### 4.2 图像生成数据流

**流程名称**: Image Generation Data Flow
**触发条件**: 用户提交图像生成请求
**数据流向**: Generation Request → AI Service → Local Storage → Database

**详细步骤**:

1. **请求创建**
   - 创建ImageGeneration记录
   - 状态: pending
   - 填充参数: Prompt, Provider, Model, Size等
   - 关联: StoryboardID/SceneID/CharacterID/PropID

2. **AI调用**
   - 服务: ImageGenerationService
   - 调用: AIClient.GenerateImage()
   - 参数: ImageGeneration记录
   - 更新状态: processing

3. **异步处理**
   - 等待AI服务回调或轮询结果
   - 超时: 180秒
   - 重试: 最多3次

4. **结果处理**
   - 成功:
     - 下载图像到本地存储
     - 计算图像尺寸(Width, Height)
     - 更新ImageGeneration状态为completed
     - 填充ImageURL, LocalPath, CompletedAt
     - 触发Asset创建
   
   - 失败:
     - 更新状态为failed
     - 记录ErrorMsg
     - 记录失败原因到日志

5. **资产创建**
   - 自动创建Asset记录
   - 关联ImageGenID
   - 复制元数据

**状态流转**:
```
pending → processing → completed
                ↓
              failed
```

### 4.3 视频生成数据流

**流程名称**: Video Generation Data Flow
**触发条件**: 用户提交视频生成请求
**数据流向**: Image/Config → AI Service → Video File → Database

**详细步骤**:

1. **配置准备**
   - 创建VideoGeneration记录
   - 状态: pending
   - 参数: Prompt, Duration, Resolution, MotionLevel等
   - 参考图: ImageURL / FirstFrameURL / LastFrameURL

2. **参考图处理**
   - 单图模式: 使用ImageGen关联的图像
   - 首尾帧模式: 上传两张图像
   - 多图模式: 上传图像数组

3. **AI调用**
   - 服务: VideoGenerationService
   - 调用: VideoClient.GenerateVideo()
   - 超时: 600秒

4. **结果处理**
   - 成功:
     - 下载视频到本地
     - 解析视频元数据(Width, Height, Duration)
     - 生成视频缩略图
     - 更新VideoGeneration状态
     - 创建Asset记录
   
   - 失败:
     - 记录详细错误
     - 允许重试

### 4.4 视频合成数据流

**流程名称**: Video Merge Data Flow
**触发条件**: 用户提交视频合成请求
**数据流向**: Video List → FFmpeg → Merged Video → Storage

**详细步骤**:

1. **输入收集**
   - 查询Episode的所有Storyboard
   - 收集Storyboard.VideoURL
   - 验证所有视频存在且可访问

2. **任务创建**
   - 创建VideoMerge记录
   - 状态: pending
   - 配置: 转场效果、输出格式

3. **FFmpeg处理**
   - 构建FFmpeg命令:
     ```bash
     ffmpeg -i video1.mp4 -i video2.mp4 ...
       -filter_complex "[0:v][1:v]xfade=transition=fade:duration=1[outv]"
       -map "[outv]" output.mp4
     ```
   - 执行命令
   - 监控进度

4. **结果处理**
   - 成功:
     - 移动输出文件到存储目录
     - 更新VideoMerge记录
     - 更新Episode.VideoURL
     - 创建Asset记录
   
   - 失败:
     - 记录FFmpeg错误输出
     - 标记任务失败
     - 保留临时文件用于调试

5. **清理**
   - 删除临时文件
   - 记录处理日志

---

## 5. 数据备份与恢复

### 5.1 备份策略

#### 5.1.1 结构化数据备份

**SQLite备份**:
- 频率: 每日凌晨2:00
- 方式: 文件复制 + 压缩
- 保留: 7个版本（7天）
- 存储: ./backups/sqlite/YYYYMMDD/

**MySQL备份**:
- 频率: 每小时
- 方式: mysqldump + 压缩
- 保留: 24个版本（1天）
- 每日全量: 保留30天
- 命令:
  ```bash
  mysqldump -u huobao -p huobao_drama | gzip > backup_$(date +%Y%m%d_%H%M%S).sql.gz
  ```

#### 5.1.2 文件存储备份

**本地存储备份**:
- 频率: 每日增量
- 方式: rsync
- 目标: 外部存储/NAS
- 命令:
  ```bash
  rsync -av --delete ./storage/ /backup/storage/
  ```

**MinIO备份**:
- 频率: 实时（跨地域复制）
- 方式: MinIO Bucket Replication
- 目标: 异地MinIO集群

### 5.2 恢复流程

#### 5.2.1 数据库恢复

**SQLite恢复**:
1. 停止应用服务
2. 备份当前数据库（如损坏不严重）
3. 复制备份文件到数据目录
4. 验证数据库完整性: `PRAGMA integrity_check`
5. 启动应用服务

**MySQL恢复**:
1. 停止应用服务
2. 创建新数据库或清空现有数据库
3. 解压备份文件
4. 导入数据: `mysql -u huobao -p huobao_drama < backup.sql`
5. 验证数据完整性
6. 启动应用服务

#### 5.2.2 文件恢复

1. 停止文件写入操作
2. 从备份恢复文件
3. 验证文件完整性（MD5校验）
4. 更新数据库中的文件路径（如需要）
5. 恢复写入操作

---

## 6. 数据安全

### 6.1 数据加密

#### 6.1.1 静态数据加密

**敏感字段加密**:
- 字段: AIServiceConfig.APIKey
- 算法: AES-256-GCM
- 密钥管理: 环境变量或密钥管理服务
- 实现: 应用层加密，存储密文

**数据库加密**:
- SQLite: 使用SQLCipher（可选）
- MySQL: 启用TDE（透明数据加密）

#### 6.1.2 传输加密

**API通信**:
- 协议: HTTPS
- TLS版本: 1.2+
- 证书: 有效且未过期
- HSTS: 启用

**AI服务通信**:
- 协议: HTTPS
- 证书验证: 严格模式
- API密钥: 请求头传输

### 6.2 数据脱敏

**日志脱敏**:
- 模式: API密钥、密码、Token替换为`***`
- 规则: 正则表达式匹配敏感信息

**API响应脱敏**:
- AIServiceConfig.APIKey: 只显示前4位和后4位
- 错误信息: 不暴露内部路径和堆栈

### 6.3 数据清理

**软删除数据**:
- 策略: 保留30天后物理删除
- 机制: 定时任务清理DeletedAt > 30天的记录
- 关联数据: 级联清理或保留（根据业务）

**临时文件**:
- 策略: 7天后自动删除
- 路径: ./storage/temp/
- 机制: 定时任务扫描清理

---

## 7. 数据质量

### 7.1 数据验证规则

| 实体 | 字段 | 验证规则 | 错误处理 |
|-----|------|---------|---------|
| Drama | Title | 必填, 1-200字符 | 返回400错误 |
| Character | Name | 必填, 1-100字符 | 返回400错误 |
| Episode | EpisodeNum | 必填, 正整数 | 返回400错误 |
| Storyboard | Duration | 范围1-300秒 | 自动修正为边界值 |
| ImageGeneration | Prompt | 必填, 最大10KB | 返回400错误 |

### 7.2 数据完整性约束

**外键约束**:
- 所有外键关系使用数据库外键约束
- 删除父表记录时级联或限制删除

**唯一约束**:
- AIServiceConfig.Name: 唯一
- CharacterLibrary.Name: 唯一
- Episode (DramaID, EpisodeNum): 联合唯一

**检查约束**:
- Storyboard.Duration >= 1
- AsyncTask.Progress BETWEEN 0 AND 100

---

**文档结束**
