# 功能需求说明书

## 火宝短剧 (Huobao Drama) AI短剧生成平台

**版本**: v1.0  
**日期**: 2025-02-03  
**状态**: 草案  

---

## 1. 短剧管理功能

### 1.1 创建短剧项目

**功能描述**: 用户可以创建新的短剧项目，设置项目基本信息

**输入**:
- 标题 (必填, 1-100字符)
- 描述 (可选, 文本)
- 类型 (可选, 50字符)
- 标签 (可选, JSON数组)

**处理**:
1. 验证输入数据有效性
2. 创建Drama记录，状态设为"draft"
3. 记录创建时间
4. 返回创建的项目信息

**输出**:
- 成功: 返回项目详情（ID、标题、状态等）
- 失败: 返回错误信息和原因

**验收标准** (EARS格式):
- WHEN 用户提交有效项目信息 THEN 系统 SHALL 创建新项目并返回项目ID
- WHEN 标题为空 THEN 系统 SHALL 返回400错误，提示标题必填
- WHEN 标题超过100字符 THEN 系统 SHALL 返回400错误，提示标题过长
- WHEN 创建成功 THEN 项目状态 SHALL 默认为"draft"

### 1.2 查询短剧项目列表

**功能描述**: 用户可以查看短剧项目列表，支持分页和过滤

**输入**:
- 页码 (可选, 默认1)
- 每页数量 (可选, 默认20)
- 状态 (可选, 过滤条件)
- 类型 (可选, 过滤条件)
- 关键词 (可选, 搜索标题和描述)

**处理**:
1. 构建查询条件
2. 计算总数
3. 分页查询项目列表
4. 预加载关联的剧集和分镜数据
5. 计算每个剧集的时长

**输出**:
- 成功: 返回项目列表（包含基本统计信息）和总数量
- 失败: 返回错误信息

**验收标准**:
- WHEN 用户请求项目列表 THEN 系统 SHALL 返回分页结果
- WHEN 提供状态过滤 THEN 系统 SHALL 只返回该状态的项目
- WHEN 提供关键词 THEN 系统 SHALL 在标题和描述中搜索
- WHEN 列表包含剧集 THEN 系统 SHALL 计算并返回每个剧集的时长
- WHEN 没有项目 THEN 系统 SHALL 返回空列表，而不是错误

### 1.3 查看短剧详情

**功能描述**: 用户可以查看短剧项目的详细信息，包含所有关联数据

**输入**:
- 项目ID (必填)

**处理**:
1. 查询项目基本信息
2. 预加载关联数据：角色、场景、道具、剧集
3. 预加载每个剧集的角色、场景、分镜
4. 查询角色和场景的图片生成状态
5. 整合所有剧集的场景到项目级别

**输出**:
- 成功: 返回完整的项目详情（包含所有关联数据）
- 失败: 返回404错误或服务器错误

**验收标准**:
- WHEN 提供有效项目ID THEN 系统 SHALL 返回完整的项目详情
- WHEN 项目不存在 THEN 系统 SHALL 返回404错误
- WHEN 项目存在角色 THEN 系统 SHALL 返回每个角色的图片生成状态
- WHEN 项目存在场景 THEN 系统 SHALL 返回每个场景的图片生成状态
- WHEN 项目存在剧集 THEN 系统 SHALL 返回每个剧集的分镜列表

### 1.4 更新短剧项目

**功能描述**: 用户可以更新短剧项目的基本信息

**输入**:
- 项目ID (必填)
- 标题 (可选, 1-100字符)
- 描述 (可选)
- 类型 (可选)
- 标签 (可选)
- 状态 (可选, 必须是draft/planning/production/completed/archived之一)

**处理**:
1. 验证项目存在性
2. 验证输入数据有效性
3. 构建更新字段（只更新提供的字段）
4. 更新时间戳
5. 保存到数据库

**输出**:
- 成功: 返回更新后的项目信息
- 失败: 返回错误信息

**验收标准**:
- WHEN 提供有效项目ID和更新数据 THEN 系统 SHALL 更新相应字段
- WHEN 项目不存在 THEN 系统 SHALL 返回404错误
- WHEN 状态值无效 THEN 系统 SHALL 返回400错误
- WHEN 只提供部分字段 THEN 系统 SHALL 只更新提供的字段
- WHEN 更新成功 THEN 系统 SHALL 更新时间戳

### 1.5 删除短剧项目

**功能描述**: 用户可以删除短剧项目（软删除，保留数据）

**输入**:
- 项目ID (必填)

**处理**:
1. 执行软删除（设置DeletedAt）
2. 级联删除关联数据（GORM自动处理）

**输出**:
- 成功: 返回204 No Content
- 失败: 返回错误信息

**验收标准**:
- WHEN 提供有效项目ID THEN 系统 SHALL 执行软删除
- WHEN 项目不存在 THEN 系统 SHALL 返回404错误
- WHEN 删除成功 THEN 项目 SHALL 不再出现在列表查询中
- WHEN 删除成功 THEN 关联数据 SHALL 保留（软删除）

### 1.6 保存剧本大纲

**功能描述**: 用户可以保存短剧的大纲信息

**输入**:
- 项目ID (必填)
- 标题 (必填)
- 简介 (必填)
- 类型 (可选)
- 标签 (可选, 字符串数组)

**处理**:
1. 验证项目存在性
2. 更新项目标题和描述
3. 序列化标签为JSON
4. 保存到数据库

**输出**:
- 成功: 返回成功状态
- 失败: 返回错误信息

**验收标准**:
- WHEN 提供有效数据 THEN 系统 SHALL 更新项目大纲
- WHEN 提供标签数组 THEN 系统 SHALL 以JSON格式存储
- WHEN 项目不存在 THEN 系统 SHALL 返回404错误

### 1.7 保存分集信息

**功能描述**: 用户可以保存短剧的分集列表

**输入**:
- 项目ID (必填)
- 剧集数组 (必填)，每个剧集包含：
  - 剧集编号
  - 标题
  - 描述
  - 剧本内容
  - 时长

**处理**:
1. 验证项目存在性
2. 删除旧剧集
3. 创建新剧集记录
4. 更新项目时间戳

**输出**:
- 成功: 返回成功状态
- 失败: 返回错误信息

**验收标准**:
- WHEN 提供剧集列表 THEN 系统 SHALL 替换现有剧集
- WHEN 剧集包含剧本 THEN 系统 SHALL 支持长文本存储
- WHEN 创建剧集 THEN 剧集状态 SHALL 默认为"draft"
- WHEN 部分创建失败 THEN 系统 SHALL 继续处理其他剧集

### 1.8 获取项目统计

**功能描述**: 系统提供短剧项目的统计数据

**输入**: 无

**处理**:
1. 统计项目总数
2. 按状态分组统计

**输出**:
- 成功: 返回项目总数和各状态分布

**验收标准**:
- WHEN 请求统计数据 THEN 系统 SHALL 返回准确的项目总数
- WHEN 存在不同状态的项目 THEN 系统 SHALL 返回各状态数量

---

## 2. 角色管理功能

### 2.1 获取角色列表

**功能描述**: 用户可以获取短剧或剧集的角色列表

**输入**:
- 项目ID (必填)
- 剧集ID (可选)

**处理**:
1. 验证项目存在性
2. 如指定剧集ID，查询剧集关联的角色
3. 如未指定，查询项目的所有角色
4. 查询每个角色的图片生成状态

**输出**:
- 成功: 返回角色列表（包含生成状态）
- 失败: 返回错误信息

**验收标准**:
- WHEN 提供项目ID THEN 系统 SHALL 返回项目的所有角色
- WHEN 提供剧集ID THEN 系统 SHALL 返回该剧集关联的角色
- WHEN 角色存在生成任务 THEN 系统 SHALL 返回最新任务状态
- WHEN 剧集不存在 THEN 系统 SHALL 返回404错误

### 2.2 保存角色信息

**功能描述**: 用户可以批量保存角色信息，支持更新和创建

**输入**:
- 项目ID (必填)
- 角色数组 (必填)，每个角色包含：
  - ID (可选，存在则更新)
  - 名称 (必填)
  - 角色 (可选)
  - 描述 (可选)
  - 性格 (可选)
  - 外貌 (可选)
  - 图像URL (可选)
- 剧集ID (可选)

**处理**:
1. 验证项目存在性
2. 如指定剧集ID，验证剧集存在性
3. 获取项目现有角色
4. 对每个角色：
   - 如提供ID，更新现有角色
   - 如名称已存在，复用现有角色
   - 否则创建新角色
5. 如指定剧集ID，建立角色与剧集的关联

**输出**:
- 成功: 返回成功状态和创建的角色数量
- 失败: 返回错误信息

**验收标准**:
- WHEN 提供角色数组 THEN 系统 SHALL 批量保存角色
- WHEN 角色提供ID THEN 系统 SHALL 更新现有角色
- WHEN 角色名称已存在 THEN 系统 SHALL 复用现有角色
- WHEN 提供剧集ID THEN 系统 SHALL 建立角色与剧集关联
- WHEN 关联已存在 THEN 系统 SHALL 自动去重

### 2.3 AI生成角色图像

**功能描述**: 系统使用AI服务为角色生成肖像图像

**输入**:
- 角色ID (必填)
- AI配置参数（从系统配置获取）

**处理**:
1. 查询角色信息
2. 构建图像生成提示词（基于角色外貌、性格）
3. 调用AI图像服务
4. 创建ImageGeneration记录
5. 等待AI返回结果
6. 下载图像到本地
7. 更新角色记录和ImageGeneration记录

**输出**:
- 成功: 返回生成的图像URL
- 失败: 返回错误信息

**验收标准**:
- WHEN 请求生成角色图像 THEN 系统 SHALL 调用配置的AI服务
- WHEN 构建提示词 THEN 系统 SHALL 包含角色的外貌和性格特征
- WHEN AI返回图像 THEN 系统 SHALL 下载并存储到本地
- WHEN 生成成功 THEN 系统 SHALL 更新角色图像URL
- WHEN 生成失败 THEN 系统 SHALL 记录错误并允许重试

### 2.4 批量生成角色图像

**功能描述**: 用户可以批量为多个角色生成图像

**输入**:
- 角色ID数组 (必填)

**处理**:
1. 遍历角色ID数组
2. 为每个角色调用AI生成
3. 记录每个任务的进度
4. 汇总生成结果

**输出**:
- 成功: 返回批量任务状态和每个角色的生成结果
- 失败: 返回错误信息

**验收标准**:
- WHEN 选择多个角色 THEN 系统 SHALL 依次调用AI服务
- WHEN 批量任务进行中 THEN 系统 SHALL 提供进度查询
- WHEN 部分角色生成失败 THEN 系统 SHALL 继续处理其他角色
- WHEN 所有角色处理完成 THEN 系统 SHALL 返回详细结果

### 2.5 从角色库应用角色

**功能描述**: 用户可以从角色库中选择角色应用到当前项目

**输入**:
- 角色ID (必填)
- 角色库项ID (必填)

**处理**:
1. 查询角色库项
2. 更新角色的图像URL
3. 复制图像到项目目录

**输出**:
- 成功: 返回更新后的角色信息
- 失败: 返回错误信息

**验收标准**:
- WHEN 用户选择角色库项 THEN 系统 SHALL 复制图像到角色
- WHEN 复制成功 THEN 系统 SHALL 更新角色的本地路径
- WHEN 角色库项不存在 THEN 系统 SHALL 返回404错误

### 2.6 添加角色到角色库

**功能描述**: 用户可以将项目中的角色添加到全局角色库

**输入**:
- 角色ID (必填)
- 分类 (可选)
- 标签 (可选)

**处理**:
1. 查询角色信息
2. 创建CharacterLibrary记录
3. 复制图像到角色库目录

**输出**:
- 成功: 返回创建的角色库项
- 失败: 返回错误信息

**验收标准**:
- WHEN 添加角色到库 THEN 系统 SHALL 创建全局可复用的角色
- WHEN 角色图像不存在 THEN 系统 SHALL 返回错误
- WHEN 添加成功 THEN 系统 SHALL 返回角色库项ID

---

## 3. 场景管理功能

### 3.1 创建场景

**功能描述**: 用户可以为短剧或剧集创建拍摄场景

**输入**:
- 项目ID (必填)
- 剧集ID (可选)
- 地点 (必填, 200字符)
- 时间 (必填, 100字符)
- 提示词 (必填, 文本)
- 分镜数量 (可选, 默认1)

**处理**:
1. 验证项目存在性
2. 如指定剧集ID，验证剧集存在性
3. 创建Scene记录
4. 关联到项目或剧集

**输出**:
- 成功: 返回创建的场景信息
- 失败: 返回错误信息

**验收标准**:
- WHEN 提供场景信息 THEN 系统 SHALL 创建场景记录
- WHEN 场景关联剧集 THEN 系统 SHALL 建立外键关系
- WHEN 场景创建成功 THEN 状态 SHALL 默认为"pending"

### 3.2 更新场景

**功能描述**: 用户可以更新场景信息

**输入**:
- 场景ID (必填)
- 地点 (可选)
- 时间 (可选)
- 提示词 (可选)
- 分镜数量 (可选)

**处理**:
1. 验证场景存在性
2. 更新提供的字段
3. 更新时间戳

**输出**:
- 成功: 返回更新后的场景信息
- 失败: 返回错误信息

**验收标准**:
- WHEN 提供有效场景ID THEN 系统 SHALL 更新相应字段
- WHEN 只提供部分字段 THEN 系统 SHALL 只更新提供的字段
- WHEN 场景不存在 THEN 系统 SHALL 返回404错误

### 3.3 删除场景

**功能描述**: 用户可以删除场景

**输入**:
- 场景ID (必填)

**处理**:
1. 执行软删除
2. 清理关联的分镜引用

**输出**:
- 成功: 返回204 No Content
- 失败: 返回错误信息

**验收标准**:
- WHEN 删除场景 THEN 系统 SHALL 执行软删除
- WHEN 场景关联分镜 THEN 系统 SHALL 清理关联
- WHEN 场景不存在 THEN 系统 SHALL 返回404错误

### 3.4 生成场景图像

**功能描述**: 系统使用AI服务为场景生成背景图

**输入**:
- 场景ID (必填)
- AI配置参数

**处理**:
1. 查询场景信息
2. 使用场景提示词调用AI图像服务
3. 创建ImageGeneration记录
4. 等待AI返回
5. 下载图像到本地
6. 更新场景记录

**输出**:
- 成功: 返回生成的图像URL
- 失败: 返回错误信息

**验收标准**:
- WHEN 请求生成场景图像 THEN 系统 SHALL 使用场景提示词
- WHEN AI返回图像 THEN 系统 SHALL 更新场景状态为"generated"
- WHEN 生成失败 THEN 系统 SHALL 更新状态为"failed"并记录错误

---

## 4. 分镜管理功能

### 4.1 自动生成剧本分镜

**功能描述**: 系统自动从剧本解析生成完整分镜列表

**输入**:
- 剧集ID (必填)
- 剧本内容（从Episode获取）
- AI配置参数

**处理**:
1. 查询剧集和剧本
2. 调用AI文本服务解析剧本
3. 提取场景、角色、动作、对话等信息
4. 创建Scene记录（如不存在）
5. 创建Storyboard记录
6. 建立分镜与场景、角色的关联
7. 创建异步任务记录

**输出**:
- 成功: 返回任务ID，后台异步处理
- 失败: 返回错误信息

**验收标准**:
- WHEN 提交剧本 THEN 系统 SHALL 调用AI服务解析
- WHEN AI返回解析结果 THEN 系统 SHALL 创建分镜记录
- WHEN 分镜包含场景 THEN 系统 SHALL 关联或创建场景
- WHEN 分镜包含角色 THEN 系统 SHALL 建立多对多关联
- WHEN 解析成功 THEN 系统 SHALL 创建异步任务

### 4.2 创建分镜

**功能描述**: 用户可以手动创建分镜

**输入**:
- 剧集ID (必填)
- 分镜编号 (必填)
- 标题 (可选)
- 地点 (可选)
- 时间 (可选)
- 镜头类型 (可选)
- 角度 (可选)
- 运动 (可选)
- 动作 (可选)
- 结果 (可选)
- 氛围 (可选)
- 图像提示词 (可选)
- 视频提示词 (可选)
- 对话 (可选)
- 描述 (可选)
- 时长 (可选, 默认5秒)
- 场景ID (可选)
- 角色ID数组 (可选)
- 道具ID数组 (可选)

**处理**:
1. 验证剧集存在性
2. 创建Storyboard记录
3. 如提供场景ID，建立关联
4. 如提供角色ID，建立多对多关联
5. 如提供道具ID，建立多对多关联

**输出**:
- 成功: 返回创建的分镜信息
- 失败: 返回错误信息

**验收标准**:
- WHEN 提供分镜信息 THEN 系统 SHALL 创建分镜记录
- WHEN 关联场景 THEN 系统 SHALL 验证场景存在性
- WHEN 关联角色 THEN 系统 SHALL 建立多对多关系
- WHEN 关联道具 THEN 系统 SHALL 建立多对多关系
- WHEN 创建成功 THEN 状态 SHALL 默认为"pending"

### 4.3 更新分镜

**功能描述**: 用户可以更新分镜信息

**输入**:
- 分镜ID (必填)
- 其他所有字段（可选）

**处理**:
1. 验证分镜存在性
2. 更新提供的字段
3. 更新关联关系（如提供角色或道具ID）
4. 更新时间戳

**输出**:
- 成功: 返回更新后的分镜信息
- 失败: 返回错误信息

**验收标准**:
- WHEN 提供有效分镜ID THEN 系统 SHALL 更新相应字段
- WHEN 更新关联 THEN 系统 SHALL 替换现有关联
- WHEN 分镜不存在 THEN 系统 SHALL 返回404错误

### 4.4 删除分镜

**功能描述**: 用户可以删除分镜

**输入**:
- 分镜ID (必填)

**处理**:
1. 执行软删除
2. 清理关联关系

**输出**:
- 成功: 返回204 No Content
- 失败: 返回错误信息

**验收标准**:
- WHEN 删除分镜 THEN 系统 SHALL 执行软删除
- WHEN 删除成功 THEN 关联关系 SHALL 自动清理
- WHEN 分镜不存在 THEN 系统 SHALL 返回404错误

### 4.5 关联道具到分镜

**功能描述**: 用户可以将道具关联到分镜

**输入**:
- 分镜ID (必填)
- 道具ID数组 (必填)

**处理**:
1. 验证分镜存在性
2. 验证所有道具存在性
3. 建立多对多关联

**输出**:
- 成功: 返回更新后的分镜信息（包含道具）
- 失败: 返回错误信息

**验收标准**:
- WHEN 提供道具ID数组 THEN 系统 SHALL 建立分镜与道具的关联
- WHEN 道具不存在 THEN 系统 SHALL 返回404错误
- WHEN 关联已存在 THEN 系统 SHALL 自动去重

### 4.6 生成帧提示词

**功能描述**: 用户可以为分镜生成特定帧的提示词

**输入**:
- 分镜ID (必填)
- 帧类型 (必填: first/key/last/panel/action)
- 布局 (可选，仅panel/action类型)

**处理**:
1. 验证分镜存在性
2. 根据分镜信息构建提示词
3. 创建FramePrompt记录

**输出**:
- 成功: 返回创建的帧提示词
- 失败: 返回错误信息

**验收标准**:
- WHEN 生成帧提示词 THEN 系统 SHALL 基于分镜信息构建
- WHEN 帧类型为panel或action THEN 系统 SHALL 支持布局参数
- WHEN 生成成功 THEN 系统 SHALL 存储提示词和描述

### 4.7 查询分镜帧提示词

**功能描述**: 用户可以查询分镜的所有帧提示词

**输入**:
- 分镜ID (必填)

**处理**:
1. 验证分镜存在性
2. 查询所有关联的FramePrompt

**输出**:
- 成功: 返回帧提示词列表
- 失败: 返回错误信息

**验收标准**:
- WHEN 查询帧提示词 THEN 系统 SHALL 返回该分镜的所有帧
- WHEN 无帧提示词 THEN 系统 SHALL 返回空列表
- WHEN 分镜不存在 THEN 系统 SHALL 返回404错误

---

## 5. 道具管理功能

### 5.1 创建道具

**功能描述**: 用户可以为短剧创建道具

**输入**:
- 项目ID (必填)
- 名称 (必填, 100字符)
- 类型 (可选, 50字符)
- 描述 (可选, 文本)
- 提示词 (可选, 文本)

**处理**:
1. 验证项目存在性
2. 创建Prop记录

**输出**:
- 成功: 返回创建的道具信息
- 失败: 返回错误信息

**验收标准**:
- WHEN 提供道具信息 THEN 系统 SHALL 创建道具记录
- WHEN 项目不存在 THEN 系统 SHALL 返回404错误

### 5.2 更新道具

**功能描述**: 用户可以更新道具信息

**输入**:
- 道具ID (必填)
- 名称 (可选)
- 类型 (可选)
- 描述 (可选)
- 提示词 (可选)

**处理**:
1. 验证道具存在性
2. 更新提供的字段

**输出**:
- 成功: 返回更新后的道具信息
- 失败: 返回错误信息

**验收标准**:
- WHEN 提供有效道具ID THEN 系统 SHALL 更新相应字段
- WHEN 道具不存在 THEN 系统 SHALL 返回404错误

### 5.3 删除道具

**功能描述**: 用户可以删除道具

**输入**:
- 道具ID (必填)

**处理**:
1. 执行软删除
2. 清理关联关系

**输出**:
- 成功: 返回204 No Content
- 失败: 返回错误信息

**验收标准**:
- WHEN 删除道具 THEN 系统 SHALL 执行软删除
- WHEN 道具关联分镜 THEN 系统 SHALL 清理关联

### 5.4 生成道具图像

**功能描述**: 系统使用AI服务为道具生成图像

**输入**:
- 道具ID (必填)
- AI配置参数

**处理**:
1. 查询道具信息
2. 使用道具提示词调用AI图像服务
3. 创建ImageGeneration记录
4. 下载图像到本地
5. 更新道具记录

**输出**:
- 成功: 返回生成的图像URL
- 失败: 返回错误信息

**验收标准**:
- WHEN 请求生成道具图像 THEN 系统 SHALL 使用道具提示词
- WHEN 生成成功 THEN 系统 SHALL 更新道具图像URL

### 5.5 从剧本提取道具

**功能描述**: 系统自动从剧本中提取道具信息

**输入**:
- 剧集ID (必填)
- 剧本内容

**处理**:
1. 查询剧集剧本
2. 调用AI服务解析剧本中的道具
3. 创建Prop记录

**输出**:
- 成功: 返回提取的道具列表
- 失败: 返回错误信息

**验收标准**:
- WHEN 请求提取道具 THEN 系统 SHALL 调用AI服务解析剧本
- WHEN AI返回道具 THEN 系统 SHALL 创建道具记录
- WHEN 道具已存在 THEN 系统 SHALL 跳过重复项

---

## 6. 图像生成功能

### 6.1 生成图像

**功能描述**: 用户可以提交图像生成请求

**输入**:
- 提示词 (必填, 文本)
- 提供商 (可选, 默认从配置获取)
- 模型 (可选)
- 尺寸 (可选)
- 质量 (可选)
- 风格 (可选)
- 负面提示词 (可选)
- 步数 (可选)
- CFG比例 (可选)
- 种子 (可选)
- 关联ID（分镜ID/场景ID/角色ID/道具ID）
- 图像类型 (必填)

**处理**:
1. 创建ImageGeneration记录（状态:pending）
2. 调用AI图像服务
3. 更新状态为processing
4. 等待AI返回
5. 下载图像到本地
6. 更新状态为completed
7. 创建Asset记录

**输出**:
- 立即返回: 任务ID和初始状态
- 异步结果: 通过任务查询接口获取

**验收标准**:
- WHEN 提交生成请求 THEN 系统 SHALL 立即返回任务ID
- WHEN 任务创建 THEN 状态 SHALL 默认为pending
- WHEN AI开始处理 THEN 状态 SHALL 更新为processing
- WHEN 生成完成 THEN 状态 SHALL 更新为completed
- WHEN 生成失败 THEN 状态 SHALL 更新为failed并记录错误
- WHEN 生成成功 THEN 系统 SHALL 自动创建资产记录

### 6.2 查询图像生成任务

**功能描述**: 用户可以查询图像生成任务的状态和结果

**输入**:
- 生成ID (必填)

**处理**:
1. 查询ImageGeneration记录
2. 返回完整信息

**输出**:
- 成功: 返回生成任务详情（包含状态、URL、错误信息等）
- 失败: 返回错误信息

**验收标准**:
- WHEN 查询有效生成ID THEN 系统 SHALL 返回完整信息
- WHEN 生成ID不存在 THEN 系统 SHALL 返回404错误
- WHEN 任务进行中 THEN 系统 SHALL 返回当前进度

### 6.3 列表查询图像生成

**功能描述**: 用户可以查询图像生成记录列表

**输入**:
- 页码 (可选, 默认1)
- 每页数量 (可选, 默认20)
- 状态 (可选, 过滤条件)
- 类型 (可选, 过滤条件)
- 项目ID (可选)

**处理**:
1. 构建查询条件
2. 分页查询
3. 返回结果

**输出**:
- 成功: 返回图像生成列表和总数

**验收标准**:
- WHEN 请求列表 THEN 系统 SHALL 返回分页结果
- WHEN 提供过滤条件 THEN 系统 SHALL 应用过滤

### 6.4 删除图像生成记录

**功能描述**: 用户可以删除图像生成记录

**输入**:
- 生成ID (必填)

**处理**:
1. 执行软删除
2. 可选删除关联文件

**输出**:
- 成功: 返回204 No Content
- 失败: 返回错误信息

**验收标准**:
- WHEN 删除记录 THEN 系统 SHALL 执行软删除
- WHEN 记录不存在 THEN 系统 SHALL 返回404错误

### 6.5 批量生成剧集图像

**功能描述**: 用户可以批量生成剧集的所有图像（角色、场景、分镜）

**输入**:
- 剧集ID (必填)
- 类型 (可选: character/scene/storyboard/all)

**处理**:
1. 查询剧集的所有目标对象
2. 创建异步任务
3. 依次调用图像生成
4. 更新任务进度

**输出**:
- 立即返回: 任务ID
- 异步结果: 通过任务查询接口

**验收标准**:
- WHEN 请求批量生成 THEN 系统 SHALL 创建异步任务
- WHEN 任务进行中 THEN 系统 SHALL 提供进度查询
- WHEN 部分生成失败 THEN 系统 SHALL 继续处理其他项
- WHEN 任务完成 THEN 系统 SHALL 更新任务状态为completed

### 6.6 上传图像

**功能描述**: 用户可以上传图像作为生成结果

**输入**:
- 图像文件 (必填)
- 关联信息（分镜ID/场景ID/角色ID/道具ID）
- 图像类型 (必填)

**处理**:
1. 验证文件类型和大小
2. 保存文件到存储
3. 创建ImageGeneration记录（状态:completed）
4. 创建Asset记录
5. 更新关联对象

**输出**:
- 成功: 返回图像URL和记录信息
- 失败: 返回错误信息

**验收标准**:
- WHEN 上传有效图像 THEN 系统 SHALL 保存文件并创建记录
- WHEN 文件类型无效 THEN 系统 SHALL 返回400错误
- WHEN 文件过大 THEN 系统 SHALL 返回413错误
- WHEN 上传成功 THEN 系统 SHALL 自动创建资产记录

---

## 7. 视频生成功能

### 7.1 生成视频

**功能描述**: 用户可以提交视频生成请求

**输入**:
- 提示词 (必填, 文本)
- 提供商 (可选)
- 模型 (可选)
- 图像ID (可选，用于图生视频)
- 参考模式 (可选: single/first_last/multiple/none)
- 参考图像URLs (可选)
- 时长 (可选)
- FPS (可选)
- 分辨率 (可选)
- 宽高比 (可选)
- 风格 (可选)
- 运动级别 (可选)
- 相机运动 (可选)
- 种子 (可选)
- 关联分镜ID (可选)

**处理**:
1. 创建VideoGeneration记录（状态:pending）
2. 调用AI视频服务
3. 更新状态为processing
4. 等待AI返回
5. 下载视频到本地
6. 更新状态为completed
7. 创建Asset记录

**输出**:
- 立即返回: 任务ID和初始状态
- 异步结果: 通过任务查询接口

**验收标准**:
- WHEN 提交生成请求 THEN 系统 SHALL 立即返回任务ID
- WHEN 提供图像ID THEN 系统 SHALL 使用图生视频模式
- WHEN 提供参考图像 THEN 系统 SHALL 根据参考模式传递
- WHEN 任务创建 THEN 状态 SHALL 默认为pending
- WHEN AI开始处理 THEN 状态 SHALL 更新为processing
- WHEN 生成完成 THEN 状态 SHALL 更新为completed
- WHEN 生成失败 THEN 状态 SHALL 更新为failed并记录错误

### 7.2 从图像生成视频

**功能描述**: 用户可以从已有图像生成视频

**输入**:
- 图像生成ID (必填)
- 视频生成参数（同7.1）

**处理**:
1. 查询图像记录获取URL
2. 设置参考模式为single
3. 调用视频生成流程
4. 建立图像与视频的关联

**输出**:
- 成功: 返回任务ID
- 失败: 返回错误信息

**验收标准**:
- WHEN 提供图像ID THEN 系统 SHALL 使用该图像作为首帧
- WHEN 图像不存在 THEN 系统 SHALL 返回404错误
- WHEN 生成成功 THEN 系统 SHALL 建立图像与视频关联

### 7.3 查询视频生成任务

**功能描述**: 用户可以查询视频生成任务的状态和结果

**输入**:
- 生成ID (必填)

**处理**:
1. 查询VideoGeneration记录
2. 返回完整信息

**输出**:
- 成功: 返回生成任务详情
- 失败: 返回错误信息

**验收标准**:
- WHEN 查询有效生成ID THEN 系统 SHALL 返回完整信息
- WHEN 任务进行中 THEN 系统 SHALL 返回当前状态

### 7.4 批量生成剧集视频

**功能描述**: 用户可以批量生成剧集所有分镜的视频

**输入**:
- 剧集ID (必填)
- 视频参数（可选）

**处理**:
1. 查询剧集的所有分镜
2. 创建异步任务
3. 为每个分镜创建视频生成任务
4. 更新任务进度

**输出**:
- 立即返回: 任务ID
- 异步结果: 通过任务查询接口

**验收标准**:
- WHEN 请求批量生成 THEN 系统 SHALL 为每个分镜创建任务
- WHEN 任务进行中 THEN 系统 SHALL 提供进度查询
- WHEN 所有视频生成完成 THEN 系统 SHALL 更新任务状态

---

## 8. 视频合成功能

### 8.1 合并视频

**功能描述**: 系统将多个视频片段合并为一个完整视频

**输入**:
- 视频ID数组或分镜ID数组 (必填)
- 转场效果 (可选)
- 背景音乐 (可选)
- 输出文件名 (可选)

**处理**:
1. 验证所有视频存在性
2. 创建VideoMerge记录
3. 使用FFmpeg合并视频
4. 添加转场效果
5. 生成最终视频文件
6. 创建Asset记录

**输出**:
- 立即返回: 任务ID
- 异步结果: 合并后的视频URL

**验收标准**:
- WHEN 提供视频列表 THEN 系统 SHALL 使用FFmpeg合并
- WHEN 指定转场效果 THEN 系统 SHALL 添加过渡动画
- WHEN 合并完成 THEN 系统 SHALL 生成最终视频文件
- WHEN 合并失败 THEN 系统 SHALL 记录详细错误日志
- WHEN 合并成功 THEN 系统 SHALL 自动创建资产记录

### 8.2 查询合并任务

**功能描述**: 用户可以查询视频合并任务的状态

**输入**:
- 合并ID (必填)

**处理**:
1. 查询合并记录
2. 返回状态和结果

**输出**:
- 成功: 返回合并任务详情
- 失败: 返回错误信息

**验收标准**:
- WHEN 查询合并任务 THEN 系统 SHALL 返回当前状态
- WHEN 合并进行中 THEN 系统 SHALL 返回处理进度

### 8.3 提取音频

**功能描述**: 系统可以从视频提取音频

**输入**:
- 视频文件路径或URL (必填)
- 输出格式 (可选, 默认mp3)

**处理**:
1. 验证视频文件存在
2. 使用FFmpeg提取音轨
3. 保存音频文件
4. 创建Asset记录

**输出**:
- 成功: 返回音频URL
- 失败: 返回错误信息

**验收标准**:
- WHEN 请求提取音频 THEN 系统 SHALL 使用FFmpeg提取
- WHEN 指定格式 THEN 系统 SHALL 转换为相应格式
- WHEN 提取成功 THEN 系统 SHALL 返回音频文件URL
- WHEN 支持批量 THEN 系统 SHALL 处理多个视频文件

---

## 9. AI配置管理功能

### 9.1 创建AI服务配置

**功能描述**: 用户可以配置AI服务提供商

**输入**:
- 服务类型 (必填: text/image/video)
- 提供商 (可选)
- 名称 (必填)
- 基础URL (必填)
- API密钥 (必填)
- 模型 (可选，支持字符串或字符串数组)
- 端点 (可选)
- 查询端点 (可选)
- 优先级 (可选, 默认0)
- 是否默认 (可选, 默认false)
- 是否激活 (可选, 默认true)
- 设置 (可选, JSON文本)

**处理**:
1. 验证输入数据
2. 如标记为默认，取消其他配置的默认标记
3. 创建AIServiceConfig记录

**输出**:
- 成功: 返回创建的配置信息（脱敏API密钥）
- 失败: 返回错误信息

**验收标准**:
- WHEN 提供有效配置 THEN 系统 SHALL 创建配置记录
- WHEN 标记为默认 THEN 系统 SHALL 确保只有一个默认配置
- WHEN API密钥存储 THEN 系统 SHALL 加密存储
- WHEN 返回配置 THEN 系统 SHALL 脱敏处理API密钥

### 9.2 更新AI服务配置

**功能描述**: 用户可以更新AI服务配置

**输入**:
- 配置ID (必填)
- 其他所有字段（可选）

**处理**:
1. 验证配置存在性
2. 如更新默认标记，处理其他配置的默认状态
3. 更新提供的字段

**输出**:
- 成功: 返回更新后的配置信息
- 失败: 返回错误信息

**验收标准**:
- WHEN 提供有效配置ID THEN 系统 SHALL 更新相应字段
- WHEN 更新默认标记 THEN 系统 SHALL 自动处理其他配置
- WHEN 配置不存在 THEN 系统 SHALL 返回404错误

### 9.3 删除AI服务配置

**功能描述**: 用户可以删除AI服务配置

**输入**:
- 配置ID (必填)

**处理**:
1. 验证配置存在性
2. 执行删除（硬删除，因为不包含业务数据）

**输出**:
- 成功: 返回204 No Content
- 失败: 返回错误信息

**验收标准**:
- WHEN 删除配置 THEN 系统 SHALL 执行硬删除
- WHEN 是唯一的默认配置 THEN 系统 SHALL 警告用户

### 9.4 测试AI服务连接

**功能描述**: 用户可以测试AI服务配置的连接

**输入**:
- 配置信息（同创建输入）

**处理**:
1. 使用配置信息调用AI服务健康检查
2. 验证API密钥有效性
3. 返回测试结果

**输出**:
- 成功: 返回连接成功状态
- 失败: 返回详细错误信息

**验收标准**:
- WHEN 请求测试 THEN 系统 SHALL 调用AI服务接口
- WHEN 连接成功 THEN 系统 SHALL 返回成功状态
- WHEN 密钥无效 THEN 系统 SHALL 返回认证错误
- WHEN 网络异常 THEN 系统 SHALL 返回连接错误

### 9.5 查询AI服务配置列表

**功能描述**: 用户可以查询所有AI服务配置

**输入**:
- 服务类型 (可选, 过滤条件)
- 提供商 (可选, 过滤条件)
- 是否激活 (可选, 过滤条件)

**处理**:
1. 构建查询条件
2. 查询配置列表
3. 脱敏处理API密钥

**输出**:
- 成功: 返回配置列表（脱敏）

**验收标准**:
- WHEN 查询配置列表 THEN 系统 SHALL 返回脱敏的配置信息
- WHEN 提供过滤条件 THEN 系统 SHALL 应用过滤

---

## 10. 资产管理功能

### 10.1 创建资产

**功能描述**: 用户可以手动创建资产记录

**输入**:
- 名称 (必填)
- 类型 (必填: image/video/audio)
- URL (必填)
- 项目ID (可选)
- 剧集ID (可选)
- 分镜ID (可选)
- 描述 (可选)
- 分类 (可选)
- 缩略图URL (可选)
- 本地路径 (可选)
- 文件大小 (可选)
- MIME类型 (可选)
- 尺寸 (可选)
- 时长 (可选)
- 格式 (可选)

**处理**:
1. 验证必填字段
2. 创建Asset记录

**输出**:
- 成功: 返回创建的资产信息
- 失败: 返回错误信息

**验收标准**:
- WHEN 提供资产信息 THEN 系统 SHALL 创建资产记录
- WHEN 类型无效 THEN 系统 SHALL 返回400错误

### 10.2 从图像生成导入资产

**功能描述**: 系统可以从图像生成记录自动创建资产

**输入**:
- 图像生成ID (必填)

**处理**:
1. 查询图像生成记录
2. 复制信息创建Asset记录
3. 建立关联关系

**输出**:
- 成功: 返回创建的资产信息
- 失败: 返回错误信息

**验收标准**:
- WHEN 导入图像 THEN 系统 SHALL 复制信息创建资产
- WHEN 图像不存在 THEN 系统 SHALL 返回404错误
- WHEN 资产已存在 THEN 系统 SHALL 返回已有资产

### 10.3 从视频生成导入资产

**功能描述**: 系统可以从视频生成记录自动创建资产

**输入**:
- 视频生成ID (必填)

**处理**:
1. 查询视频生成记录
2. 复制信息创建Asset记录
3. 建立关联关系

**输出**:
- 成功: 返回创建的资产信息
- 失败: 返回错误信息

**验收标准**:
- WHEN 导入视频 THEN 系统 SHALL 复制信息创建资产
- WHEN 视频不存在 THEN 系统 SHALL 返回404错误

### 10.4 查询资产列表

**功能描述**: 用户可以查询资产列表

**输入**:
- 页码 (可选)
- 每页数量 (可选)
- 类型 (可选)
- 项目ID (可选)
- 剧集ID (可选)
- 分类 (可选)
- 是否收藏 (可选)

**处理**:
1. 构建查询条件
2. 分页查询
3. 返回结果

**输出**:
- 成功: 返回资产列表和总数

**验收标准**:
- WHEN 请求资产列表 THEN 系统 SHALL 返回分页结果
- WHEN 提供过滤条件 THEN 系统 SHALL 应用过滤
- WHEN 资产有关联 THEN 系统 SHALL 返回关联信息

### 10.5 更新资产

**功能描述**: 用户可以更新资产信息

**输入**:
- 资产ID (必填)
- 名称 (可选)
- 描述 (可选)
- 分类 (可选)
- 是否收藏 (可选)

**处理**:
1. 验证资产存在性
2. 更新提供的字段

**输出**:
- 成功: 返回更新后的资产信息
- 失败: 返回错误信息

**验收标准**:
- WHEN 提供有效资产ID THEN 系统 SHALL 更新相应字段
- WHEN 资产不存在 THEN 系统 SHALL 返回404错误

### 10.6 删除资产

**功能描述**: 用户可以删除资产

**输入**:
- 资产ID (必填)
- 是否删除文件 (可选, 默认false)

**处理**:
1. 验证资产存在性
2. 如指定删除文件，删除物理文件
3. 执行软删除

**输出**:
- 成功: 返回204 No Content
- 失败: 返回错误信息

**验收标准**:
- WHEN 删除资产 THEN 系统 SHALL 执行软删除
- WHEN 指定删除文件 THEN 系统 SHALL 删除物理文件
- WHEN 资产不存在 THEN 系统 SHALL 返回404错误

---

## 11. 任务管理功能

### 11.1 查询任务状态

**功能描述**: 用户可以查询异步任务的执行状态

**输入**:
- 任务ID (必填)

**处理**:
1. 查询AsyncTask记录
2. 返回完整信息

**输出**:
- 成功: 返回任务详情（状态、进度、消息、错误、结果）
- 失败: 返回错误信息

**验收标准**:
- WHEN 查询有效任务ID THEN 系统 SHALL 返回完整任务信息
- WHEN 任务不存在 THEN 系统 SHALL 返回404错误
- WHEN 任务进行中 THEN 系统 SHALL 返回当前进度（0-100）
- WHEN 任务完成 THEN 系统 SHALL 返回完成时间和结果
- WHEN 任务失败 THEN 系统 SHALL 返回错误信息

### 11.2 查询资源任务列表

**功能描述**: 用户可以查询特定资源的任务列表

**输入**:
- 资源ID (可选)
- 资源类型 (可选)
- 页码 (可选)
- 每页数量 (可选)

**处理**:
1. 构建查询条件
2. 分页查询任务列表

**输出**:
- 成功: 返回任务列表

**验收标准**:
- WHEN 提供资源ID THEN 系统 SHALL 返回该资源的所有任务
- WHEN 无资源ID THEN 系统 SHALL 返回所有任务
- WHEN 提供类型 THEN 系统 SHALL 按类型过滤

---

## 12. 文件上传功能

### 12.1 上传图像文件

**功能描述**: 用户可以上传图像文件

**输入**:
- 图像文件 (必填)
- 保存路径 (可选)

**处理**:
1. 验证文件类型（jpg, jpeg, png, gif, webp）
2. 验证文件大小（最大10MB）
3. 生成唯一文件名
4. 保存到存储目录
5. 返回文件URL

**输出**:
- 成功: 返回文件URL和本地路径
- 失败: 返回错误信息

**验收标准**:
- WHEN 上传有效图像 THEN 系统 SHALL 保存文件
- WHEN 文件类型无效 THEN 系统 SHALL 返回415错误
- WHEN 文件过大 THEN 系统 SHALL 返回413错误
- WHEN 保存成功 THEN 系统 SHALL 返回可访问URL

### 12.2 上传角色图像

**功能描述**: 用户可以为角色上传自定义图像

**输入**:
- 角色ID (必填)
- 图像文件 (必填)

**处理**:
1. 验证角色存在性
2. 调用文件上传功能
3. 更新角色图像URL

**输出**:
- 成功: 返回更新后的角色信息
- 失败: 返回错误信息

**验收标准**:
- WHEN 上传角色图像 THEN 系统 SHALL 保存并更新角色
- WHEN 角色不存在 THEN 系统 SHALL 返回404错误
- WHEN 上传成功 THEN 系统 SHALL 返回角色新图像URL

---

## 13. 系统设置功能

### 13.1 获取语言设置

**功能描述**: 用户可以获取当前系统语言

**输入**: 无

**处理**:
1. 从配置文件读取语言设置

**输出**:
- 成功: 返回当前语言代码（zh/en）

**验收标准**:
- WHEN 请求语言设置 THEN 系统 SHALL 返回当前语言

### 13.2 更新语言设置

**功能描述**: 用户可以更新系统语言

**输入**:
- 语言代码 (必填: zh/en)

**处理**:
1. 验证语言代码有效性
2. 更新配置文件
3. 重新加载语言包

**输出**:
- 成功: 返回更新后的语言
- 失败: 返回错误信息

**验收标准**:
- WHEN 提供有效语言代码 THEN 系统 SHALL 更新配置
- WHEN 语言代码无效 THEN 系统 SHALL 返回400错误
- WHEN 更新成功 THEN 系统 SHALL 立即生效

---

## 14. 角色库功能

### 14.1 查询角色库列表

**功能描述**: 用户可以查询全局角色库

**输入**:
- 页码 (可选)
- 每页数量 (可选)
- 分类 (可选)
- 关键词 (可选)

**处理**:
1. 构建查询条件
2. 分页查询角色库

**输出**:
- 成功: 返回角色库列表

**验收标准**:
- WHEN 请求角色库列表 THEN 系统 SHALL 返回全局可复用角色
- WHEN 提供分类 THEN 系统 SHALL 按分类过滤
- WHEN 提供关键词 THEN 系统 SHALL 搜索名称和描述

### 14.2 创建角色库项

**功能描述**: 用户可以创建角色库项

**输入**:
- 名称 (必填)
- 图像URL (必填)
- 分类 (可选)
- 描述 (可选)
- 标签 (可选)
- 来源类型 (可选: generated/uploaded)

**处理**:
1. 验证必填字段
2. 创建CharacterLibrary记录

**输出**:
- 成功: 返回创建的角色库项
- 失败: 返回错误信息

**验收标准**:
- WHEN 提供角色信息 THEN 系统 SHALL 创建角色库项
- WHEN 图像URL无效 THEN 系统 SHALL 返回400错误

### 14.3 删除角色库项

**功能描述**: 用户可以删除角色库项

**输入**:
- 角色库项ID (必填)

**处理**:
1. 验证角色库项存在性
2. 执行软删除

**输出**:
- 成功: 返回204 No Content
- 失败: 返回错误信息

**验收标准**:
- WHEN 删除角色库项 THEN 系统 SHALL 执行软删除
- WHEN 角色库项不存在 THEN 系统 SHALL 返回404错误

---

## 验收标准汇总表

| 功能模块 | 功能ID | EARS格式验收标准 |
|---------|--------|-----------------|
| 短剧管理 | FR-DM-001 | WHEN 用户提交有效项目信息 THEN 系统 SHALL 创建新项目 |
| 短剧管理 | FR-DM-002 | WHEN 用户请求项目列表 THEN 系统 SHALL 返回分页结果 |
| 角色管理 | FR-CM-001 | WHEN 用户创建角色 THEN 系统 SHALL 存储名称、角色、描述等 |
| 角色管理 | FR-CM-002 | WHEN 用户请求生成角色图像 THEN 系统 SHALL 调用AI服务 |
| 场景管理 | FR-SM-001 | WHEN 用户创建场景 THEN 系统 SHALL 存储地点、时间、提示词 |
| 场景管理 | FR-SM-002 | WHEN 用户请求生成场景图像 THEN 系统 SHALL 使用场景提示词 |
| 分镜管理 | FR-SB-001 | WHEN 用户提交剧本 THEN 系统 SHALL 调用AI服务解析 |
| 分镜管理 | FR-SB-002 | WHEN 用户创建分镜 THEN 系统 SHALL 存储编号、标题、镜头类型等 |
| 图像生成 | FR-IG-001 | WHEN 用户提交生成请求 THEN 系统 SHALL 创建pending状态任务 |
| 图像生成 | FR-IG-002 | WHEN AI服务开始处理 THEN 系统 SHALL 更新为processing状态 |
| 视频生成 | FR-VG-001 | WHEN 用户提交视频生成请求 THEN 系统 SHALL 创建任务记录 |
| 视频生成 | FR-VG-002 | WHEN 用户提供参考图像 THEN 系统 SHALL 支持多种参考模式 |
| 视频合成 | FR-VM-001 | WHEN 用户选择多个视频 THEN 系统 SHALL 使用FFmpeg合并 |
| AI配置 | FR-AI-001 | WHEN 用户创建配置 THEN 系统 SHALL 加密存储API密钥 |
| 资产管理 | FR-AM-001 | WHEN 图像生成完成 THEN 系统 SHALL 自动创建资产记录 |
| 任务管理 | FR-TM-001 | WHEN 创建异步任务 THEN 系统 SHALL 生成唯一任务ID |
| 角色库 | FR-CL-001 | WHEN 用户查询角色库 THEN 系统 SHALL 返回全局可复用角色 |

---

**文档结束**
