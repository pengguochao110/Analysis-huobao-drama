# 业务规则说明书

## 火宝短剧 (Huobao Drama) AI短剧生成平台

**版本**: v1.0  
**日期**: 2025-02-03  
**状态**: 草案  

---

## 1. 业务逻辑约束

### 1.1 短剧项目约束

#### BR-DM-001 项目生命周期规则

**规则描述**: 短剧项目必须遵循预定义的状态流转

**状态定义**:
```
draft (草稿)
  ↓ [用户开始策划]
planning (策划中)
  ↓ [完成大纲编写]
production (制作中)
  ↓ [所有剧集完成]
completed (已完成)
  ↓ [用户归档]
archived (已归档)
```

**EARS验收标准**:
- WHEN 项目创建 THEN 项目状态 SHALL 自动设为"draft"
- WHEN 用户开始编辑 THEN 状态 SHALL 可更新为"planning"
- WHEN 用户开始生成分镜 THEN 状态 SHALL 自动更新为"production"
- WHEN 所有剧集完成 THEN 状态 SHALL 自动更新为"completed"
- WHEN 用户手动归档 THEN 状态 SHALL 更新为"archived"
- WHEN 项目已归档 THEN 系统 SHALL 禁止修改项目内容

**约束说明**:
- 状态只能按顺序正向流转
- "archived"状态可以手动恢复到"completed"
- 删除操作不检查状态（软删除）

#### BR-DM-002 项目唯一性规则

**规则描述**: 项目标题在同一用户空间内应唯一（可选约束）

**EARS验收标准**:
- WHEN 创建项目 THEN 系统 SHOULD 检查标题是否已存在
- WHEN 标题已存在 THEN 系统 SHOULD 警告用户
- WHEN 用户确认 THEN 系统 SHALL 允许重复标题
- WHEN 项目被删除 THEN 其标题 SHALL 可被新项目使用

**业务说明**:
- 不强制唯一性（允许同名项目）
- 建议在UI层提示用户
- 通过ID区分同名项目

### 1.2 角色管理约束

#### BR-CM-001 角色唯一性规则

**规则描述**: 角色名称在同一项目内必须唯一

**EARS验收标准**:
- WHEN 创建角色 THEN 系统 SHALL 检查项目名称是否已存在
- WHEN 名称已存在 THEN 系统 SHALL 提示用户选择：更新现有角色或修改名称
- WHEN 用户选择更新 THEN 系统 SHALL 更新现有角色信息
- WHEN 用户修改名称 THEN 系统 SHALL 创建新角色
- WHEN 角色被软删除 THEN 其名称 SHALL 可被新角色使用

**业务说明**:
- 防止同一项目中出现同名角色造成混淆
- 更新现有角色时保留ID和历史记录
- 支持角色信息的增量更新

#### BR-CM-002 角色图像生成规则

**规则描述**: 角色图像生成遵循特定提示词构建逻辑

**EARS验收标准**:
- WHEN 请求生成角色图像 THEN 系统 SHALL 基于角色信息构建提示词
- WHEN 角色有外貌描述 THEN 提示词 SHALL 包含外貌特征
- WHEN 角色有性格描述 THEN 提示词 SHALL 包含性格特征
- WHEN 角色有风格设置 THEN 提示词 SHALL 包含风格关键词
- WHEN 生成完成 THEN 系统 SHALL 保存种子值用于后续一致性生成
- WHEN 重新生成 THEN 系统 SHOULD 使用相同种子值保持角色一致性

**提示词构建模板**:
```
角色肖像, [外貌描述], [性格特征], [风格], 高质量, 细节丰富, 
正面照, 半身像, 专业摄影, 8k分辨率
```

#### BR-CM-003 角色与剧集关联规则

**规则描述**: 角色与剧集的关联关系管理

**EARS验收标准**:
- WHEN 角色关联到剧集 THEN 系统 SHALL 建立多对多关系
- WHEN 角色已关联 THEN 再次关联 SHALL 自动去重
- WHEN 剧集删除 THEN 关联关系 SHALL 自动清理
- WHEN 角色删除 THEN 关联关系 SHALL 自动清理
- WHEN 查看剧集 THEN 系统 SHALL 显示所有关联角色
- WHEN 查看角色 THEN 系统 SHALL 显示角色出场的所有剧集

### 1.3 剧集管理约束

#### BR-EP-001 剧集编号规则

**规则描述**: 剧集编号在同一项目内必须唯一且连续

**EARS验收标准**:
- WHEN 创建剧集 THEN 系统 SHALL 自动分配递增编号
- WHEN 手动设置编号 THEN 系统 SHALL 检查唯一性
- WHEN 编号冲突 THEN 系统 SHALL 返回错误
- WHEN 删除剧集 THEN 后续剧集编号 SHALL 保持不变
- WHEN 插入剧集 THEN 新剧集 SHALL 使用指定编号，后续顺延

**编号规则**:
- 起始编号: 1
- 增量: 1
- 格式: 整数
- 最大: 999（可根据需求调整）

#### BR-EP-002 剧集状态流转规则

**规则描述**: 剧集状态反映制作进度

**状态定义**:
```
draft (草稿)
  ↓ [剧本编辑完成]
script_ready (剧本就绪)
  ↓ [分镜解析完成]
storyboard_ready (分镜就绪)
  ↓ [图像生成完成]
images_ready (图像就绪)
  ↓ [视频生成完成]
videos_ready (视频就绪)
  ↓ [视频合成完成]
completed (已完成)
```

**EARS验收标准**:
- WHEN 剧集创建 THEN 状态 SHALL 为"draft"
- WHEN 剧本保存 THEN 状态 SHALL 更新为"script_ready"
- WHEN 分镜解析完成 THEN 状态 SHALL 更新为"storyboard_ready"
- WHEN 所有分镜图像生成 THEN 状态 SHALL 更新为"images_ready"
- WHEN 所有分镜视频生成 THEN 状态 SHALL 更新为"videos_ready"
- WHEN 视频合成完成 THEN 状态 SHALL 更新为"completed"
- WHEN 手动修改状态 THEN 系统 SHOULD 记录原因

#### BR-EP-003 剧集时长计算规则

**规则描述**: 剧集总时长自动计算

**EARS验收标准**:
- WHEN 剧集有分镜 THEN 时长 SHALL 等于所有分镜时长之和
- WHEN 分镜时长修改 THEN 剧集时长 SHALL 自动重新计算
- WHEN 分镜增删 THEN 剧集时长 SHALL 自动更新
- WHEN 显示时长 THEN 系统 SHALL 格式化为"X分Y秒"或"X分钟"
- WHEN 存储时长 THEN 系统 SHALL 存储为秒整数

**计算公式**:
```
剧集时长(秒) = Σ(分镜时长)
剧集时长(分钟) = 剧集时长(秒) / 60，向上取整
```

### 1.4 场景管理约束

#### BR-SC-001 场景复用规则

**规则描述**: 相同地点和时间的场景可以复用

**EARS验收标准**:
- WHEN 创建场景 THEN 系统 SHALL 检查(项目ID, 地点, 时间)是否已存在
- WHEN 场景已存在 THEN 系统 SHOULD 提示用户复用或创建新场景
- WHEN 用户选择复用 THEN 系统 SHALL 关联现有场景
- WHEN 创建新场景 THEN 系统 SHALL 允许相同地点时间（添加序号区分）
- WHEN 场景关联多个分镜 THEN 修改场景 SHALL 影响所有关联分镜

**场景标识**:
- 唯一键: (DramaID, Location, Time)
- 重复处理: 允许添加序号区分，如"咖啡厅-傍晚-2"

#### BR-SC-002 场景图像生成规则

**规则描述**: 场景图像基于场景提示词生成

**EARS验收标准**:
- WHEN 请求生成场景图像 THEN 系统 SHALL 使用Scene.Prompt
- WHEN 场景有风格设置 THEN 提示词 SHALL 包含风格关键词
- WHEN 生成完成 THEN 系统 SHALL 更新Scene.Status为"generated"
- WHEN 生成失败 THEN 系统 SHALL 更新Scene.Status为"failed"并记录错误
- WHEN 场景图像存在 THEN 用户 SHOULD 确认后再重新生成

**提示词构建**:
```
场景: [地点], 时间: [时间], [场景描述], 
[风格], 高质量, 细节丰富, 环境光, 电影感, 8k
```

### 1.5 分镜管理约束

#### BR-SB-001 分镜编号规则

**规则描述**: 分镜编号在剧集内必须唯一且连续

**EARS验收标准**:
- WHEN 解析剧本生成分镜 THEN 系统 SHALL 自动分配连续编号(1, 2, 3...)
- WHEN 手动创建分镜 THEN 系统 SHALL 检查编号唯一性
- WHEN 编号冲突 THEN 系统 SHALL 返回错误
- WHEN 删除分镜 THEN 系统 SHOULD 重新编号（可选）
- WHEN 插入分镜 THEN 用户 SHALL 指定编号，系统 SHALL 调整后序分镜
- WHEN 调整分镜顺序 THEN 系统 SHALL 重新分配编号保持连续

**编号规则**:
- 格式: 正整数
- 起始: 1
- 连续: 是
- 最大值: 9999

#### BR-SB-002 分镜图像生成提示词规则

**规则描述**: 分镜图像提示词由多个元素组合构建

**EARS验收标准**:
- WHEN 生成分镜图像 THEN 系统 SHALL 组合以下元素：
  - 场景描述（来自Scene）
  - 角色描述（来自关联的Characters）
  - 分镜镜头信息（ShotType, Angle, Movement）
  - 动作描述（Action）
  - 氛围描述（Atmosphere）
- WHEN 分镜有关联道具 THEN 提示词 SHALL 包含道具描述
- WHEN 分镜有风格设置 THEN 提示词 SHALL 包含风格关键词
- WHEN 提示词过长 THEN 系统 SHALL 智能截断或分优先级保留

**提示词构建模板**:
```
场景: [Scene.Location], 时间: [Scene.Time], [Scene.Description]
角色: [Character.Name] - [Character.Appearance]
镜头: [ShotType], [Angle], [Movement]
动作: [Action]
氛围: [Atmosphere]
风格: [Style], 高质量, 电影感, 8k分辨率
```

#### BR-SB-003 分镜时长规则

**规则描述**: 分镜时长默认5秒，可手动调整

**EARS验收标准**:
- WHEN 创建分镜 THEN 默认时长 SHALL 为5秒
- WHEN 解析剧本 THEN 系统 SHOULD 根据对话长度估算时长
- WHEN 用户修改时长 THEN 范围 SHALL 为1-300秒
- WHEN 时长超出范围 THEN 系统 SHALL 自动修正为边界值
- WHEN 分镜用于视频合成 THEN 时长 SHALL 决定视频片段长度

**时长估算**（剧本解析时）:
- 基础: 3秒
- 对话: 每100字符 +2秒
- 动作: 复杂动作 +3秒
- 最大: 30秒（可根据需求调整）

#### BR-SB-004 分镜关联规则

**规则描述**: 分镜与角色、道具、场景的关联关系

**EARS验收标准**:
- WHEN 分镜关联角色 THEN 系统 SHALL 建立多对多关系
- WHEN 分镜关联道具 THEN 系统 SHALL 建立多对多关系
- WHEN 分镜关联场景 THEN 系统 SHALL 建立外键关联
- WHEN 分镜没有关联场景 THEN 系统 SHALL 允许（可选）
- WHEN 删除关联的角色/道具/场景 THEN 关联关系 SHALL 自动清理
- WHEN 查看分镜 THEN 系统 SHALL 显示所有关联资源

### 1.6 道具管理约束

#### BR-PR-001 道具自动提取规则

**规则描述**: 系统可以从剧本自动提取道具

**EARS验收标准**:
- WHEN 用户请求提取道具 THEN 系统 SHALL 调用AI服务解析剧本
- WHEN AI返回道具列表 THEN 系统 SHALL 检查是否已存在
- WHEN 道具不存在 THEN 系统 SHALL 创建新道具
- WHEN 道具已存在 THEN 系统 SHALL 复用现有道具
- WHEN 提取完成 THEN 系统 SHALL 显示提取的道具列表供用户确认
- WHEN 用户确认 THEN 系统 SHALL 正式创建道具记录

**提取策略**:
- 使用AI服务识别剧本中的物品名词
- 过滤常见词汇（如"手机"保留，"椅子"根据上下文判断）
- 去重处理

#### BR-PR-002 道具关联规则

**规则描述**: 道具与分镜的关联关系

**EARS验收标准**:
- WHEN 道具关联分镜 THEN 系统 SHALL 建立多对多关系
- WHEN 一个道具关联多个分镜 THEN 系统 SHALL 允许
- WHEN 一个分镜关联多个道具 THEN 系统 SHALL 允许
- WHEN 道具没有关联分镜 THEN 系统 SHALL 保留道具记录
- WHEN 删除道具 THEN 关联关系 SHALL 自动清理

### 1.7 AI服务约束

#### BR-AI-001 AI配置唯一性规则

**规则描述**: AI服务配置的管理规则

**EARS验收标准**:
- WHEN 创建AI配置 THEN 配置名称 SHALL 唯一
- WHEN 标记为默认 THEN 同类型其他配置的默认标记 SHALL 自动取消
- WHEN 存在多个激活配置 THEN 系统 SHALL 按优先级选择
- WHEN 默认配置不可用时 THEN 系统 SHOULD 自动切换到其他激活配置
- WHEN 所有配置都不可用时 THEN 系统 SHALL 返回服务不可用错误

**配置优先级**:
1. IsDefault = true 的配置
2. Priority 数值最高的配置
3. 创建时间最新的配置

#### BR-AI-002 AI服务调用规则

**规则描述**: AI服务调用的业务逻辑

**EARS验收标准**:
- WHEN 调用AI服务 THEN 系统 SHALL 记录调用日志
- WHEN 调用超时 THEN 系统 SHALL 重试最多3次
- WHEN 调用失败 THEN 系统 SHALL 记录详细错误信息
- WHEN 连续失败3次 THEN 系统 SHALL 暂停该配置的使用
- WHEN 服务恢复 THEN 系统 SHOULD 自动重新激活
- WHEN API密钥无效 THEN 系统 SHALL 立即标记配置为异常

**重试策略**:
- 重试次数: 3次
- 间隔: 5秒，指数退避
- 超时: 文本60秒，图像180秒，视频600秒

### 1.8 生成任务约束

#### BR-IG-001 图像生成任务规则

**规则描述**: AI图像生成任务的管理

**EARS验收标准**:
- WHEN 提交生成任务 THEN 系统 SHALL 立即返回任务ID
- WHEN 任务创建 THEN 初始状态 SHALL 为"pending"
- WHEN 开始处理 THEN 状态 SHALL 更新为"processing"
- WHEN 处理完成 THEN 状态 SHALL 更新为"completed"
- WHEN 处理失败 THEN 状态 SHALL 更新为"failed"并记录错误
- WHEN 任务失败 THEN 用户 SHALL 可以重试
- WHEN 重试任务 THEN 系统 SHALL 保留失败记录供参考

**状态流转**:
```
pending → processing → completed
                ↓
              failed → [重试] → processing
```

#### BR-IG-002 批量生成规则

**规则描述**: 批量生成任务的执行逻辑

**EARS验收标准**:
- WHEN 提交批量生成 THEN 系统 SHALL 创建异步任务
- WHEN 批量任务执行 THEN 系统 SHALL 限制并发数（图像10个，视频3个）
- WHEN 任务队列满 THEN 系统 SHALL 将任务放入队列等待
- WHEN 任务完成 THEN 系统 SHALL 自动从队列获取下一个任务
- WHEN 部分任务失败 THEN 系统 SHALL 继续执行其他任务
- WHEN 所有任务完成 THEN 系统 SHALL 发送通知

**队列配置**:
- 图像并发: 10
- 视频并发: 3
- 图像队列长度: 100
- 视频队列长度: 50

#### BR-VG-001 视频生成参数规则

**规则描述**: 视频生成的参数约束

**EARS验收标准**:
- WHEN 生成视频 THEN 时长 SHALL 范围1-10秒
- WHEN 超出时长范围 THEN 系统 SHALL 返回参数错误
- WHEN 设置分辨率 THEN 系统 SHALL 验证格式（如1080x1920）
- WHEN 设置宽高比 THEN 系统 SHALL 支持9:16, 16:9, 1:1
- WHEN 提供参考图像 THEN 系统 SHALL 验证图像存在且可访问
- WHEN 参考模式为first_last THEN 系统 SHALL 要求提供两张图像

### 1.9 视频合成约束

#### BR-VM-001 视频合并规则

**规则描述**: 视频片段合并的业务逻辑

**EARS验收标准**:
- WHEN 合并视频 THEN 系统 SHALL 按分镜编号顺序排列
- WHEN 分镜缺少视频 THEN 系统 SHALL 跳过该分镜或报错
- WHEN 指定转场效果 THEN 系统 SHALL 在片段间添加过渡
- WHEN 转场时长 THEN  SHALL 不超过片段时长的20%
- WHEN 合并完成 THEN 系统 SHALL 生成Episode.VideoURL
- WHEN 合并失败 THEN 系统 SHALL 提供详细FFmpeg日志

**转场效果**:
- fade: 淡入淡出（默认）
- wipe: 划像
- dissolve: 溶解
- none: 无效果

#### BR-VM-002 最终视频产出规则

**规则描述**: 剧集最终视频的生成和存储

**EARS验收标准**:
- WHEN 视频合成完成 THEN 系统 SHALL 更新Episode.VideoURL
- WHEN 生成最终视频 THEN 系统 SHALL 创建Asset记录
- WHEN 视频格式 THEN  SHALL 为MP4(H.264编码)
- WHEN 视频分辨率 THEN  SHALL 与项目设置一致
- WHEN 视频合成失败 THEN 系统 SHALL 保留已生成的片段供调试

### 1.10 资产管理约束

#### BR-AS-001 资产自动创建规则

**规则描述**: 生成记录自动转为资产

**EARS验收标准**:
- WHEN 图像生成完成 THEN 系统 SHALL 自动创建Asset记录
- WHEN 视频生成完成 THEN 系统 SHALL 自动创建Asset记录
- WHEN 视频合成完成 THEN 系统 SHALL 自动创建Asset记录
- WHEN 创建资产 THEN 系统 SHALL 复制生成记录的元数据
- WHEN 资产创建 THEN 系统 SHALL 关联到对应的生成记录
- WHEN 删除生成记录 THEN 资产 SHALL 保留（独立存在）

#### BR-AS-002 资产元数据规则

**规则描述**: 资产元数据的管理

**EARS验收标准**:
- WHEN 图像资产 THEN 系统 SHALL 记录宽度、高度、格式
- WHEN 视频资产 THEN 系统 SHALL 记录时长、分辨率、格式、帧率
- WHEN 音频资产 THEN 系统 SHALL 记录时长、格式、采样率
- WHEN 上传文件 THEN 系统 SHALL 计算文件大小和MD5校验
- WHEN 资产被查看 THEN 系统 SHALL 增加ViewCount计数
- WHEN 用户收藏资产 THEN 系统 SHALL 更新IsFavorite标记

### 1.11 存储约束

#### BR-ST-001 存储配额规则

**规则描述**: 用户存储空间的管理

**EARS验收标准**:
- WHEN 上传文件 THEN 系统 SHALL 检查文件大小（最大500MB）
- WHEN 文件超出大小 THEN 系统 SHALL 返回413错误
- WHEN 存储空间不足 THEN 系统 SHALL 拒绝新上传
- WHEN 存储使用率超过80% THEN 系统 SHALL 发送告警
- WHEN 临时文件 THEN 系统 SHALL 7天后自动清理
- WHEN 软删除数据 THEN 系统 SHALL 30天后物理清理

**配额设置**:
- 单文件: 500MB
- 单项目图像: 1GB
- 单项目视频: 10GB
- 总存储: 根据部署配置

#### BR-ST-002 文件命名规则

**规则描述**: 存储文件的命名规范

**EARS验收标准**:
- WHEN 保存文件 THEN 系统 SHALL 使用UUID作为文件名
- WHEN 保存图像 THEN 扩展名 SHALL 为.jpg或.png
- WHEN 保存视频 THEN 扩展名 SHALL 为.mp4
- WHEN 保存音频 THEN 扩展名 SHALL 为.mp3或.wav
- WHEN 目录结构 THEN  SHALL 按项目ID和类型组织

**目录结构**:
```
./storage/
├── dramas/{drama_id}/
│   ├── characters/{uuid}.jpg
│   ├── scenes/{uuid}.jpg
│   ├── episodes/{episode_id}/
│   │   ├── storyboards/{uuid}.jpg
│   │   └── videos/{uuid}.mp4
│   └── assets/
├── uploads/{yyyy}/{mm}/{dd}/{uuid}.{ext}
└── temp/{uuid}.{ext}
```

---

## 2. 业务流程规则

### 2.1 短剧创作流程

#### BP-DM-001 短剧创作主流程

**流程名称**: Short Drama Creation Process
**参与者**: 内容创作者
**触发条件**: 用户创建新项目

**流程步骤**:

1. **项目创建** (创建者)
   - 输入: 项目标题、描述、类型
   - 输出: Drama记录（状态: draft）
   - 规则: BR-DM-001, BR-DM-002

2. **大纲编写** (创建者)
   - 输入: 项目简介、标签、风格设置
   - 输出: 更新的Drama记录（状态: planning）
   - 规则: 无

3. **角色设计** (创建者)
   - 输入: 角色名称、描述、外貌、性格
   - 输出: Character记录
   - 规则: BR-CM-001, BR-CM-002
   - 分支: 可AI生成图像或从角色库选择

4. **场景设定** (创建者)
   - 输入: 地点、时间、描述、提示词
   - 输出: Scene记录
   - 规则: BR-SC-001, BR-SC-002

5. **分集规划** (创建者)
   - 输入: 剧集数量、每集标题
   - 输出: Episode记录列表
   - 规则: BR-EP-001

6. **剧本编写** (创建者)
   - 输入: 剧本内容（每集）
   - 输出: Episode.ScriptContent
   - 规则: 无

7. **分镜生成** (系统自动)
   - 输入: 剧本内容
   - 输出: Storyboard记录列表
   - 规则: BR-SB-001, BR-SB-002, BR-SB-004
   - 触发: BR-DM-001（状态更新为production）

8. **图像生成** (创建者/系统)
   - 输入: 场景、角色、分镜
   - 输出: ImageGeneration记录 + 图像文件
   - 规则: BR-IG-001, BR-IG-002, BR-AS-001
   - 并发: 受BR-IG-002限制

9. **视频生成** (创建者/系统)
   - 输入: 分镜图像
   - 输出: VideoGeneration记录 + 视频文件
   - 规则: BR-VG-001, BR-AS-001
   - 并发: 受BR-IG-002限制

10. **视频合成** (创建者/系统)
    - 输入: 所有分镜视频
    - 输出: Episode.VideoURL
    - 规则: BR-VM-001, BR-VM-002, BR-AS-001
    - 触发: BR-EP-002（状态更新为completed）

**流程图**:
```
开始
  ↓
创建项目 (draft)
  ↓
编写大纲 (planning)
  ↓
设计角色 → 生成角色图
  ↓
设定场景 → 生成场景图
  ↓
规划分集
  ↓
编写剧本
  ↓
解析分镜 (production)
  ↓
生成分镜图 → 并行，受并发限制
  ↓
生成视频片段 → 并行，受并发限制
  ↓
合成视频 (completed)
  ↓
完成
```

### 2.2 角色管理流程

#### BP-CM-001 角色创建流程

**流程名称**: Character Creation Process
**参与者**: 内容创作者

**流程步骤**:

1. **输入角色信息** (创建者)
   - 必填: 名称
   - 可选: 角色定位、描述、外貌、性格、声音风格

2. **检查唯一性** (系统自动)
   - 检查: (DramaID, Name)是否已存在
   - 决策:
     - 不存在: 继续创建
     - 存在: 提示用户选择更新或修改名称

3. **创建记录** (系统自动)
   - 创建Character记录
   - 关联DramaID

4. **生成图像** (创建者选择)
   - 选项A: AI生成
     - 构建提示词（BR-CM-002）
     - 调用AI服务
     - 保存结果
   - 选项B: 上传图片
     - 验证文件
     - 保存文件
     - 更新ImageURL
   - 选项C: 从角色库选择
     - 查询CharacterLibrary
     - 复制图像
     - 关联库项

5. **完成** (系统)
   - 更新Drama.UpdatedAt
   - 返回角色信息

#### BP-CM-002 角色应用到剧集流程

**流程名称**: Character Assignment to Episode
**参与者**: 内容创作者

**流程步骤**:

1. **选择剧集** (创建者)
   - 从项目剧集列表选择

2. **选择角色** (创建者)
   - 从项目角色列表选择（可多选）

3. **建立关联** (系统自动)
   - 创建Episode_Character关联记录
   - 自动去重（BR-CM-003）

4. **更新计数** (系统自动)
   - 更新角色的出场统计

### 2.3 分镜制作流程

#### BP-SB-001 自动分镜解析流程

**流程名称**: Automatic Storyboard Parsing
**参与者**: 内容创作者、AI服务

**流程步骤**:

1. **提交剧本** (创建者)
   - 输入: Episode.ScriptContent
   - 触发: 点击"解析分镜"按钮

2. **创建任务** (系统自动)
   - 创建AsyncTask记录
   - 类型: storyboard_generation
   - 状态: pending

3. **AI解析** (系统+AI服务)
   - 调用: AIService.ParseScript()
   - 输入: 剧本文本
   - 输出: JSON格式的分镜数据
   - 更新任务状态: processing

4. **处理结果** (系统自动)
   - 解析AI返回的JSON
   - 提取: scenes, characters, storyboards

5. **创建场景** (系统自动)
   - 对每个场景:
     - 检查是否已存在（BR-SC-001）
     - 不存在: 创建Scene记录
     - 存在: 复用现有场景

6. **处理角色** (系统自动)
   - 对每个角色:
     - 检查是否已存在（BR-CM-001）
     - 不存在: 创建Character记录
     - 关联到Episode（BR-CM-003）

7. **创建分镜** (系统自动)
   - 创建Storyboard记录
   - 设置StoryboardNumber递增（BR-SB-001）
   - 关联Episode、Scene、Characters（BR-SB-004）

8. **完成任务** (系统自动)
   - 更新AsyncTask状态为completed
   - 更新Episode.Status为storyboard_ready
   - 通知用户

**异常处理**:
- AI解析失败: 标记任务为failed，记录错误，允许重试
- 数据验证失败: 跳过无效数据，记录警告，继续处理其他

#### BP-SB-002 手动分镜编辑流程

**流程名称**: Manual Storyboard Editing
**参与者**: 内容创作者

**流程步骤**:

1. **选择操作** (创建者)
   - 选项: 创建新分镜 / 编辑现有分镜 / 删除分镜

2. **创建/编辑** (创建者)
   - 输入字段:
     - 基本信息: 编号、标题、时长
     - 场景: 选择或创建场景
     - 镜头: 类型、角度、运动
     - 内容: 动作、对话、描述
     - 资源: 关联角色、道具

3. **保存验证** (系统自动)
   - 验证必填字段
   - 验证编号唯一性（BR-SB-001）
   - 验证关联资源存在性

4. **更新数据库** (系统自动)
   - 插入或更新Storyboard记录
   - 更新关联关系
   - 如修改编号，调整其他分镜编号（可选）

5. **生成图像** (创建者选择)
   - 可选: 立即生成分镜图像
   - 调用图像生成流程

### 2.4 AI生成任务流程

#### BP-AI-001 单图像生成流程

**流程名称**: Single Image Generation
**参与者**: 内容创作者、AI服务

**流程步骤**:

1. **提交请求** (创建者)
   - 选择目标: 角色/场景/分镜/道具
   - 触发: 点击"生成图像"

2. **创建任务** (系统自动)
   - 创建ImageGeneration记录
   - 状态: pending
   - 构建提示词（根据目标类型）

3. **选择配置** (系统自动)
   - 查询AIServiceConfig
   - 选择默认且激活的图像配置
   - 规则: BR-AI-001

4. **调用AI** (系统+AI服务)
   - 更新状态: processing
   - 调用: AIClient.GenerateImage()
   - 超时: 180秒
   - 重试: 最多3次（BR-AI-002）

5. **处理结果** (系统自动)
   - 成功:
     - 下载图像到本地
     - 更新ImageGeneration状态为completed
     - 创建Asset记录（BR-AS-001）
     - 更新目标记录的ImageURL
   - 失败:
     - 更新状态为failed
     - 记录ErrorMsg
     - 通知用户

6. **完成通知** (系统)
   - 前端推送通知或轮询更新

#### BP-AI-002 批量生成流程

**流程名称**: Batch Generation Process
**参与者**: 内容创作者、任务调度器

**流程步骤**:

1. **提交批量请求** (创建者)
   - 选择: 批量角色图像 / 批量场景图像 / 批量分镜图像 / 全部
   - 范围: 剧集级别或项目级别

2. **创建批量任务** (系统自动)
   - 创建AsyncTask记录
   - 类型: batch_image_generation / batch_video_generation
   - 计算: 总任务数

3. **任务分解** (系统自动)
   - 查询所有目标对象
   - 为每个对象创建子任务
   - 加入任务队列

4. **队列处理** (任务调度器)
   - 监控并发数（BR-IG-002）
   - 从队列获取任务
   - 执行单任务流程
   - 更新进度

5. **进度更新** (系统自动)
   - 实时更新AsyncTask.Progress
   - 记录已完成/失败/总数

6. **任务完成** (系统自动)
   - 所有子任务完成
   - 更新AsyncTask状态为completed
   - 生成统计报告
   - 通知用户

**并发控制**:
- 图像任务: 最大10个并发
- 视频任务: 最大3个并发
- 队列满时: 新任务等待

### 2.5 视频合成流程

#### BP-VM-001 剧集视频合成流程

**流程名称**: Episode Video Composition
**参与者**: 内容创作者、FFmpeg

**流程步骤**:

1. **准备阶段** (系统自动)
   - 查询Episode的所有Storyboard
   - 验证每个分镜都有VideoURL
   - 检查视频文件存在性

2. **创建任务** (系统自动)
   - 创建VideoMerge记录
   - 创建AsyncTask记录
   - 状态: pending

3. **配置转场** (系统自动/用户)
   - 使用默认转场或用户指定
   - 验证转场参数

4. **FFmpeg合成** (FFmpeg)
   - 构建命令行
   - 执行合并
   - 监控进度
   - 更新AsyncTask.Progress

5. **处理结果** (系统自动)
   - 成功:
     - 移动输出文件到存储
     - 更新Episode.VideoURL
     - 创建Asset记录
     - 更新VideoMerge和AsyncTask状态
   - 失败:
     - 记录FFmpeg错误日志
     - 标记任务失败
     - 保留临时文件供调试

6. **完成通知** (系统)
   - 推送通知给用户
   - 提供预览和下载链接

---

## 3. 业务规则汇总表

### 3.1 按模块汇总

| 模块 | 规则数量 | 关键规则 |
|-----|---------|---------|
| 短剧项目 (DM) | 2 | 生命周期、唯一性 |
| 角色管理 (CM) | 3 | 唯一性、图像生成、关联 |
| 剧集管理 (EP) | 3 | 编号、状态、时长计算 |
| 场景管理 (SC) | 2 | 复用、图像生成 |
| 分镜管理 (SB) | 4 | 编号、提示词、时长、关联 |
| 道具管理 (PR) | 2 | 提取、关联 |
| AI服务 (AI) | 2 | 配置、调用 |
| 生成任务 (IG/VG) | 3 | 任务状态、批量、参数 |
| 视频合成 (VM) | 2 | 合并规则、产出规则 |
| 资产管理 (AS) | 2 | 自动创建、元数据 |
| 存储管理 (ST) | 2 | 配额、命名 |
| **合计** | **27** | - |

### 3.2 按优先级汇总

| 优先级 | 规则数量 | 规则列表 |
|-------|---------|---------|
| 高 | 15 | BR-DM-001, BR-CM-001, BR-CM-002, BR-EP-001, BR-EP-002, BR-EP-003, BR-SB-001, BR-SB-002, BR-IG-001, BR-IG-002, BR-VG-001, BR-VM-001, BR-VM-002, BR-AS-001, BR-AI-001 |
| 中 | 8 | BR-DM-002, BR-CM-003, BR-SC-001, BR-SC-002, BR-SB-003, BR-SB-004, BR-AI-002, BR-AS-002 |
| 低 | 4 | BR-PR-001, BR-PR-002, BR-ST-001, BR-ST-002 |

### 3.3 EARS格式验收标准汇总

```
【项目生命周期】
WHEN 项目创建 THEN 项目状态 SHALL 自动设为"draft"
WHEN 用户开始生成分镜 THEN 状态 SHALL 自动更新为"production"

【角色唯一性】
WHEN 创建角色 THEN 系统 SHALL 检查项目名称是否已存在
WHEN 名称已存在 THEN 系统 SHALL 提示用户选择：更新或修改

【剧集状态】
WHEN 剧本保存 THEN 状态 SHALL 更新为"script_ready"
WHEN 所有分镜图像生成 THEN 状态 SHALL 更新为"images_ready"
WHEN 视频合成完成 THEN 状态 SHALL 更新为"completed"

【分镜编号】
WHEN 解析剧本生成分镜 THEN 系统 SHALL 自动分配连续编号
WHEN 调整分镜顺序 THEN 系统 SHALL 重新分配编号保持连续

【AI生成任务】
WHEN 提交生成任务 THEN 系统 SHALL 立即返回任务ID
WHEN 任务失败 THEN 用户 SHALL 可以重试

【批量生成】
WHEN 提交批量生成 THEN 系统 SHALL 限制并发数
WHEN 部分任务失败 THEN 系统 SHALL 继续执行其他任务

【视频合成】
WHEN 合并视频 THEN 系统 SHALL 按分镜编号顺序排列
WHEN 指定转场效果 THEN 系统 SHALL 在片段间添加过渡
```

---

**文档结束**
