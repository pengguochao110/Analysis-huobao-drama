# 软件需求规格说明书 (SRS)

## 火宝短剧 (Huobao Drama) AI短剧生成平台

**版本**: v1.0  
**日期**: 2025-02-03  
**状态**: 草案  

---

## 1. 引言

### 1.1 目的

本文档描述了火宝短剧（Huobao Drama）AI短剧生成平台的软件需求规格。该平台是一个开源的AI驱动短剧自动化生产系统，支持从剧本生成到视频合成的全流程自动化。

### 1.2 文档约定

- 使用 EARS（Easy Approach to Requirements Syntax）格式编写验收标准
- 所有功能需求编号格式：FR-[模块]-[序号]
- 所有非功能需求编号格式：NFR-[类别]-[序号]
- 所有接口需求编号格式：IR-[类型]-[序号]

### 1.3 项目范围

火宝短剧平台支持以下核心功能：
- 短剧项目管理（创建、编辑、删除、状态跟踪）
- 角色管理（AI生成肖像、批量生成、角色库管理）
- 分镜制作（自动剧本解析、场景描述、分镜图生成）
- 视频生成（图生视频、视频合成、转场效果）
- 资源管理（资产库、本地存储、导入导出）
- AI服务集成（支持6+主流AI提供商）

### 1.4 参考文献

- Go 1.23 官方文档
- Vue 3 官方文档
- Gin Framework 文档
- FFmpeg 文档

---

## 2. 总体描述

### 2.1 产品视角

火宝短剧是一个前后端分离的Web应用：
- **前端**：Vue 3 + TypeScript + Element Plus
- **后端**：Go 1.23 + Gin Framework
- **数据库**：SQLite（开发）/ MySQL（生产）
- **存储**：本地文件系统 + MinIO（可选）
- **AI服务**：多提供商支持（OpenAI、Gemini、豆包、火山等）

### 2.2 用户类别

| 用户类别 | 描述 | 权限级别 |
|---------|------|---------|
| 内容创作者 | 创建和管理短剧项目 | 完整权限 |
| 视频制作人员 | 生成视频、编辑时间线 | 完整权限 |
| 系统管理员 | 配置AI服务、监控系统 | 管理权限 |

### 2.3 运行环境

- **服务器**: Linux/Windows/macOS
- **最小内存**: 4GB RAM
- **存储空间**: 100GB（含AI生成资源）
- **浏览器**: Chrome 90+, Firefox 88+, Safari 14+
- **网络**: 需要访问外部AI服务API

### 2.4 约束条件

- AI生成任务依赖第三方服务可用性
- 视频合成需要FFmpeg已安装
- 大文件上传受服务器配置限制

---

## 3. 功能需求

### 3.1 短剧管理模块 (FR-DM)

#### FR-DM-001 短剧项目CRUD
**描述**: 用户可以创建、查看、更新、删除短剧项目
**优先级**: 高
**验收标准**:
- WHEN 用户提交有效项目信息 THEN 系统 SHALL 创建新项目
- WHEN 用户请求项目列表 THEN 系统 SHALL 返回分页结果
- WHEN 用户更新项目信息 THEN 系统 SHALL 保存变更
- WHEN 用户删除项目 THEN 系统 SHALL 软删除并保留关联数据

#### FR-DM-002 剧本大纲管理
**描述**: 用户可以编辑短剧的基本信息、大纲、标签
**优先级**: 高
**验收标准**:
- WHEN 用户保存大纲 THEN 系统 SHALL 更新标题、简介、类型、标签
- WHEN 大纲包含标签 THEN 系统 SHALL 以JSON格式存储

#### FR-DM-003 分集管理
**描述**: 用户可以为短剧创建和管理多个剧集
**优先级**: 高
**验收标准**:
- WHEN 用户保存剧集列表 THEN 系统 SHALL 替换现有剧集
- WHEN 剧集关联到短剧 THEN 系统 SHALL 自动排序剧集编号
- WHEN 剧集包含剧本内容 THEN 系统 SHALL 支持长文本存储

#### FR-DM-004 项目统计
**描述**: 系统提供短剧项目的统计数据
**优先级**: 中
**验收标准**:
- WHEN 用户请求统计信息 THEN 系统 SHALL 返回项目总数和状态分布

### 3.2 角色管理模块 (FR-CM)

#### FR-CM-001 角色CRUD
**描述**: 用户可以创建、更新、删除角色信息
**优先级**: 高
**验收标准**:
- WHEN 用户创建角色 THEN 系统 SHALL 存储名称、角色、描述、性格、外貌、声音特征
- WHEN 角色关联到剧集 THEN 系统 SHALL 建立多对多关系
- WHEN 用户更新角色 THEN 系统 SHALL 支持增量更新

#### FR-CM-002 AI角色图像生成
**描述**: 系统使用AI服务生成角色肖像
**优先级**: 高
**验收标准**:
- WHEN 用户请求生成角色图像 THEN 系统 SHALL 调用配置的AI图像服务
- WHEN AI服务返回图像 THEN 系统 SHALL 存储URL和本地路径
- WHEN 生成失败 THEN 系统 SHALL 记录错误并允许重试

#### FR-CM-003 批量角色生成
**描述**: 用户可以批量生成多个角色的图像
**优先级**: 中
**验收标准**:
- WHEN 用户选择多个角色 THEN 系统 SHALL 依次调用AI服务
- WHEN 批量任务进行中 THEN 系统 SHALL 显示进度状态
- WHEN 部分角色生成失败 THEN 系统 SHALL 继续处理其他角色

#### FR-CM-004 角色库管理
**描述**: 用户可以管理可复用的角色资源
**优先级**: 中
**验收标准**:
- WHEN 用户添加角色到库 THEN 系统 SHALL 存储为全局角色
- WHEN 用户从库应用角色 THEN 系统 SHALL 关联到当前项目
- WHEN 用户搜索角色库 THEN 系统 SHALL 支持按分类和标签过滤

### 3.3 场景管理模块 (FR-SM)

#### FR-SM-001 场景CRUD
**描述**: 用户可以创建和管理拍摄场景
**优先级**: 高
**验收标准**:
- WHEN 用户创建场景 THEN 系统 SHALL 存储地点、时间、描述、提示词
- WHEN 场景关联到剧集 THEN 系统 SHALL 建立外键关系
- WHEN 用户更新场景 THEN 系统 SHALL 支持更新提示词

#### FR-SM-002 AI场景图像生成
**描述**: 系统使用AI服务生成场景背景图
**优先级**: 高
**验收标准**:
- WHEN 用户请求生成场景图像 THEN 系统 SHALL 使用场景提示词
- WHEN 场景图像生成完成 THEN 系统 SHALL 更新场景记录
- WHEN 场景图像失败 THEN 系统 SHALL 保留原状态并记录错误

### 3.4 分镜管理模块 (FR-SB)

#### FR-SB-001 分镜自动解析
**描述**: 系统从剧本自动生成分镜列表
**优先级**: 高
**验收标准**:
- WHEN 用户提交剧本 THEN 系统 SHALL 调用AI服务解析场景、角色、动作
- WHEN AI解析完成 THEN 系统 SHALL 创建分镜记录
- WHEN 分镜包含场景 THEN 系统 SHALL 关联或创建场景记录

#### FR-SB-002 分镜手动编辑
**描述**: 用户可以手动创建和编辑分镜
**优先级**: 高
**验收标准**:
- WHEN 用户创建分镜 THEN 系统 SHALL 存储编号、标题、地点、时间、镜头类型、角度、运动、动作、结果、氛围
- WHEN 用户更新分镜 THEN 系统 SHALL 支持更新所有字段
- WHEN 用户删除分镜 THEN 系统 SHALL 软删除并清理关联

#### FR-SB-003 分镜图像生成
**描述**: 系统为每个分镜生成预览图
**优先级**: 高
**验收标准**:
- WHEN 用户请求生成分镜图 THEN 系统 SHALL 组合图像提示词
- WHEN 分镜关联角色 THEN 系统 SHALL 在提示词中包含角色特征
- WHEN 分镜关联场景 THEN 系统 SHALL 在提示词中包含场景描述

#### FR-SB-004 帧提示词管理
**描述**: 用户可以管理分镜的不同帧提示词
**优先级**: 中
**验收标准**:
- WHEN 用户创建帧提示词 THEN 系统 SHALL 支持首帧、关键帧、尾帧、面板、动作类型
- WHEN 帧提示词关联分镜 THEN 系统 SHALL 按类型存储
- WHEN 用户查询帧提示词 THEN 系统 SHALL 返回分镜的所有帧

### 3.5 道具管理模块 (FR-PM)

#### FR-PM-001 道具CRUD
**描述**: 用户可以创建、更新、删除道具
**优先级**: 中
**验收标准**:
- WHEN 用户创建道具 THEN 系统 SHALL 存储名称、类型、描述、提示词
- WHEN 道具关联到分镜 THEN 系统 SHALL 建立多对多关系
- WHEN 道具关联项目 THEN 系统 SHALL 存储项目ID

#### FR-PM-002 AI道具图像生成
**描述**: 系统使用AI服务生成道具图像
**优先级**: 中
**验收标准**:
- WHEN 用户请求生成道具图像 THEN 系统 SHALL 使用道具提示词
- WHEN 道具图像生成完成 THEN 系统 SHALL 更新道具记录

#### FR-PM-003 剧本道具提取
**描述**: 系统自动从剧本中提取道具
**优先级**: 低
**验收标准**:
- WHEN 用户请求提取道具 THEN 系统 SHALL 调用AI服务解析剧本
- WHEN 道具提取完成 THEN 系统 SHALL 创 build 道具记录

### 3.6 图像生成模块 (FR-IG)

#### FR-IG-001 图像生成任务管理
**描述**: 系统管理所有图像生成任务
**优先级**: 高
**验收标准**:
- WHEN 用户提交生成请求 THEN 系统 SHALL 创建待处理任务
- WHEN AI服务开始处理 THEN 系统 SHALL 更新状态为处理中
- WHEN 图像生成完成 THEN 系统 SHALL 存储URL并更新资产库
- WHEN 生成失败 THEN 系统 SHALL 记录错误并保持可重试状态

#### FR-IG-002 图像类型支持
**描述**: 系统支持多种图像类型生成
**优先级**: 高
**验收标准**:
- WHEN 生成角色图像 THEN 系统 SHALL 标记类型为character
- WHEN 生成场景图像 THEN 系统 SHALL 标记类型为scene
- WHEN 生成分镜图像 THEN 系统 SHALL 标记类型为storyboard
- WHEN 生成道具图像 THEN 系统 SHALL 标记类型为prop

#### FR-IG-003 批量图像生成
**描述**: 用户可以批量生成剧集的所有图像
**优先级**: 高
**验收标准**:
- WHEN 用户请求批量生成 THEN 系统 SHALL 创建异步任务
- WHEN 批量任务进行中 THEN 系统 SHALL 提供进度查询接口
- WHEN 任务完成 THEN 系统 SHALL 发送通知

#### FR-IG-004 图像资产管理
**描述**: 生成的图像自动进入资产库
**优先级**: 中
**验收标准**:
- WHEN 图像生成完成 THEN 系统 SHALL 创建资产记录
- WHEN 资产关联生成记录 THEN 系统 SHALL 存储外键关系
- WHEN 用户查看资产 THEN 系统 SHALL 显示元数据（尺寸、格式、大小）

### 3.7 视频生成模块 (FR-VG)

#### FR-VG-001 视频生成任务管理
**描述**: 系统管理所有视频生成任务
**优先级**: 高
**验收标准**:
- WHEN 用户提交视频生成请求 THEN 系统 SHALL 创建待处理任务
- WHEN 用户提供参考图像 THEN 系统 SHALL 支持单图、首尾帧、多图模式
- WHEN 视频生成完成 THEN 系统 SHALL 存储视频URL并更新资产库
- WHEN 生成失败 THEN 系统 SHALL 记录详细错误信息

#### FR-VG-002 视频参数配置
**描述**: 用户可以配置视频生成参数
**优先级**: 高
**验收标准**:
- WHEN 用户设置时长 THEN 系统 SHALL 传递持续时间参数
- WHEN 用户设置分辨率 THEN 系统 SHALL 传递分辨率参数
- WHEN 用户设置比例 THEN 系统 SHALL 传递宽高比参数
- WHEN 用户设置运动强度 THEN 系统 SHALL 传递运动级别参数
- WHEN 用户设置镜头运动 THEN 系统 SHALL 传递相机运动参数

#### FR-VG-003 图生视频
**描述**: 系统支持从图像生成视频
**优先级**: 高
**验收标准**:
- WHEN 用户选择图像 THEN 系统 SHALL 使用该图像作为首帧
- WHEN 用户提供提示词 THEN 系统 SHALL 传递运动描述
- WHEN 视频生成完成 THEN 系统 SHALL 关联到原始分镜

#### FR-VG-004 批量视频生成
**描述**: 用户可以批量生成剧集的所有视频
**优先级**: 高
**验收标准**:
- WHEN 用户请求批量生成 THEN 系统 SHALL 为每个分镜创建视频任务
- WHEN 任务队列过长 THEN 系统 SHALL 按优先级处理
- WHEN 批量任务完成 THEN 系统 SHALL 更新剧集状态

### 3.8 视频合成模块 (FR-VM)

#### FR-VM-001 视频合并
**描述**: 系统将多个视频片段合成为一个完整视频
**优先级**: 高
**验收标准**:
- WHEN 用户选择多个视频 THEN 系统 SHALL 使用FFmpeg合并
- WHEN 视频需要转场 THEN 系统 SHALL 添加过渡效果
- WHEN 合并完成 THEN 系统 SHALL 生成最终视频文件
- WHEN 合并失败 THEN 系统 SHALL 提供详细错误日志

#### FR-VM-002 音频提取
**描述**: 系统可以从视频提取音频
**优先级**: 中
**验收标准**:
- WHEN 用户请求提取音频 THEN 系统 SHALL 使用FFmpeg提取音轨
- WHEN 支持批量提取 THEN 系统 SHALL 处理多个视频文件
- WHEN 提取完成 THEN 系统 SHALL 生成音频资产

### 3.9 AI配置管理模块 (FR-AI)

#### FR-AI-001 AI服务配置CRUD
**描述**: 用户可以配置多个AI服务提供商
**优先级**: 高
**验收标准**:
- WHEN 用户创建配置 THEN 系统 SHALL 存储类型、提供商、名称、基础URL、API密钥、模型
- WHEN 配置标记为默认 THEN 系统 SHALL 确保只有一个默认配置
- WHEN 配置标记为激活 THEN 系统 SHALL 在生成任务中使用

#### FR-AI-002 AI服务测试
**描述**: 用户可以测试AI服务连接
**优先级**: 中
**验收标准**:
- WHEN 用户请求测试 THEN 系统 SHALL 调用AI服务健康检查
- WHEN 连接成功 THEN 系统 SHALL 返回成功状态
- WHEN 连接失败 THEN 系统 SHALL 返回详细错误信息

#### FR-AI-003 多提供商支持
**描述**: 系统支持多种AI服务提供商
**优先级**: 高
**验收标准**:
- WHEN 配置OpenAI THEN 系统 SHALL 支持GPT和DALL-E
- WHEN 配置Gemini THEN 系统 SHALL 支持Google AI服务
- WHEN 配置火山引擎 THEN 系统 SHALL 支持豆包和图像服务
- WHEN 配置其他提供商 THEN 系统 SHALL 通过通用接口调用

### 3.10 资产管理模块 (FR-AM)

#### FR-AM-001 资产CRUD
**描述**: 用户可以管理生成的所有媒体资源
**优先级**: 高
**验收标准**:
- WHEN 用户查看资产列表 THEN 系统 SHALL 支持按类型、项目、剧集过滤
- WHEN 用户导入资产 THEN 系统 SHALL 支持从生成记录导入
- WHEN 用户更新资产 THEN 系统 SHALL 支持编辑名称、描述、分类
- WHEN 用户删除资产 THEN 系统 SHALL 软删除并可选删除文件

#### FR-AM-002 资产元数据
**描述**: 系统存储资产的详细元数据
**优先级**: 中
**验收标准**:
- WHEN 存储图像资产 THEN 系统 SHALL 记录宽度、高度、格式
- WHEN 存储视频资产 THEN 系统 SHALL 记录时长、分辨率、格式
- WHEN 存储音频资产 THEN 系统 SHALL 记录时长、格式
- WHEN 文件上传 THEN 系统 SHALL 计算并存储文件大小

#### FR-AM-003 资产收藏与浏览
**描述**: 用户可以收藏和查看资产
**优先级**: 低
**验收标准**:
- WHEN 用户收藏资产 THEN 系统 SHALL 标记收藏状态
- WHEN 用户查看资产 THEN 系统 SHALL 记录浏览次数
- WHEN 用户搜索资产 THEN 系统 SHALL 支持关键词搜索

### 3.11 任务管理模块 (FR-TM)

#### FR-TM-001 异步任务管理
**描述**: 系统管理所有异步生成任务
**优先级**: 高
**验收标准**:
- WHEN 创建异步任务 THEN 系统 SHALL 生成唯一任务ID
- WHEN 任务进行中 THEN 系统 SHALL 提供进度查询接口
- WHEN 任务完成 THEN 系统 SHALL 更新完成时间并存储结果
- WHEN 任务失败 THEN 系统 SHALL 记录错误并允许重试

#### FR-TM-002 任务类型支持
**描述**: 系统支持多种任务类型
**优先级**: 高
**验收标准**:
- WHEN 分镜生成任务 THEN 系统 SHALL 解析剧本并创建分镜
- WHEN 图像生成任务 THEN 系统 SHALL 调用AI图像服务
- WHEN 视频生成任务 THEN 系统 SHALL 调用AI视频服务
- WHEN 批量任务 THEN 系统 SHALL 支持任务队列管理

### 3.12 系统设置模块 (FR-SS)

#### FR-SS-001 语言设置
**描述**: 用户可以设置系统界面语言
**优先级**: 中
**验收标准**:
- WHEN 用户切换语言 THEN 系统 SHALL 保存语言配置
- WHEN 语言为中文 THEN 系统 SHALL 显示中文界面
- WHEN 语言为英文 THEN 系统 SHALL 显示英文界面

#### FR-SS-002 系统配置
**描述**: 系统支持多种配置参数
**优先级**: 中
**验收标准**:
- WHEN 配置存储 THEN 系统 SHALL 支持本地文件系统或MinIO
- WHEN 配置数据库 THEN 系统 SHALL 支持SQLite或MySQL
- WHEN 配置AI服务 THEN 系统 SHALL 设置默认提供商

---

## 4. 非功能需求

### 4.1 性能需求 (NFR-PF)

#### NFR-PF-001 响应时间
**描述**: 系统API响应时间要求
**优先级**: 高
**验收标准**:
- WHEN 用户请求列表数据 THEN 系统 SHALL 在2秒内返回
- WHEN 用户提交表单 THEN 系统 SHALL 在1秒内确认接收
- WHEN 用户查询任务状态 THEN 系统 SHALL 在500毫秒内返回

#### NFR-PF-002 并发处理
**描述**: 系统并发用户和任务处理能力
**优先级**: 中
**验收标准**:
- WHEN 多用户同时操作 THEN 系统 SHALL 支持至少50个并发用户
- WHEN 批量任务执行 THEN 系统 SHALL 支持最多10个并行任务
- WHEN 数据库访问 THEN 系统 SHALL 配置连接池支持并发

#### NFR-PF-003 资源使用
**描述**: 系统资源使用限制
**优先级**: 中
**验收标准**:
- WHEN 系统运行 THEN 内存使用 SHALL 不超过4GB
- WHEN 视频合成 THEN CPU使用 SHALL 根据FFmpeg配置限制
- WHEN 文件上传 THEN 单个文件 SHALL 不超过500MB

### 4.2 可用性需求 (NFR-AV)

#### NFR-AV-001 系统可用率
**描述**: 系统正常运行时间要求
**优先级**: 高
**验收标准**:
- WHEN 系统部署 THEN 可用率 SHALL 达到99.5%
- WHEN 发生错误 THEN 系统 SHALL 自动恢复
- WHEN 需要维护 THEN 系统 SHALL 支持零停机更新

#### NFR-AV-002 恢复时间
**描述**: 系统故障恢复要求
**优先级**: 中
**验收标准**:
- WHEN 系统崩溃 THEN RTO（恢复时间目标）SHALL 不超过5分钟
- WHEN 数据丢失 THEN RPO（恢复点目标）SHALL 不超过1小时
- WHEN 服务重启 THEN 系统 SHALL 自动恢复进行中任务

### 4.3 安全性需求 (NFR-SE)

#### NFR-SE-001 API密钥保护
**描述**: AI服务API密钥安全存储
**优先级**: 高
**验收标准**:
- WHEN 存储API密钥 THEN 系统 SHALL 加密存储
- WHEN 返回配置信息 THEN 系统 SHALL 脱敏处理密钥
- WHEN 配置文件 THEN 系统 SHALL 限制文件访问权限

#### NFR-SE-002 输入验证
**描述**: 系统对用户输入进行验证
**优先级**: 高
**验收标准**:
- WHEN 用户提交数据 THEN 系统 SHALL 验证数据类型和长度
- WHEN 上传文件 THEN 系统 SHALL 验证文件类型和大小
- WHEN SQL查询 THEN 系统 SHALL 使用参数化查询防注入

#### NFR-SE-003 速率限制
**描述**: 系统防止API滥用
**优先级**: 中
**验收标准**:
- WHEN API请求 THEN 系统 SHALL 实施速率限制
- WHEN 超过限制 THEN 系统 SHALL 返回429状态码
- WHEN 限制配置 THEN 管理员 SHALL 可调整限制参数

### 4.4 可维护性需求 (NFR-MT)

#### NFR-MT-001 日志记录
**描述**: 系统记录详细日志
**优先级**: 高
**验收标准**:
- WHEN 系统运行 THEN 日志 SHALL 包含时间、级别、消息、上下文
- WHEN 错误发生 THEN 日志 SHALL 包含堆栈跟踪
- WHEN AI服务调用 THEN 日志 SHALL 记录请求和响应摘要

#### NFR-MT-002 监控接口
**描述**: 系统提供健康检查接口
**优先级**: 中
**验收标准**:
- WHEN 访问健康接口 THEN 系统 SHALL 返回运行状态
- WHEN 数据库异常 THEN 健康检查 SHALL 反映异常状态
- WHEN AI服务异常 THEN 系统 SHALL 记录但不影响整体状态

#### NFR-MT-003 配置管理
**描述**: 系统支持灵活配置
**优先级**: 中
**验收标准**:
- WHEN 配置文件变更 THEN 系统 SHALL 支持热重载
- WHEN 环境变量 THEN 系统 SHALL 优先使用环境变量
- WHEN 配置验证 THEN 系统 SHALL 启动时验证配置有效性

### 4.5 兼容性需求 (NFR-CM)

#### NFR-CM-001 浏览器兼容
**描述**: 前端支持多种浏览器
**优先级**: 高
**验收标准**:
- WHEN 用户使用Chrome THEN 界面 SHALL 正常工作
- WHEN 用户使用Firefox THEN 界面 SHALL 正常工作
- WHEN 用户使用Safari THEN 界面 SHALL 正常工作

#### NFR-CM-002 数据库兼容
**描述**: 后端支持多种数据库
**优先级**: 中
**验收标准**:
- WHEN 使用SQLite THEN 系统 SHALL 正常工作
- WHEN 使用MySQL THEN 系统 SHALL 正常工作
- WHEN 数据库迁移 THEN 系统 SHALL 自动执行迁移脚本

---

## 5. 接口需求

### 5.1 用户界面 (IR-UI)

#### IR-UI-001 响应式设计
**描述**: 前端界面适配不同屏幕尺寸
**优先级**: 高
**验收标准**:
- WHEN 用户使用桌面 THEN 界面 SHALL 显示完整布局
- WHEN 用户使用平板 THEN 界面 SHALL 自适应调整
- WHEN 用户使用移动设备 THEN 界面 SHALL 支持基本功能

#### IR-UI-002 主题支持
**描述**: 界面支持明暗主题
**优先级**: 低
**验收标准**:
- WHEN 用户切换主题 THEN 界面 SHALL 实时更新
- WHEN 系统默认 THEN 界面 SHALL 根据系统偏好自动选择

### 5.2 硬件接口 (IR-HW)

#### IR-HW-001 存储接口
**描述**: 系统支持多种存储后端
**优先级**: 中
**验收标准**:
- WHEN 使用本地存储 THEN 系统 SHALL 读写本地文件系统
- WHEN 使用MinIO THEN 系统 SHALL 通过S3协议访问
- WHEN 文件访问 THEN 系统 SHALL 提供静态文件服务

### 5.3 软件接口 (IR-SW)

#### IR-SW-001 AI服务接口
**描述**: 系统对接多个AI服务提供商
**优先级**: 高
**验收标准**:
- WHEN 调用OpenAI THEN 系统 SHALL 使用OpenAI API规范
- WHEN 调用Gemini THEN 系统 SHALL 使用Google AI API规范
- WHEN 调用豆包 THEN 系统 SHALL 使用字节API规范
- WHEN 调用火山引擎 THEN 系统 SHALL 使用火山API规范

#### IR-SW-002 FFmpeg接口
**描述**: 系统使用FFmpeg进行视频处理
**优先级**: 高
**验收标准**:
- WHEN 视频合成 THEN 系统 SHALL 调用FFmpeg命令行
- WHEN 音频提取 THEN 系统 SHALL 使用FFmpeg解码
- WHEN 格式转换 THEN 系统 SHALL 配置FFmpeg参数

#### IR-SW-003 数据库接口
**描述**: 系统使用GORM访问数据库
**优先级**: 高
**验收标准**:
- WHEN 数据查询 THEN 系统 SHALL 使用GORM查询API
- WHEN 数据更新 THEN 系统 SHALL 使用GORM事务
- WHEN 数据关联 THEN 系统 SHALL 使用GORM预加载

### 5.4 通信接口 (IR-CM)

#### IR-CM-001 REST API
**描述**: 后端提供RESTful API接口
**优先级**: 高
**验收标准**:
- WHEN HTTP请求 THEN 系统 SHALL 使用标准HTTP方法
- WHEN 返回数据 THEN 系统 SHALL 使用JSON格式
- WHEN 错误发生 THEN 系统 SHALL 返回标准错误格式

#### IR-CM-002 CORS支持
**描述**: 系统支持跨域请求
**优先级**: 高
**验收标准**:
- WHEN 前端请求 THEN 系统 SHALL 返回CORS头
- WHEN 预检请求 THEN 系统 SHALL 处理OPTIONS方法
- WHEN 配置域名 THEN 系统 SHALL 验证请求来源

---

## 6. 数据需求

### 6.1 数据实体 (DR-EN)

#### DR-EN-001 短剧实体
**属性**:
- ID (主键, 自增)
- Title (标题, 必填, 最大200字符)
- Description (描述, 可选, 文本)
- Genre (类型, 可选, 50字符)
- Style (风格, 默认'realistic', 50字符)
- TotalEpisodes (总集数, 默认1)
- TotalDuration (总时长, 默认0)
- Status (状态, 默认'draft', 20字符)
- Thumbnail (缩略图, 可选, 500字符)
- Tags (标签, JSON格式)
- Metadata (元数据, JSON格式)
- CreatedAt (创建时间)
- UpdatedAt (更新时间)
- DeletedAt (软删除时间)

#### DR-EN-002 角色实体
**属性**:
- ID (主键, 自增)
- DramaID (短剧ID, 外键, 必填)
- Name (名称, 必填, 100字符)
- Role (角色, 可选, 50字符)
- Description (描述, 可选, 文本)
- Appearance (外貌, 可选, 文本)
- Personality (性格, 可选, 文本)
- VoiceStyle (声音风格, 可选, 200字符)
- ImageURL (图像URL, 可选, 500字符)
- LocalPath (本地路径, 可选, 文本)
- ReferenceImages (参考图, JSON数组)
- SeedValue (种子值, 可选, 100字符)
- SortOrder (排序, 默认0)
- CreatedAt (创建时间)
- UpdatedAt (更新时间)
- DeletedAt (软删除时间)

#### DR-EN-003 剧集实体
**属性**:
- ID (主键, 自增)
- DramaID (短剧ID, 外键, 必填)
- EpisodeNum (剧集编号, 必填)
- Title (标题, 必填, 200字符)
- ScriptContent (剧本内容, 可选, 长文本)
- Description (描述, 可选, 文本)
- Duration (时长, 默认0, 秒)
- Status (状态, 默认'draft', 20字符)
- VideoURL (视频URL, 可选, 500字符)
- Thumbnail (缩略图, 可选, 500字符)
- CreatedAt (创建时间)
- UpdatedAt (更新时间)
- DeletedAt (软删除时间)

#### DR-EN-004 场景实体
**属性**:
- ID (主键, 自增)
- DramaID (短剧ID, 外键, 必填)
- EpisodeID (剧集ID, 外键, 可选)
- Location (地点, 必填, 200字符)
- Time (时间, 必填, 100字符)
- Prompt (提示词, 必填, 文本)
- StoryboardCount (分镜数量, 默认1)
- ImageURL (图像URL, 可选, 500字符)
- LocalPath (本地路径, 可选, 文本)
- Status (状态, 默认'pending', 20字符)
- CreatedAt (创建时间)
- UpdatedAt (更新时间)
- DeletedAt (软删除时间)

#### DR-EN-005 分镜实体
**属性**:
- ID (主键, 自增)
- EpisodeID (剧集ID, 外键, 必填)
- SceneID (场景ID, 外键, 可选)
- StoryboardNumber (分镜编号, 必填)
- Title (标题, 可选, 255字符)
- Location (地点, 可选, 255字符)
- Time (时间, 可选, 255字符)
- ShotType (镜头类型, 可选, 100字符)
- Angle (角度, 可选, 100字符)
- Movement (运动, 可选, 100字符)
- Action (动作, 可选, 文本)
- Result (结果, 可选, 文本)
- Atmosphere (氛围, 可选, 文本)
- ImagePrompt (图像提示词, 可选, 文本)
- VideoPrompt (视频提示词, 可选, 文本)
- BgmPrompt (背景音乐提示词, 可选, 文本)
- SoundEffect (音效, 可选, 255字符)
- Dialogue (对话, 可选, 文本)
- Description (描述, 可选, 文本)
- Duration (时长, 默认5, 秒)
- ComposedImage (合成图像, 可选, 文本)
- VideoURL (视频URL, 可选, 文本)
- Status (状态, 默认'pending', 20字符)
- CreatedAt (创建时间)
- UpdatedAt (更新时间)
- DeletedAt (软删除时间)

#### DR-EN-006 道具实体
**属性**:
- ID (主键, 自增)
- DramaID (短剧ID, 外键, 必填)
- Name (名称, 必填, 100字符)
- Type (类型, 可选, 50字符)
- Description (描述, 可选, 文本)
- Prompt (提示词, 可选, 文本)
- ImageURL (图像URL, 可选, 500字符)
- LocalPath (本地路径, 可选, 文本)
- ReferenceImages (参考图, JSON数组)
- CreatedAt (创建时间)
- UpdatedAt (更新时间)
- DeletedAt (软删除时间)

#### DR-EN-007 图像生成记录
**属性**:
- ID (主键, 自增)
- StoryboardID (分镜ID, 外键, 可选)
- DramaID (短剧ID, 外键, 必填)
- SceneID (场景ID, 外键, 可选)
- CharacterID (角色ID, 外键, 可选)
- PropID (道具ID, 外键, 可选)
- ImageType (图像类型, 必填, 20字符)
- FrameType (帧类型, 可选, 20字符)
- Provider (提供商, 必填, 50字符)
- Prompt (提示词, 必填, 文本)
- NegPrompt (负面提示词, 可选, 文本)
- Model (模型, 可选, 100字符)
- Size (尺寸, 可选, 20字符)
- Quality (质量, 可选, 20字符)
- Style (风格, 可选, 50字符)
- Steps (步数, 可选)
- CfgScale (CFG比例, 可选)
- Seed (种子, 可选)
- ImageURL (图像URL, 可选, 文本)
- MinioURL (MinIO URL, 可选, 文本)
- LocalPath (本地路径, 可选, 文本)
- Status (状态, 默认'pending', 20字符)
- TaskID (任务ID, 可选, 200字符)
- ErrorMsg (错误信息, 可选, 文本)
- Width (宽度, 可选)
- Height (高度, 可选)
- ReferenceImages (参考图, JSON)
- CreatedAt (创建时间)
- UpdatedAt (更新时间)
- CompletedAt (完成时间, 可选)

#### DR-EN-008 视频生成记录
**属性**:
- ID (主键, 自增)
- StoryboardID (分镜ID, 外键, 可选)
- DramaID (短剧ID, 外键, 必填)
- Provider (提供商, 必填, 50字符)
- Prompt (提示词, 必填, 文本)
- Model (模型, 可选, 100字符)
- ImageGenID (关联图像ID, 外键, 可选)
- ReferenceMode (参考模式, 可选, 20字符)
- ImageURL (图像URL, 可选, 1000字符)
- FirstFrameURL (首帧URL, 可选, 1000字符)
- LastFrameURL (尾帧URL, 可选, 1000字符)
- ReferenceImageURLs (参考图URL, 可选, 文本)
- Duration (时长, 可选)
- FPS (帧率, 可选)
- Resolution (分辨率, 可选, 50字符)
- AspectRatio (宽高比, 可选, 20字符)
- Style (风格, 可选, 100字符)
- MotionLevel (运动级别, 可选)
- CameraMotion (相机运动, 可选, 100字符)
- Seed (种子, 可选)
- VideoURL (视频URL, 可选, 1000字符)
- MinioURL (MinIO URL, 可选, 1000字符)
- LocalPath (本地路径, 可选, 500字符)
- Status (状态, 默认'pending', 20字符)
- TaskID (任务ID, 可选, 200字符)
- ErrorMsg (错误信息, 可选, 文本)
- Width (宽度, 可选)
- Height (高度, 可选)
- CompletedAt (完成时间, 可选)
- CreatedAt (创建时间)
- UpdatedAt (更新时间)
- DeletedAt (软删除时间)

#### DR-EN-009 AI服务配置
**属性**:
- ID (主键, 自增)
- ServiceType (服务类型, 必填, 50字符)
- Provider (提供商, 可选, 50字符)
- Name (名称, 必填, 100字符)
- BaseURL (基础URL, 必填, 255字符)
- APIKey (API密钥, 必填, 255字符)
- Model (模型, 文本, 支持字符串或数组)
- Endpoint (端点, 可选, 255字符)
- QueryEndpoint (查询端点, 可选, 255字符)
- Priority (优先级, 默认0)
- IsDefault (是否默认, 默认false)
- IsActive (是否激活, 默认true)
- Settings (设置, 可选, 文本)
- CreatedAt (创建时间)
- UpdatedAt (更新时间)

#### DR-EN-010 资产实体
**属性**:
- ID (主键, 自增)
- DramaID (短剧ID, 外键, 可选)
- EpisodeID (剧集ID, 外键, 可选)
- StoryboardID (分镜ID, 外键, 可选)
- StoryboardNum (分镜编号, 可选)
- Name (名称, 必填, 200字符)
- Description (描述, 可选, 文本)
- Type (类型, 必填, 20字符)
- Category (分类, 可选, 50字符)
- URL (URL, 必填, 1000字符)
- ThumbnailURL (缩略图URL, 可选, 1000字符)
- LocalPath (本地路径, 可选, 500字符)
- FileSize (文件大小, 可选)
- MimeType (MIME类型, 可选, 100字符)
- Width (宽度, 可选)
- Height (高度, 可选)
- Duration (时长, 可选)
- Format (格式, 可选, 50字符)
- ImageGenID (图像生成ID, 外键, 可选)
- VideoGenID (视频生成ID, 外键, 可选)
- IsFavorite (是否收藏, 默认false)
- ViewCount (浏览次数, 默认0)
- CreatedAt (创建时间)
- UpdatedAt (更新时间)
- DeletedAt (软删除时间)

#### DR-EN-011 异步任务
**属性**:
- ID (主键, 36字符UUID)
- Type (类型, 必填, 50字符)
- Status (状态, 必填, 20字符)
- Progress (进度, 默认0, 0-100)
- Message (消息, 可选, 500字符)
- Error (错误信息, 可选, 文本)
- Result (结果, 可选, 文本, JSON格式)
- ResourceID (资源ID, 可选, 36字符)
- CreatedAt (创建时间)
- UpdatedAt (更新时间)
- CompletedAt (完成时间, 可选)
- DeletedAt (软删除时间)

#### DR-EN-012 角色库
**属性**:
- ID (主键, 自增)
- Name (名称, 必填, 100字符)
- Category (分类, 可选, 50字符)
- ImageURL (图像URL, 必填, 500字符)
- LocalPath (本地路径, 可选, 500字符)
- Description (描述, 可选, 文本)
- Tags (标签, 可选, 500字符)
- SourceType (来源类型, 默认'generated', 20字符)
- CreatedAt (创建时间)
- UpdatedAt (更新时间)
- DeletedAt (软删除时间)

#### DR-EN-013 帧提示词
**属性**:
- ID (主键, 自增)
- StoryboardID (分镜ID, 外键, 必填)
- FrameType (帧类型, 必填, 20字符)
- Prompt (提示词, 必填, 文本)
- Description (描述, 可选, 文本)
- Layout (布局, 可选, 50字符)
- CreatedAt (创建时间)
- UpdatedAt (更新时间)

### 6.2 实体关系

```
Drama (1) -- (N) Episode
Drama (1) -- (N) Character
Drama (1) -- (N) Scene
Drama (1) -- (N) Prop
Episode (1) -- (N) Storyboard
Episode (N) -- (N) Character (多对多)
Episode (1) -- (N) Scene
Scene (1) -- (N) Storyboard
Storyboard (N) -- (N) Character (多对多)
Storyboard (N) -- (N) Prop (多对多)
Storyboard (1) -- (N) FramePrompt
Storyboard (1) -- (N) ImageGeneration
Storyboard (1) -- (N) VideoGeneration
Character (1) -- (N) ImageGeneration
Scene (1) -- (N) ImageGeneration
Prop (1) -- (N) ImageGeneration
ImageGeneration (1) -- (N) Asset
VideoGeneration (1) -- (N) Asset
```

### 6.3 数据存储需求

| 数据类型 | 存储位置 | 备份策略 | 保留策略 |
|---------|---------|---------|---------|
| 结构化数据 | SQLite/MySQL | 每日备份 | 永久保留 |
| 生成的图像 | 本地/MinIO | 每周备份 | 按需删除 |
| 生成的视频 | 本地/MinIO | 每周备份 | 按需删除 |
| 上传的文件 | 本地/MinIO | 每周备份 | 永久保留 |
| 系统日志 | 本地文件 | 每月归档 | 保留30天 |

### 6.4 数据流需求

#### 6.4.1 剧本到分镜数据流
1. 用户上传剧本 → 存储到Episode.ScriptContent
2. AI服务解析 → 生成Storyboard记录
3. 分镜关联Scene → 创建或更新Scene记录
4. 分镜关联Character → 建立多对多关系

#### 6.4.2 图像生成数据流
1. 用户请求生成 → 创建ImageGeneration记录(状态:pending)
2. 调用AI服务 → 更新状态为processing
3. AI返回图像 → 下载到本地/上传到MinIO
4. 存储文件路径 → 更新ImageGeneration(状态:completed)
5. 创建Asset记录 → 关联ImageGeneration

#### 6.4.3 视频合成数据流
1. 用户请求合成 → 查询所有分镜的视频
2. FFmpeg合并 → 生成最终视频文件
3. 存储视频文件 → 更新Episode.VideoURL
4. 创建Asset记录 → 关联Episode

---

## 7. 验收标准汇总

### 7.1 功能验收标准

| 需求ID | 验收标准 | 测试方法 |
|-------|---------|---------|
| FR-DM-001 | 项目CRUD功能正常 | 单元测试 + 集成测试 |
| FR-CM-002 | AI角色图像生成成功 | 手动测试 + AI服务Mock |
| FR-SB-001 | 剧本解析正确 | 样本剧本测试 |
| FR-IG-001 | 图像任务状态流转正确 | 状态机测试 |
| FR-VG-001 | 视频生成参数传递正确 | API契约测试 |
| FR-VM-001 | 视频合成输出正确 | FFmpeg集成测试 |

### 7.2 非功能验收标准

| 需求ID | 验收标准 | 测试方法 |
|-------|---------|---------|
| NFR-PF-001 | API响应时间<2s | 性能测试 |
| NFR-AV-001 | 可用率>99.5% | 监控统计 |
| NFR-SE-001 | API密钥加密存储 | 安全审计 |
| NFR-MT-001 | 日志完整记录 | 日志审查 |

---

## 8. 附录

### 8.1 术语表

| 术语 | 定义 |
|-----|------|
| 短剧 | 指短剧项目，包含多个剧集的完整作品 |
| 剧集 | 短剧的分集，对应一个剧本文件 |
| 分镜 | 剧本的场景分解，包含拍摄角度、动作等详细信息 |
| 场景 | 拍摄的地点和时间环境 |
| 资产 | 生成的图像、视频等媒体资源 |
| 提示词 | 用于AI生成的文本描述（Prompt） |

### 8.2 缩略语

| 缩略语 | 全称 |
|-------|------|
| API | Application Programming Interface |
| CRUD | Create, Read, Update, Delete |
| CORS | Cross-Origin Resource Sharing |
| EARS | Easy Approach to Requirements Syntax |
| FFmpeg | Fast Forward Moving Picture Experts Group |
| FPS | Frames Per Second |
| JSON | JavaScript Object Notation |
| ORM | Object-Relational Mapping |
| RPO | Recovery Point Objective |
| RTO | Recovery Time Objective |
| SRS | Software Requirements Specification |
| REST | Representational State Transfer |
| UUID | Universally Unique Identifier |

### 8.3 参考资料

1. IEEE Std 830-1998 - IEEE Recommended Practice for Software Requirements Specifications
2. Go 1.23 Documentation - https://golang.org/doc/
3. Vue 3 Documentation - https://vuejs.org/guide/
4. Gin Framework Documentation - https://gin-gonic.com/docs/
5. FFmpeg Documentation - https://ffmpeg.org/documentation.html

---

**文档结束**
