# 04-组件架构

## C4 Model - Level 3: Component Diagram

组件图展示 API Server 容器的内部结构，遵循 DDD 分层架构。

---

## 组件架构图

```mermaid
C4Component
    title Component Architecture - API Server (DDD Layers)
    
    Container(spa, "Single Page Application", "Vue 3", "Web UI")
    
    Container_Boundary(api, "API Server - DDD Architecture") {
        
        Component_Boundary(presentation, "API Layer (Presentation)") {
            Component(router, "Router", "Gin Router", "Route definitions and middleware chain")
            Component(middleware, "Middlewares", "Go", "CORS, logging, rate limiting, recovery")
            Component(handlers, "HTTP Handlers", "18 Handlers", "Request/response handling")
        }
        
        Component_Boundary(application, "Application Layer") {
            Component(services, "Application Services", "22 Services", "Use cases and orchestration")
            Component(dtos, "DTOs", "Go Structs", "Data transfer objects")
            Component(workflows, "Workflow Engines", "Go", "Drama generation workflows")
        }
        
        Component_Boundary(domain, "Domain Layer") {
            Component(models, "Domain Models", "9 Entities", "Business entities and rules")
            Component(repos, "Repository Interfaces", "Go Interfaces", "Data access abstractions")
        }
        
        Component_Boundary(infrastructure, "Infrastructure Layer") {
            Component(db_infra, "Database", "GORM + SQLite", "Data persistence")
            Component(storage_infra, "Storage", "Local Storage", "File operations")
            Component(ai_clients, "AI Clients", "HTTP Clients", "OpenAI, Doubao integrations")
            Component(ffmpeg_infra, "FFmpeg Wrapper", "Go", "Video processing")
        }
    }
    
    System_Ext(ai_external, "External AI Services", "OpenAI/Doubao")
    
    Rel(spa, router, "Sends requests to", "HTTPS/JSON")
    Rel(router, middleware, "Uses")
    Rel(router, handlers, "Routes to")
    Rel(handlers, services, "Calls")
    Rel(services, models, "Uses")
    Rel(services, db_infra, "Persists via")
    Rel(services, storage_infra, "Stores files via")
    Rel(services, ai_clients, "Generates via")
    Rel(ai_clients, ai_external, "Calls", "HTTPS")
    Rel(services, ffmpeg_infra, "Processes video via")
    
    UpdateLayoutConfig($c4ShapeInRow="3", $c4BoundaryInRow="1")
```

---

## DDD 分层职责

### API Layer（表现层）

**职责：**
- 处理 HTTP 请求和响应
- 输入验证和格式化
- 路由分发
- 横切关注点（CORS、日志、限流）

**主要组件：**

| 组件 | 文件位置 | 说明 |
|------|---------|------|
| **Router** | `api/routes/routes.go` | 定义所有 HTTP 路由及其处理器 |
| **Middlewares** | `api/middlewares/` | 跨域、日志、限流、恢复 |
| **Handlers** | `api/handlers/` | 18个 HTTP 处理器，处理请求/响应 |

**Handler 列表：**
- Drama handlers - 短剧管理
- Character handlers - 角色管理
- Storyboard handlers - 分镜管理
- Generation handlers - AI 生成
- Asset handlers - 资源管理
- Task handlers - 任务管理

---

### Application Layer（应用层）

**职责：**
- 实现业务用例
- 编排领域对象操作
- 协调外部服务调用
- 事务管理
- 工作流引擎

**主要组件：**

| 组件 | 数量 | 说明 |
|------|------|------|
| **Application Services** | 22个 | 实现业务用例，编排领域操作 |
| **DTOs** | 多个 | 定义请求/响应数据结构 |
| **Workflow Engines** | 多个 | 长流程的短剧生成工作流 |

**Service 分类：**

1. **核心短剧服务**
   - DramaService - 短剧CRUD管理

2. **内容生成服务**
   - ScriptGenerationService - AI剧本生成
   - ImageGenerationService - AI图像生成
   - VideoGenerationService - AI视频生成
   - StoryboardService - 分镜创建
   - StoryboardCompositionService - 分镜图像合成

3. **角色与资源服务**
   - CharacterLibraryService - 角色库管理
   - PropService - 道具管理
   - AssetService - 资源库管理
   - FramePromptService - 帧提示词生成

4. **任务与处理服务**
   - TaskService - 异步任务管理
   - VideoMergeService - 视频合并
   - AudioExtractionService - 音频处理
   - ResourceTransferService - 资源URL处理
   - UploadService - 文件上传处理

5. **配置与工具服务**
   - AIService - AI提供商管理
   - DataMigrationService - 数据迁移
   - SettingsService - 系统设置

---

### Domain Layer（领域层）

**职责：**
- 核心业务实体定义
- 业务规则和验证
- 领域逻辑封装
- Repository 接口定义

**主要组件：**

| 组件 | 数量 | 说明 |
|------|------|------|
| **Domain Models** | 9个实体 | 核心业务实体 |
| **Repository Interfaces** | 多个 | 数据访问抽象接口 |

**领域实体：**

| 实体 | 职责 | 关键属性 |
|------|------|---------|
| **Drama** | 短剧项目（聚合根） | ID, Title, Status, TotalEpisodes |
| **Episode** | 剧集 | ID, DramaID, EpisodeNum, ScriptContent |
| **Character** | 角色定义 | ID, DramaID, Name, Description, ImageURL |
| **Scene** | 场景/背景 | ID, DramaID, Location, Time, ImageURL |
| **Storyboard** | 分镜 | ID, EpisodeID, ShotNum, Description |
| **Prop** | 道具 | ID, DramaID, Name, Description |
| **ImageGeneration** | 图像生成任务 | ID, Status, Prompt, ResultURL |
| **VideoGeneration** | 视频生成任务 | ID, Status, SourceImage, ResultURL |
| **AIConfig** | AI服务配置 | ID, Provider, APIKey, Model |

---

### Infrastructure Layer（基础设施层）

**职责：**
- 数据持久化实现
- 外部服务调用
- 文件系统操作
- 媒体处理

**主要组件：**

| 组件 | 技术 | 说明 |
|------|------|------|
| **Database** | GORM + SQLite | 数据持久化实现 |
| **Storage** | Local Storage | 本地文件操作 |
| **AI Clients** | HTTP Clients | OpenAI、豆包等AI服务集成 |
| **FFmpeg Wrapper** | Go + CLI | 视频处理封装 |

**文件位置：**
- Database: `infrastructure/database/`
- Storage: `infrastructure/storage/`
- AI Clients: `application/services/ai_service.go`
- FFmpeg: `infrastructure/external/ffmpeg/`

---

## 依赖关系

### 依赖规则（依赖倒置原则）

```
API Layer → Application Layer → Domain Layer ← Infrastructure Layer
```

- **Domain Layer**：无外部依赖，纯业务逻辑
- **Application Layer**：只依赖 Domain Layer
- **API Layer**：依赖 Application Layer
- **Infrastructure Layer**：实现 Domain 定义的接口

### 组件间依赖

| 依赖方向 | 说明 |
|---------|------|
| Router → Middleware | 使用中间件链 |
| Router → Handlers | 路由分发到处理器 |
| Handlers → Services | 调用应用服务 |
| Services → Models | 使用领域实体 |
| Services → Repository Interfaces | 通过接口调用数据访问 |
| Services → Infrastructure | 调用具体实现 |

---

## 代码示例

### 依赖注入模式

```go
// Application Service 示例
type ImageGenerationService struct {
    db          *gorm.DB
    cfg         *config.Config
    transferSvc *ResourceTransferService
    storage     *storage.LocalStorage
    log         *logger.Logger
    aiService   *AIService
}

func NewImageGenerationService(
    db *gorm.DB,
    cfg *config.Config,
    transferSvc *ResourceTransferService,
    storage *storage.LocalStorage,
    log *logger.Logger,
) *ImageGenerationService {
    return &ImageGenerationService{
        db:          db,
        cfg:         cfg,
        transferSvc: transferSvc,
        storage:     storage,
        log:         log,
    }
}
```

### Repository 模式

```go
// Domain Layer - 定义接口
type DramaRepository interface {
    FindByID(id uint) (*Drama, error)
    Save(drama *Drama) error
    Delete(id uint) error
}

// Infrastructure Layer - 实现接口
type dramaRepository struct {
    db *gorm.DB
}

func (r *dramaRepository) FindByID(id uint) (*Drama, error) {
    var drama Drama
    result := r.db.First(&drama, id)
    return &drama, result.Error
}
```

---

## 架构模式

### 1. Domain-Driven Design (DDD)

严格遵循 DDD 分层：
- 领域层包含核心业务逻辑
- 应用层编排用例
- 基础设施层提供技术能力

### 2. Repository Pattern

数据访问抽象：
- Domain 定义 Repository 接口
- Infrastructure 提供具体实现
- Application 使用接口，不依赖实现

### 3. Dependency Injection

依赖注入：
- 通过构造函数注入依赖
- 便于单元测试
- 降低组件耦合

### 4. Middleware Chain

Gin 中间件链：
- CORS 处理
- 请求日志记录
- 限流控制
- 错误恢复

---

## 下一步

了解详细实现，请查看：
- [06-详细设计/API层](06-详细设计/API层.md) - 18个 Handler 详细说明
- [06-详细设计/应用层](06-详细设计/应用层.md) - 22个 Service 详细说明
- [06-详细设计/领域层](06-详细设计/领域层.md) - 9个领域模型详细说明
- [06-详细设计/基础设施层](06-详细设计/基础设施层.md) - 数据库、存储、FFmpeg详细说明

---

*注：本文档基于 C4 Model（https://c4model.com/）Level 3 标准绘制*
