# 04-é¡¹ç›®ç»“æ„å›¾

## DDD åˆ†å±‚æ¶æ„

```
huobao-drama/
â”‚
â”œâ”€â”€ ğŸ“ api/                    # API å±‚ - HTTP æ¥å£
â”‚   â”œâ”€â”€ handlers/             # è¯·æ±‚å¤„ç†å™¨ (Controllers)
â”‚   â”œâ”€â”€ middlewares/          # ä¸­é—´ä»¶ (CORS/æ—¥å¿—/é™æµ)
â”‚   â””â”€â”€ routes/               # è·¯ç”±é…ç½®
â”‚
â”œâ”€â”€ ğŸ“ application/           # åº”ç”¨å±‚ - ä¸šåŠ¡é€»è¾‘
â”‚   â””â”€â”€ services/             # åº”ç”¨æœåŠ¡
â”‚
â”œâ”€â”€ ğŸ“ domain/                # é¢†åŸŸå±‚ - é¢†åŸŸæ¨¡å‹
â”‚   â””â”€â”€ models/               # å®ä½“/å€¼å¯¹è±¡
â”‚
â”œâ”€â”€ ğŸ“ infrastructure/        # åŸºç¡€è®¾æ–½å±‚
â”‚   â”œâ”€â”€ database/            # æ•°æ®åº“è¿æ¥
â”‚   â”œâ”€â”€ storage/             # æ–‡ä»¶å­˜å‚¨
â”‚   â”œâ”€â”€ scheduler/           # å®šæ—¶ä»»åŠ¡
â”‚   â””â”€â”€ external/            # å¤–éƒ¨æœåŠ¡ (FFmpeg)
â”‚
â”œâ”€â”€ ğŸ“ pkg/                   # å…¬å…±åŒ…
â”‚   â”œâ”€â”€ ai/                  # AI å®¢æˆ·ç«¯
â”‚   â”œâ”€â”€ image/               # å›¾åƒå¤„ç†
â”‚   â”œâ”€â”€ video/               # è§†é¢‘å¤„ç†
â”‚   â”œâ”€â”€ config/              # é…ç½®ç®¡ç†
â”‚   â”œâ”€â”€ logger/              # æ—¥å¿—
â”‚   â””â”€â”€ utils/               # å·¥å…·å‡½æ•°
â”‚
â””â”€â”€ ğŸ“ web/                  # å‰ç«¯åº”ç”¨
    â”œâ”€â”€ src/
    â”‚   â”œâ”€â”€ views/           # é¡µé¢è§†å›¾
    â”‚   â”œâ”€â”€ components/      # ç»„ä»¶
    â”‚   â”œâ”€â”€ router/          # è·¯ç”±
    â”‚   â”œâ”€â”€ stores/          # Pinia çŠ¶æ€
    â”‚   â”œâ”€â”€ api/             # API å®¢æˆ·ç«¯
    â”‚   â””â”€â”€ utils/           # å·¥å…·å‡½æ•°
    â””â”€â”€ vite.config.ts       # Vite é…ç½®
```

---

## åç«¯ç›®å½•è¯¦è§£

### api/ - API å±‚
```
api/
â”œâ”€â”€ handlers/               # 18ä¸ª HTTP å¤„ç†å™¨
â”‚   â”œâ”€â”€ drama.go          # çŸ­å‰§ç®¡ç†
â”‚   â”œâ”€â”€ character_library.go  # è§’è‰²åº“
â”‚   â”œâ”€â”€ storyboard.go     # åˆ†é•œç®¡ç†
â”‚   â”œâ”€â”€ image_generation.go  # å›¾åƒç”Ÿæˆ
â”‚   â”œâ”€â”€ video_generation.go  # è§†é¢‘ç”Ÿæˆ
â”‚   â””â”€â”€ ...               # å…¶ä»–å¤„ç†å™¨
â”‚
â”œâ”€â”€ middlewares/
â”‚   â”œâ”€â”€ cors.go           # è·¨åŸŸå¤„ç†
â”‚   â”œâ”€â”€ logger.go         # è¯·æ±‚æ—¥å¿—
â”‚   â””â”€â”€ ratelimit.go      # é™æµæ§åˆ¶
â”‚
â””â”€â”€ routes/
    â””â”€â”€ routes.go         # è·¯ç”±æ³¨å†Œä¸­å¿ƒ
```

**èŒè´£ï¼š**
- æ¥æ”¶ HTTP è¯·æ±‚
- è¾“å…¥éªŒè¯
- è°ƒç”¨åº”ç”¨æœåŠ¡
- è¿”å› HTTP å“åº”

---

### application/ - åº”ç”¨å±‚
```
application/
â””â”€â”€ services/             # 22ä¸ªåº”ç”¨æœåŠ¡
    â”œâ”€â”€ drama_service.go
    â”œâ”€â”€ image_generation_service.go
    â”œâ”€â”€ video_generation_service.go
    â”œâ”€â”€ storyboard_service.go
    â”œâ”€â”€ ai_service.go
    â””â”€â”€ ...
```

**èŒè´£ï¼š**
- å®ç°ä¸šåŠ¡ç”¨ä¾‹
- ç¼–æ’é¢†åŸŸå¯¹è±¡
- åè°ƒå¤–éƒ¨æœåŠ¡
- äº‹åŠ¡ç®¡ç†

---

### domain/ - é¢†åŸŸå±‚
```
domain/
â””â”€â”€ models/               # 9ä¸ªé¢†åŸŸæ¨¡å‹
    â”œâ”€â”€ drama.go          # Drama/Character/Episode/Scene/Storyboard/Prop
    â”œâ”€â”€ image_generation.go
    â”œâ”€â”€ video_generation.go
    â””â”€â”€ ...
```

**æ ¸å¿ƒå®ä½“ï¼š**
| å®ä½“ | è¯´æ˜ |
|------|------|
| **Drama** | çŸ­å‰§é¡¹ç›®ï¼Œèšåˆæ ¹ |
| **Episode** | å‰§é›†ï¼ŒåŒ…å«å‰§æœ¬å†…å®¹ |
| **Character** | è§’è‰²å®šä¹‰ |
| **Scene** | åœºæ™¯/èƒŒæ™¯ |
| **Storyboard** | åˆ†é•œ |
| **Prop** | é“å…· |

---

### infrastructure/ - åŸºç¡€è®¾æ–½å±‚
```
infrastructure/
â”œâ”€â”€ database/
â”‚   â”œâ”€â”€ database.go       # GORM è¿æ¥
â”‚   â””â”€â”€ custom_logger.go  # è‡ªå®šä¹‰æ—¥å¿—
â”‚
â”œâ”€â”€ storage/
â”‚   â””â”€â”€ local_storage.go  # æœ¬åœ°æ–‡ä»¶å­˜å‚¨
â”‚
â”œâ”€â”€ scheduler/
â”‚   â””â”€â”€ resource_transfer_scheduler.go  # èµ„æºè½¬ç§»å®šæ—¶ä»»åŠ¡
â”‚
â””â”€â”€ external/ffmpeg/
    â””â”€â”€ ffmpeg.go         # FFmpeg è§†é¢‘å¤„ç†
```

**èŒè´£ï¼š**
- æ•°æ®æŒä¹…åŒ–
- å¤–éƒ¨æœåŠ¡è°ƒç”¨
- æ–‡ä»¶å­˜å‚¨
- åª’ä½“å¤„ç†

---

## å‰ç«¯ç›®å½•è¯¦è§£

```
web/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ views/              # é¡µé¢è§†å›¾
â”‚   â”‚   â”œâ”€â”€ drama/          # çŸ­å‰§ç®¡ç†é¡µé¢
â”‚   â”‚   â”œâ”€â”€ workflow/       # å·¥ä½œæµé¡µé¢
â”‚   â”‚   â”œâ”€â”€ generation/     # ç”Ÿæˆé¡µé¢
â”‚   â”‚   â”œâ”€â”€ storyboard/     # åˆ†é•œé¡µé¢
â”‚   â”‚   â””â”€â”€ editor/         # ç¼–è¾‘å™¨é¡µé¢
â”‚   â”‚
â”‚   â”œâ”€â”€ components/          # ç»„ä»¶
â”‚   â”‚   â”œâ”€â”€ common/         # é€šç”¨ç»„ä»¶
â”‚   â”‚   â””â”€â”€ drama/          # ä¸šåŠ¡ç»„ä»¶
â”‚   â”‚
â”‚   â”œâ”€â”€ router/              # è·¯ç”±é…ç½®
â”‚   â”‚   â””â”€â”€ index.ts
â”‚   â”‚
â”‚   â”œâ”€â”€ stores/              # Pinia çŠ¶æ€ç®¡ç†
â”‚   â”‚   â”œâ”€â”€ drama.ts
â”‚   â”‚   â””â”€â”€ user.ts
â”‚   â”‚
â”‚   â”œâ”€â”€ api/                 # API å®¢æˆ·ç«¯
â”‚   â”‚   â”œâ”€â”€ drama.ts
â”‚   â”‚   â””â”€â”€ request.ts
â”‚   â”‚
â”‚   â””â”€â”€ utils/               # å·¥å…·å‡½æ•°
â”‚       â””â”€â”€ helpers.ts
â”‚
â”œâ”€â”€ package.json
â””â”€â”€ vite.config.ts
```

---

## ä¾èµ–å…³ç³»

```mermaid
graph TB
    subgraph "API å±‚"
        A[Handlers]
        M[Middlewares]
    end

    subgraph "åº”ç”¨å±‚"
        S[Services]
    end

    subgraph "é¢†åŸŸå±‚"
        D[Domain Models]
    end

    subgraph "åŸºç¡€è®¾æ–½å±‚"
        I1[Database]
        I2[Storage]
        I3[AI APIs]
        I4[FFmpeg]
    end

    A --> S
    S --> D
    S --> I1
    S --> I2
    S --> I3
    S --> I4
```

**ä¾èµ–è§„åˆ™ï¼š**
- ä¸Šå±‚ä¾èµ–ä¸‹å±‚
- ä¸‹å±‚ä¸ä¾èµ–ä¸Šå±‚
- é¢†åŸŸå±‚ä¸ä¾èµ–ä»»ä½•æ¡†æ¶

---

## å…³é”®ç›®å½•è¯´æ˜

| ç›®å½• | ç”¨é€” | æ–‡ä»¶æ•°é‡ |
|------|------|---------|
| `api/handlers/` | HTTP å¤„ç†å™¨ | 18ä¸ª |
| `application/services/` | ä¸šåŠ¡æœåŠ¡ | 22ä¸ª |
| `domain/models/` | é¢†åŸŸæ¨¡å‹ | 9ä¸ª |
| `web/src/views/` | å‰ç«¯é¡µé¢ | 15+ä¸ª |
| `web/src/components/` | å‰ç«¯ç»„ä»¶ | 40+ä¸ª |

---

## å…¥å£æ–‡ä»¶

### åç«¯å…¥å£
**æ–‡ä»¶ï¼š** `main.go`

```go
func main() {
    // 1. åŠ è½½é…ç½®
    cfg := config.LoadConfig()
    
    // 2. åˆå§‹åŒ–æ—¥å¿—
    logr := logger.NewLogger(cfg.App.Debug)
    
    // 3. è¿æ¥æ•°æ®åº“
    db := database.NewDatabase(cfg.Database)
    
    // 4. è‡ªåŠ¨è¿ç§»è¡¨ç»“æ„
    database.AutoMigrate(db)
    
    // 5. åˆå§‹åŒ–å­˜å‚¨
    storage := storage.NewLocalStorage(...)
    
    // 6. è®¾ç½® Gin è·¯ç”±
    router := routes.SetupRouter(cfg, db, logr, storage)
    
    // 7. å¯åŠ¨ HTTP æœåŠ¡å™¨
    srv.ListenAndServe()
}
```

### å‰ç«¯å…¥å£
**æ–‡ä»¶ï¼š** `web/src/main.ts`

```typescript
import { createApp } from 'vue'
import App from './App.vue'
import router from './router'
import { createPinia } from 'pinia'

const app = createApp(App)
app.use(createPinia())
app.use(router)
app.mount('#app')
```

---

## é…ç½®æ–‡ä»¶

### åç«¯é…ç½®
**è·¯å¾„ï¼š** `configs/config.yaml`

ä¸»è¦é…ç½®ï¼š
- åº”ç”¨åŸºæœ¬ä¿¡æ¯
- æœåŠ¡å™¨ç«¯å£å’ŒCORS
- æ•°æ®åº“è¿æ¥
- å­˜å‚¨è·¯å¾„
- AIæœåŠ¡æä¾›å•†

### å‰ç«¯é…ç½®
**è·¯å¾„ï¼š** `web/vite.config.ts`

ä¸»è¦é…ç½®ï¼š
- å¼€å‘æœåŠ¡å™¨ä»£ç†
- æ„å»ºè®¾ç½®
- æ’ä»¶é…ç½®

---

## å¼€å‘å‘½ä»¤

### åç«¯
```bash
go run main.go              # å¼€å‘æ¨¡å¼è¿è¡Œ
go build -o huobao-drama . # ç¼–è¯‘äºŒè¿›åˆ¶
go test ./...               # è¿è¡Œæµ‹è¯•
```

### å‰ç«¯
```bash
cd web
pnpm install               # å®‰è£…ä¾èµ–
pnpm dev                   # å¼€å‘æ¨¡å¼
pnpm build                 # ç”Ÿäº§æ„å»º
pnpm lint                  # ä»£ç æ£€æŸ¥
```

---

*è¯¦è§ï¼š*
- [API å±‚è¯¦ç»†è®¾è®¡](../02-æ¶æ„è®¾è®¡/06-è¯¦ç»†è®¾è®¡/APIå±‚.md)
- [åº”ç”¨å±‚è¯¦ç»†è®¾è®¡](../02-æ¶æ„è®¾è®¡/06-è¯¦ç»†è®¾è®¡/åº”ç”¨å±‚.md)
- [é¢†åŸŸå±‚è¯¦ç»†è®¾è®¡](../02-æ¶æ„è®¾è®¡/06-è¯¦ç»†è®¾è®¡/é¢†åŸŸå±‚.md)
- [åŸºç¡€è®¾æ–½å±‚è¯¦ç»†è®¾è®¡](../02-æ¶æ„è®¾è®¡/06-è¯¦ç»†è®¾è®¡/åŸºç¡€è®¾æ–½å±‚.md)
